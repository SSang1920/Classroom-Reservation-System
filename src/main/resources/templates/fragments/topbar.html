<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="topbar" class="top-bar bg-white border-bottom shadow-sm">
    <!-- ì™¼ìª½: í™ˆìœ¼ë¡œ ê°€ëŠ” ë§í¬ -->
    <div>
        <a href="/" class="navbar-brand">
            <strong>ğŸ“ ê°•ì˜ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ</strong>
        </a>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì‚¬ìš©ì ê´€ë ¨ ë²„íŠ¼ë“¤ì„ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ -->
    <div class="d-flex align-items-center">
        <!-- ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ ë³´ì—¬ì¤„ ë·° -->
        <div id="logged-out-view">
            <a href="/login" class="btn btn-primary">ë¡œê·¸ì¸</a>
            <a href="/signup" class="btn btn-secondary ms-2">íšŒì›ê°€ì…</a>
        </div>

        <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ë³´ì—¬ì¤„ ë·° -->
        <div id="logged-in-view" class="d-flex align-items-center d-none">
            <span class="me-3">í™˜ì˜í•©ë‹ˆë‹¤, <strong id="username-display"></strong>ë‹˜!</span>
            <a id="admin-page-btn" href="/admin/main" class="btn btn-warning btn-sm me-2 d-none">ê´€ë¦¬ì í˜ì´ì§€</a>
            <button id="logout-button" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>

            <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ UI -->
            <div class="notification dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm position-relative" type="button" id="notification-dropdown-btn" data-bs-toggle="dropdown" aria-expanded="false">
                    ğŸ””
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notification-count-badge">
                        0
                    </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notification-dropdown-btn" id="notification-list" style="width: 350px; max-height: 400px; overflow-y: auto;">
                    <li><p class="dropdown-item text-center text-muted mb-0">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p></li>
                </ul>
            </div>
        </div>
    </div>
</div>


<script th:fragment="topbar-script">
    // ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ë¥¼ ì¶”ì í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
    let unreadCount = 0;

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('accessToken');
        const loggedOutView = document.getElementById('logged-out-view');
        const loggedInView = document.getElementById('logged-in-view');

        if (token) {
            // UI ìƒíƒœ ë³€ê²½
            loggedOutView.classList.add('d-none');
            loggedInView.classList.remove('d-none');

            try {
                const payload = parseJwt(token);
                document.getElementById('username-display').textContent = payload.name || 'ì‚¬ìš©ì';
                if (payload.role === 'ROLE_ADMIN') {
                    document.getElementById('admin-page-btn').classList.remove('d-none');
                }
            } catch (e) {
                console.error("í† í° íŒŒì‹± ì˜¤ë¥˜:", e);
                logout();
                return;
            }

            // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì•Œë¦¼ ê¸°ëŠ¥ ìë™ ì‹¤í–‰
            initializeNotifications();
            connectSSE();

        } else {
            loggedOutView.classList.remove('d-none');
            loggedInView.classList.add('d-none');
        }

        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
    });

    // 1. (í˜ì´ì§€ ë¡œë“œ ì‹œ) ê¸°ì¡´ ì•Œë¦¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function initializeNotifications() {
        try {
            const response = await fetch('/api/notifications', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
            });
            if (!response.ok) throw new Error('ì•Œë¦¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');

            const result = await response.json();
            updateNotificationUI(result.data);

            // ì´ˆê¸° ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ë¥¼ ê³„ì‚°í•˜ê³  ë°°ì§€ ì—…ë°ì´íŠ¸
            unreadCount = result.data.filter(n => !n.isRead).length;
            updateUnreadCountBadge();

        } catch (error) {
            console.error("ì•Œë¦¼ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
        }
    }

    // 2. (í˜ì´ì§€ ë¡œë“œ ì‹œ) ì‹¤ì‹œê°„ ì•Œë¦¼(SSE) ì—°ê²°ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
    function connectSSE() {
        const token = localStorage.getItem('accessToken');
        if (!token) return;

        const eventSource = new EventSource(`/api/notifications/subscribe?token=${token}`);

        eventSource.addEventListener("notification", function(event) {
            // [ìˆ˜ì •] ì„œë²„ì—ì„œ ì˜¤ëŠ” ë°ì´í„°ê°€ JSONì´ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ try-catchë¡œ ê°ì‹¸ì¤ë‹ˆë‹¤.
            try {
                const newNotification = JSON.parse(event.data);
                console.log("ìƒˆ ì•Œë¦¼ ë„ì°©:", newNotification);
                prependNotification(newNotification);

                // ìƒˆ ì•Œë¦¼ ë„ì°© ì‹œ ê°œìˆ˜ ì¦ê°€ ë° ë°°ì§€ ì—…ë°ì´íŠ¸
                unreadCount++;
                updateUnreadCountBadge();
            } catch (e) {
                // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì—°ê²° ë©”ì‹œì§€ ë“±ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì—ëŸ¬ë¥¼ ë¬´ì‹œí•˜ê±°ë‚˜ ë¡œê·¸ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
                console.log("ìˆ˜ì‹ ëœ ë¹„-JSON ë©”ì‹œì§€ (ì—°ê²° í™•ì¸ ë“±):", event.data);
            }
        });

        eventSource.onerror = function(error) {
            console.error("SSE Error:", error);
            eventSource.close();
        };
    }

    // (UI í—¬í¼) ì•Œë¦¼ ëª©ë¡ ì „ì²´ë¥¼ UIì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function updateNotificationUI(notifications) {
        // [ì œê±°] ë¬¸ì œê°€ ë˜ì—ˆë˜ ì˜ëª»ëœ console.log ì½”ë“œë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        const list = document.getElementById('notification-list');
        list.innerHTML = '';

        if (!notifications || notifications.length === 0) {
            list.innerHTML = '<li><p class="dropdown-item text-center text-muted mb-0">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p></li>';
            return;
        }

        notifications.forEach(noti => {
            list.innerHTML += createNotificationItemHTML(noti);
        });
    }

    // (UI í—¬í¼) ìƒˆ ì•Œë¦¼ì„ ëª©ë¡ ë§¨ ìœ„ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function prependNotification(notification) {
        const list = document.getElementById('notification-list');
        const noNotiMessage = list.querySelector('p');
        if (noNotiMessage) {
            noNotiMessage.parentElement.remove();
        }
        list.insertAdjacentHTML('afterbegin', createNotificationItemHTML(notification));
    }

    // (UI í—¬í¼) ì•Œë¦¼ í•­ëª© 1ê°œì˜ HTML ì½”ë“œë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function createNotificationItemHTML(notification) {
        const isUnreadClass = notification.isRead ? '' : 'fw-bold';
        const readStatusClass = notification.isRead ? '' : 'd-none';
        const timeAgo = formatTimeAgo(new Date(notification.createdAt));

        return `
            <li>
                <a class="dropdown-item ${isUnreadClass}" href="#" data-notification-id="${notification.id}" onclick="handleNotificationClick(event)">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="me-2">
                            <small>${notification.message}</small>
                            <span class="read-status text-muted small ms-1 ${readStatusClass}">(ì½ìŒ)</span>
                        </div>
                        <small class="text-muted text-nowrap">${timeAgo}</small>
                    </div>
                </a>
            </li>`;
    }

    // (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬) ì•Œë¦¼ í•­ëª©ì„ í´ë¦­í–ˆì„ ë•Œ 'ì½ìŒ' ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    async function handleNotificationClick(event) {
        event.preventDefault();
        const target = event.currentTarget;
        const notificationId = target.dataset.notificationId;

        if (!target.classList.contains('fw-bold')) return;

        try {
            const response = await fetch(`/api/notifications/${notificationId}/read`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
            });
            if (!response.ok) throw new Error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨');

            target.classList.remove('fw-bold');

            unreadCount--;
            updateUnreadCountBadge();

            const readStatusSpan = target.querySelector('.read-status');
            if (readStatusSpan) {
                readStatusSpan.classList.remove('d-none');
            }

        } catch (error) {
            console.error("ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
        }
    }

    //  ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ ë°°ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateUnreadCountBadge() {
        const badge = document.getElementById('notification-count-badge');
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }

    // (ìœ í‹¸ë¦¬í‹°) 'ëª‡ ë¶„ ì „' ê°™ì€ ì‹œê°„ í¬ë§·ì„ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜
    function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "ë…„ ì „";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "ë‹¬ ì „";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "ì¼ ì „";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "ì‹œê°„ ì „";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "ë¶„ ì „";
        return "ë°©ê¸ˆ ì „";
    }
</script>

</body>
</html>