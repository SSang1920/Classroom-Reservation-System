<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="topbar" class="top-bar bg-white border-bottom shadow-sm">

    <style>
        /* ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ì „ì²´ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        #notification-list .dropdown-item {
            /*  ë‚´ìš©ì´ ê¸¸ì–´ì§€ë©´ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆë˜ë„ë¡ ì„¤ì • */
            white-space: normal !important;
            word-wrap: break-word;

            /*  ê° ì•Œë¦¼ í•­ëª©ì˜ ìƒí•˜ ì—¬ë°±ì„ ëŠ˜ë ¤ ê°€ë…ì„± í™•ë³´ */
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        /* ê° ì•Œë¦¼ í•­ëª© ì‚¬ì´ì— êµ¬ë¶„ì„  ì¶”ê°€ (ë§ˆì§€ë§‰ í•­ëª© ì œì™¸) */
        #notification-list li:not(:last-child) {
            border-bottom: 1px solid #e9ecef;
        }

        /*  ë©”ì‹œì§€ í…ìŠ¤íŠ¸ì™€ ì‹œê°„ í…ìŠ¤íŠ¸ì˜ ì •ë ¬ì„ ê°œì„  */
        #notification-list .d-flex > div:first-child {
            /* ë©”ì‹œì§€ ì˜ì—­ì´ ê°€ëŠ¥í•œ ë§ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ í•¨ */
            flex-grow: 1;
        }
        #notification-list .d-flex > small:last-child {
            /* ì‹œê°„ ì˜ì—­ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ í•¨ */
            flex-shrink: 0;
            padding-left: 0.5rem; /* ë©”ì‹œì§€ì™€ì˜ ìµœì†Œ ê°„ê²© */
        }
    </style>

    <div>
        <a href="/" class="navbar-brand">
            <strong>ğŸ“ ê°•ì˜ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ</strong>
        </a>
    </div>

    <div class="d-flex align-items-center">
        <!-- ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ ë³´ì—¬ì§ˆ ë·° -->
        <div id="logged-out-view">
            <a href="/login" class="btn btn-primary">ë¡œê·¸ì¸</a>
            <a href="/signup" class="btn btn-secondary ms-2">íšŒì›ê°€ì…</a>
        </div>

        <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ë³´ì—¬ì§ˆ ë·° -->
        <div id="logged-in-view" class="d-flex align-items-center d-none">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>
    </div>
</div>


<script th:fragment="topbar-script">
    // ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ë¥¼ ì¶”ì í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
    let unreadCount = 0;

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('accessToken');
        const loggedOutView = document.getElementById('logged-out-view');
        const loggedInView = document.getElementById('logged-in-view');

        if (token) {
            // UI ìƒíƒœ ë³€ê²½
            loggedOutView.classList.add('d-none');
            loggedInView.classList.remove('d-none');

            try {
                const payload = parseJwt(token);

                let adminButtonHtml = '';
                if (payload.role === 'ROLE_ADMIN') {
                    adminButtonHtml = `<a href="/admin/main" class="btn btn-warning btn-sm me-2">ê´€ë¦¬ì í˜ì´ì§€</a>`;
                }

                loggedInView.innerHTML = `
                    <span class="me-2">í™˜ì˜í•©ë‹ˆë‹¤, <strong id="username-display">${payload.name || 'ì‚¬ìš©ì'}</strong>ë‹˜!</span>
                    <a href="/mypage" class="btn btn-outline-info btn-sm me-2">ë‚´ ì •ë³´</a>
                    ${adminButtonHtml}
                    <button id="logout-button" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>

                    <div class="notification dropdown ms-2">
                        <button class="btn btn-outline-secondary btn-sm position-relative" type="button" id="notification-dropdown-btn" data-bs-toggle="dropdown" aria-expanded="false">
                        ğŸ””
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notification-count-badge">
                            0
                        </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notification-dropdown-btn" id="notification-list" style="width: 350px; max-height: 400px; overflow-y: auto;">
                            <!-- ì•Œë¦¼ í—¤ë”: 'ëª¨ë‘ ì½ìŒ' ë²„íŠ¼ í¬í•¨ -->
                            <li>
                                <div class="dropdown-header d-flex justify-content-between align-items-center px-3 py-2">
                                    <h6 class="mb-0">ì•Œë¦¼</h6>
                                    <button class="btn btn-link btn-sm p-0" id="mark-all-as-read-btn" style ="text-decoration : none;">ëª¨ë‘ ì½ìŒ</button>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider my-0"></li>
                            <!-- ì•Œë¦¼ì´ ì—†ì„ ë•Œ í‘œì‹œë  ë©”ì‹œì§€ -->
                            <li><p class="dropdown-item text-center text-muted mb-0">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p></li>
                        </ul>
                    </div>
                `;

                document.getElementById('logout-button').addEventListener('click', () => logout(true));
                document.getElementById('mark-all-as-read-btn').addEventListener('click', handleMarkAllAsRead);

                // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì•Œë¦¼ ê¸°ëŠ¥ ìë™ ì‹¤í–‰
                initializeNotifications();
                connectSSE();

            } catch (e) {
                console.error("í† í° íŒŒì‹± ì˜¤ë¥˜:", e);
                logout();
            }

        } else {
            loggedOutView.classList.remove('d-none');
            loggedInView.classList.add('d-none');
        }
    });

    // (í˜ì´ì§€ ë¡œë“œ ì‹œ) ê¸°ì¡´ ì•Œë¦¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function initializeNotifications() {
        try {
            const response = await fetchWithAuth('/api/notifications');
            if (!response.ok) throw new Error('ì•Œë¦¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');

            const result = await response.json();
            updateNotificationUI(result.data);

            // ì´ˆê¸° ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ë¥¼ ê³„ì‚°í•˜ê³  ë°°ì§€ ì—…ë°ì´íŠ¸
            unreadCount = result.data.filter(n => !n.isRead).length;
            updateUnreadCountBadge();

        } catch (error) {
            console.error("ì•Œë¦¼ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
        }
    }

    // (í˜ì´ì§€ ë¡œë“œ ì‹œ) ì‹¤ì‹œê°„ ì•Œë¦¼(SSE) ì—°ê²°ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
    function connectSSE() {
        const token = localStorage.getItem('accessToken');
        if (!token) return;

        const eventSource = new EventSource(`/api/notifications/subscribe?token=${token}`);

        // ì„œë²„ì—ì„œ ë³´ë‚¸ connect ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ
        eventSource.addEventListener("connect", function(event) {
            console.log("ì„œë²„ë¡œë¶€í„° ì—°ê²° í™•ì¸:", event.data);
        });

        // ì•Œë¦¼ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ
        eventSource.addEventListener("notification", function(event) {
            //  ì„œë²„ì—ì„œ ì˜¤ëŠ” ë°ì´í„°ê°€ JSONì´ ì•„ë‹Œ ê²½ìš° ë°©ì§€ë¥¼ ìœ„í•´  try-catch ì‚¬ìš©
            try {
                const newNotification = JSON.parse(event.data);
                console.log("ìƒˆ ì•Œë¦¼ ë„ì°©:", newNotification);
                prependNotification(newNotification);

                // ìƒˆ ì•Œë¦¼ ë„ì°© ì‹œ ê°œìˆ˜ ì¦ê°€ ë° ë°°ì§€ ì—…ë°ì´íŠ¸
                unreadCount++;
                updateUnreadCountBadge();

            } catch (e) {
                // ì˜ˆê¸°ì¹˜ ëª»í•œ ë¹„-JSON ë°ì´í„° ìˆ˜ì‹  ì‹œ ë¡œê·¸ ê¸°ë¡
                console.warn("ìˆ˜ì‹ ëœ ë°ì´í„°ê°€ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤:", event.data);
            }
        });

        eventSource.onerror = function(error) {
            console.error("SSE Error:", error);
            eventSource.close();
        };
    }

    // (UI í—¬í¼) ì•Œë¦¼ ëª©ë¡ ì „ì²´ë¥¼ UIì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function updateNotificationUI(notifications) {
        const list = document.getElementById('notification-list');

        const itemsToRemove = list.querySelectorAll('li:not(:first-child):not(:nth-child(2))');
        itemsToRemove.forEach(item => item.remove());

        if (!notifications || notifications.length === 0) {
            list.insertAdjacentHTML('beforeend', '<li><p class="dropdown-item text-center text-muted mb-0">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p></li>');
            return;
        }

        const notificationsHtml = notifications.map(createNotificationItemHTML).join('');
        list.insertAdjacentHTML('beforeend', notificationsHtml);
    }

    // (UI í—¬í¼) ìƒˆ ì•Œë¦¼ì„ ëª©ë¡ ë§¨ ìœ„ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function prependNotification(notification) {
        const list = document.getElementById('notification-list');
        const noNotiMessage = list.querySelector('p');
        if (noNotiMessage) {
            noNotiMessage.parentElement.remove();
        }
        list.querySelector('hr.dropdown-divider').insertAdjacentHTML('afterend', createNotificationItemHTML(notification));
    }

    // (UI í—¬í¼) ì•Œë¦¼ í•­ëª© 1ê°œì˜ HTML ì½”ë“œë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function createNotificationItemHTML(notification) {
        const isUnreadClass = notification.isRead ? '' : 'fw-bold';
        const readStatusClass = notification.isRead ? '' : 'd-none';
        const timeAgo = formatTimeAgo(new Date(notification.createdAt));

        return `
            <li>
                <a class="dropdown-item ${isUnreadClass}" href="#" data-notification-id="${notification.id}" onclick="handleNotificationClick(event)">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="me-2">
                            <small>${notification.message}</small>
                            <span class="read-status text-muted small ms-1 ${readStatusClass}">(ì½ìŒ)</span>
                        </div>
                        <small class="text-muted text-nowrap">${timeAgo}</small>
                    </div>
                </a>
            </li>`;
    }

    // (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬) ì•Œë¦¼ í•­ëª©ì„ í´ë¦­í–ˆì„ ë•Œ 'ì½ìŒ' ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    async function handleNotificationClick(event) {
        event.preventDefault();
        const target = event.currentTarget;
        const notificationId = target.dataset.notificationId;

        if (!target.classList.contains('fw-bold')) return;

        try {
            const response = await fetchWithAuth(`/api/notifications/${notificationId}/read`, {
                method: 'PATCH',
            });
            if (!response.ok) throw new Error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨');

            target.classList.remove('fw-bold');

            unreadCount--;
            updateUnreadCountBadge();

            const readStatusSpan = target.querySelector('.read-status');
            if (readStatusSpan) {
                readStatusSpan.classList.remove('d-none');
            }

        } catch (error) {
            console.error("ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
        }
    }
    async function handleMarkAllAsRead(event) {
        event.preventDefault();
        if (unreadCount === 0) return; // ì½ì„ ì•Œë¦¼ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨

        try {
            const response = await fetchWithAuth('/api/notifications/read-all', {
                method: 'PATCH'
            });
            if (!response.ok) throw new Error('ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨');

            // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            unreadCount = 0;
            updateUnreadCountBadge();

            // ëª¨ë“  ì•Œë¦¼ í•­ëª©ì—ì„œ 'fw-bold' í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('#notification-list .dropdown-item.fw-bold').forEach(item => {
                item.classList.remove('fw-bold');
            });

            // ëª¨ë“  ì•Œë¦¼ í•­ëª©ì— '(ì½ìŒ)' í‘œì‹œ
            document.querySelectorAll('#notification-list .read-status.d-none').forEach(span => {
                span.classList.remove('d-none');
            });

        } catch (error) {
            console.error("ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
            alert(error.message || 'ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    //  ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ ë°°ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateUnreadCountBadge() {
        const badge = document.getElementById('notification-count-badge');
        const markAllBtn = document.getElementById('mark-all-as-read-btn');

        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }

    // (ìœ í‹¸ë¦¬í‹°) 'ëª‡ ë¶„ ì „' ê°™ì€ ì‹œê°„ í¬ë§·ì„ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜
    function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "ë…„ ì „";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "ë‹¬ ì „";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "ì¼ ì „";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "ì‹œê°„ ì „";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "ë¶„ ì „";
        return "ë°©ê¸ˆ ì „";
    }
</script>

</body>
</html>