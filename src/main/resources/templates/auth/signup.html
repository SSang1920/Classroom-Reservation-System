<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="mb-4 text-center">회원가입</h2>
                    <div id="signup-form">
                        <!-- 이름 -->
                        <div class="mb-3">
                            <label for="name" class="form-label">이름</label>
                            <input type="text" class="form-control" id="name">
                            <div id="name-error" class="form-text"></div>
                        </div>

                        <!-- 아이디 -->
                        <div class="mb-3">
                            <label for="id" class="form-label">아이디</label>
                            <input type="text" class="form-control" id="id" maxlength="16">
                            <div id="id-error" class="form-text"></div>
                            <div id="id-check-result" class="form-text"></div>
                        </div>

                        <!-- 비밀번호 -->
                        <div class="mb-3">
                            <label for="password" class="form-label">비밀번호</label>
                            <input type="password" class="form-control" id="password">
                            <div id="password-check-result" class="form-text"></div>
                        </div>

                        <!-- 비밀번호 확인 -->
                        <div class="mb-3">
                            <label for="password-confirm" class="form-label">비밀번호 확인</label>
                            <input type="password" class="form-control" id="password-confirm">
                            <div id="password-confirm-result" class="form-text"></div>
                        </div>

                        <!-- 이메일 -->
                        <div class="mb-3">
                            <label for="email" class="form-label">이메일</label>
                            <input type="email" class="form-control" id="email">
                            <div id="email-error" class="form-text"></div>
                            <div id="email-check-result" class="form-text"></div>
                        </div>

                        <!-- 역할 -->
                        <div class="mb-3">
                            <label for="role" class="form-label">역할</label>
                            <select class="form-select" id="role">
                                <option value="" selected disabled>--역할 선택--</option>
                                <option value="STUDENT">학생</option>
                                <option value="PROFESSOR">교수</option>
                            </select>
                            <div id="role-error" class="form-text"></div>
                        </div>

                        <!-- 가입 버튼 -->
                        <button id="signup-button" onclick="submitSignup()" class="btn btn-primary w-100">가입하기</button>

                        <div class="mt-3 text-center">
                            <a href="/" class="text-secondary">홈으로</a>
                        </div>
                    </div>
                    <p class="mt-4 text-center text-muted" style="font-size:0.9rem;">실시간 강의실 예약 시스템</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript: 회원가입 + ID 중복 확인 -->
<script>
    let idCheckTimer = null;
    let emailCheckTimer = null;

   // ID 중복체크
    function validateId() {
      const id = document.getElementById('id').value.trim();
      const idError = document.getElementById('id-error');
      const resultBox = document.getElementById('id-check-result');

      idError.innerText = '';
      resultBox.innerText = '';
      idError.className = 'form-text';
      resultBox.className = 'form-text';

      // 형식 검사
      if (!/^[a-zA-Z0-9]{6,15}$/.test(id)) {
        idError.innerText = '아이디는 6~15자 이내의 영어와 숫자만 입력할 수 있습니다.';
        idError.className = 'form-text text-danger';
        return;
      }

      // 중복 체크 (디바운싱)
      if (idCheckTimer) clearTimeout(idCheckTimer);
      idCheckTimer = setTimeout(() => {
        fetch(`/auth/check-id?id=${encodeURIComponent(id)}`)
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if (ok) {
              resultBox.textContent = data.message || '사용 가능한 아이디입니다.';
              resultBox.className = 'form-text text-success';
            } else {
              resultBox.textContent = data.message || '이미 사용 중인 아이디입니다.';
              resultBox.className = 'form-text text-danger';
            }
          });
      }, 500);
    }

  // 이메일 중복체크
    function validateEmail() {
      const email = document.getElementById('email').value.trim();
      const formatErrorBox = document.getElementById('email-error');
      const resultBox = document.getElementById('email-check-result');

      formatErrorBox.innerText = '';
      resultBox.innerText = '';
      formatErrorBox.className = 'form-text';
      resultBox.className = 'form-text';

    // 형식검사
      if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
        formatErrorBox.innerText = '이메일 형식이 올바르지 않습니다.';
        formatErrorBox.className = 'form-text text-danger';
        return;
  }

    // 중복 체크 (디바운싱)
      if (emailCheckTimer) clearTimeout(emailCheckTimer);
      emailCheckTimer = setTimeout(() => {
        fetch(`/auth/check-email?email=${encodeURIComponent(email)}`)
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if (ok) {
              resultBox.textContent = data.message || '사용 가능한 이메일입니다.';
              resultBox.className = 'form-text text-success';
          } else {
              resultBox.textContent = data.message || '이미 사용 중인 이메일입니다.';
              resultBox.className = 'form-text text-danger';
          }
        })
          .catch(() => {
            resultBox.textContent = '중복 확인 중 오류가 발생했습니다.';
            resultBox.className = 'form-text text-danger';
          });
    }, 500);
  }


    function validatePassword() {
      const pw = document.getElementById('password').value;
      const box = document.getElementById('password-check-result');

      if (!pw) {
        box.innerText = '';
        return;
      }

      if (pw.length >= 8) {
        box.innerText = '사용 가능한 비밀번호입니다.';
        box.className = 'form-text text-success';
      } else {
        box.innerText = '비밀번호는 8자 이상이어야 합니다.';
        box.className = 'form-text text-danger';
      }
    }

    function validatePasswordConfirm() {
      const pw = document.getElementById('password').value;
      const confirm = document.getElementById('password-confirm').value;
      const result = document.getElementById('password-confirm-result');

      if (!confirm) {
        result.innerText = '';
        return;
      }

      if (pw === confirm) {
        result.innerText = '비밀번호가 일치합니다.';
        result.className = 'form-text text-success';
      } else {
        result.innerText = '비밀번호가 일치하지 않습니다.';
        result.className = 'form-text text-danger';
      }
    }

    function clearAllErrors() {
      ['id-error', 'id-check-result', 'email-error', 'password-check-result', 'password-confirm-result']
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.innerText = '';
            el.className = 'form-text';
          }
        });
    }

    function showServerError(code, message) {
      if (code === 'INVALID_ID_FORMAT' || code === 'DUPLICATE_ID') {
        const box = document.getElementById('id-error');
        box.innerText = message;
        box.className = 'form-text text-danger';
      } else if (code === 'DUPLICATE_EMAIL') {
        const box = document.getElementById('email-error');
        box.innerText = message;
        box.className = 'form-text text-danger';
      } else if (code === 'PASSWORD_CONFIRM_NOT_MATCH') {
        const box = document.getElementById('password-confirm-result');
        box.innerText = message;
        box.className = 'form-text text-danger';
      } else {
        alert(message || '알 수 없는 오류가 발생했습니다.');
      }
    }

    function submitSignup() {

     const roleSelect = document.getElementById('role');
     const roleValue = roleSelect.value === "" ? null : roleSelect.value;

    const payload = {
      name: document.getElementById('name').value.trim(),
      id: document.getElementById('id').value.trim(),
      password: document.getElementById('password').value,
      passwordConfirm: document.getElementById('password-confirm').value,
      email: document.getElementById('email').value.trim(),
      role: roleValue
    };

    fetch('/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
      .then(async res => {
        const data = await res.json();

        if (res.ok) {
          alert('회원가입이 완료되었습니다.');
          window.location.href = '/auth/login';
        } else {
          // 커스텀 예외: 우리가 정의한 ErrorCode 기반
          if (data.errorCode && data.errorCode !== 'VALIDATION_FAIL') {
            alert(data.message || '오류가 발생했습니다.');
          }
          // 유효성 검증 실패: errors 맵에서 첫 번째 필드 메시지를 alert
          else if (data.errorCode === 'VALIDATION_FAIL' && data.errors) {
            const firstField = Object.keys(data.errors)[0];
            const fieldMessage = data.errors[firstField];
            alert(fieldMessage || '입력값이 올바르지 않습니다.');
          }
          // 그 외 처리되지 않은 에러
          else {
            alert(data.message || '알 수 없는 오류가 발생했습니다.');
          }
        }
      })
      .catch(() => {
        alert('회원가입 요청 중 오류가 발생했습니다.');
      });
  }

    // 이벤트 연결
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('id').addEventListener('input', validateId);
      document.getElementById('email').addEventListener('input', validateEmail);
      document.getElementById('password').addEventListener('input', validatePassword);
      document.getElementById('password-confirm').addEventListener('input', validatePasswordConfirm);
    });
</script>

</body>
</html>
