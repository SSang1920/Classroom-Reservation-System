<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>ê´€ë¦¬ì - ì˜ˆì•½ ë³€ê²½ ìš”ì²­ ê´€ë¦¬</title>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container-fluid">
    <!-- ì‚¬ì´ë“œë°” -->
    <nav th:replace="~{fragments/admin-sidebar :: admin-sidebar}"></nav>

    <main class="admin-content px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">ğŸ“ ì˜ˆì•½ ë³€ê²½ ìš”ì²­ ê´€ë¦¬</h1>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>ìš”ì²­ ID</th>
                            <th>í•™ìƒëª…</th>
                            <th>ê¸°ì¡´ ì˜ˆì•½</th>
                            <th>ë³€ê²½ ìš”ì²­ ë‚´ìš©</th>
                            <th>ìš”ì²­ ë©”ì‹œì§€</th>
                            <th>ìƒíƒœ</th>
                            <th>ìš”ì²­ì¼</th>
                            <th>ì²˜ë¦¬</th>
                        </tr>
                        </thead>
                        <tbody id="requests-tbody">
                        <!-- JSë¡œ ì±„ì›Œì§ˆ ì˜ì—­ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ê±°ì ˆ ì‚¬ìœ  ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìš”ì²­ ê±°ì ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rejectRequestId">
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">ê±°ì ˆ ì‚¬ìœ </label>
                    <textarea class="form-control" id="rejectionReason" rows="3" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">ê±°ì ˆ í™•ì •</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script th:src="@{/js/admin-auth.js}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const token = localStorage.getItem('accessToken');
        const tbody = document.getElementById('requests-tbody');
        const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
        const rejectRequestIdInput = document.getElementById('rejectRequestId');
        const rejectionReasonTextarea = document.getElementById('rejectionReason');
        const confirmRejectBtn = document.getElementById('confirmRejectBtn');

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        async function fetchAllRequests() {
            tbody.innerHTML = '<tr><td colspan="8" class="p-5"><div class="spinner-border"></div></td></tr>';
            try {
                const response = await fetch('/api/admin/change-requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
                const result = await response.json();
                renderTable(result.data);
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-danger p-4">${error.message}</td></tr>`;
            }
        }

        // 2. ë°›ì•„ì˜¨ ë°ì´í„°ë¡œ í…Œì´ë¸”ì„ ê·¸ë¦½ë‹ˆë‹¤.
        function renderTable(requests) {
            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-4">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            tbody.innerHTML = requests.map(req => createRow(req)).join('');
        }

        // ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ìƒ‰ìƒì˜ ë°°ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function getStatusBadge(status) {
            const statusClasses = {
                'ëŒ€ê¸°ì¤‘': 'bg-warning text-dark',
                'ìŠ¹ì¸ë¨': 'bg-success',
                'ê±°ì ˆë¨': 'bg-danger'
            };
            const badgeClass = statusClasses[status] || 'bg-secondary';
            return `<span class="badge ${badgeClass}">${status}</span>`;
        }

        // 3. í…Œì´ë¸”ì˜ í•œ í–‰(tr)ì„ ìƒì„±í•©ë‹ˆë‹¤.
        function createRow(req) {
            // flatpickrë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì§œ í˜•ì‹ í†µì¼
            const originalTime = flatpickr.formatDate(new Date(req.originalStartTime), "Y-m-d H:i");
            const newDate = flatpickr.formatDate(new Date(req.newReservationDate), "Y-m-d (D)");
            const requestedAt = flatpickr.formatDate(new Date(req.requestedAt), "Y-m-d H:i");
            const statusBadge = getStatusBadge(req.status);

            // ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ì„ ë‹¤ë¥´ê²Œ í‘œì‹œ
            let actionButtons = '';
            if (req.status === 'ëŒ€ê¸°ì¤‘') {
                actionButtons = `
                    <button class="btn btn-sm btn-success" onclick="handleApprove(${req.requestId})">ìŠ¹ì¸</button>
                    <button class="btn btn-sm btn-danger ms-1" onclick="openRejectModal(${req.requestId})">ê±°ì ˆ</button>
                `;
            }

            return `
                <tr id="request-row-${req.requestId}">
                    <td>${req.requestId}</td>
                    <td>${req.studentName}</td>
                    <td>${req.originalClassroom}<br><small class="text-muted">${originalTime}</small></td>
                    <td>(ID: ${req.newClassroomId}) ê°•ì˜ì‹¤<br><small class="text-muted">${newDate}</small></td>
                    <td>${req.requestMessage || '-'}</td>
                    <td>${statusBadge}</td>
                    <td><small class="text-muted">${requestedAt}</small></td>
                    <td>${actionButtons || 'ì²˜ë¦¬ ì™„ë£Œ'}</td>
                </tr>
            `;
        }

        // 4. 'ìŠ¹ì¸' ì²˜ë¦¬
        window.handleApprove = async function(requestId) {
            if (!confirm(`ìš”ì²­(ID: ${requestId})ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            await processRequest(requestId, true, 'ê´€ë¦¬ìì— ì˜í•´ ìŠ¹ì¸ë¨');
        }

        // 5. 'ê±°ì ˆ' ëª¨ë‹¬ ì—´ê¸°
        window.openRejectModal = function(requestId) {
            rejectRequestIdInput.value = requestId;
            rejectionReasonTextarea.value = '';
            rejectModal.show();
        }

        // 6. ëª¨ë‹¬ì—ì„œ 'ê±°ì ˆ í™•ì •' ë²„íŠ¼ í´ë¦­
        confirmRejectBtn.addEventListener('click', async () => {
            const requestId = rejectRequestIdInput.value;
            const reason = rejectionReasonTextarea.value;
            if (!reason.trim()) {
                alert('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            await processRequest(requestId, false, reason);
            rejectModal.hide();
        });

        // 7. ìŠ¹ì¸/ê±°ì ˆ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        async function processRequest(requestId, isApprove, message) {
            try {
                const response = await fetch(`/api/admin/change-requests/${requestId}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ approve: isApprove, responseMessage: message })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                fetchAllRequests(); // ì„±ê³µ ì‹œ í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                alert(`ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        fetchAllRequests(); // í˜ì´ì§€ ì§„ì… ì‹œ í•¨ìˆ˜ í˜¸ì¶œ
    });
</script>
</body>
</html>