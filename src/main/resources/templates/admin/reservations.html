<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>관리자 - 예약 관리</title>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">📅 예약 관리</h1>
        <a href="/admin/main" class="btn btn-outline-secondary">관리자 홈으로</a>
    </div>

    <div class="card mb-4">
        <div class="card-body bg-light">
            <form id="search-form" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="username" class="form-label">예약자명</label>
                    <input type="text" id="username" name="username" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="building-select" class="form-label">건물</label>
                    <select id="building-select" class="form-select">
                        <option value="">전체</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="classroom-select" class="form-label">강의실</label>
                    <select id="classroom-select" name="classroomId" class="form-select" disabled>
                        <option value="">건물 먼저 선택</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">시작일</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">종료일</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="state" class="form-label">상태</label>
                    <select id="state" name="state" class="form-select">
                        <option value="">전체</option>
                        <!-- Thymeleaf는 Enum의 영문 이름을 값으로 사용합니다 -->
                        <option th:each="s : ${T(com.example.classroom_reservation_system.reservation.entity.ReservationState).values()}"
                                th:value="${s.name()}" th:text="${s.name()}"></option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" id="reset-btn" class="btn btn-secondary">초기화</button>
                    <button type="submit" class="btn btn-primary">검색</button>
                </div>
            </form>
        </div>
    </div>


    <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>예약자 (ID)</th>
                <th>강의실</th>
                <th>예약 시작</th>
                <th>예약 종료</th>
                <th>상태</th>
                <th>관리</th>
            </tr>
            </thead>
            <tbody id="reservation-table-body">

            </tbody>
        </table>
    </div>

    <nav id="pagination-nav">
        <ul class="pagination justify-content-center">

        </ul>
    </nav>
</div>


<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">

</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>
<script src="/js/admin-auth.js"></script>

<script>
    // 전역 변수
    let currentPage = 0;
    let startDatePicker, endDatePicker; // flatpickr 인스턴스 저장

    document.addEventListener('DOMContentLoaded', function () {
        // DOM 요소 가져오기
        const searchForm = document.getElementById('search-form');
        const resetBtn = document.getElementById('reset-btn');
        const tableBody = document.getElementById('reservation-table-body');
        const paginationNav = document.getElementById('pagination-nav');
        const buildingSelect = document.getElementById('building-select');

        //  flatpickr 초기화
        startDatePicker = flatpickr('#startDate', {
            altFormat: "Y-m-d (D)",
            dateFormat: "Y-m-d",
            locale: "ko"
        });
        endDatePicker = flatpickr('#endDate', {
            altFormat: "Y-m-d (D)",
            dateFormat: "Y-m-d",
            locale: "ko"
        });

        // 페이지 로드 시 초기화 함수 호출
        initializePage();

        // --- 이벤트 리스너 등록 ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            fetchReservations(0);
        });

        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            startDatePicker.clear(); // flatpickr 초기화
            endDatePicker.clear();   // flatpickr 초기화
            resetClassroomSelect();
            window.history.replaceState({}, '', '/admin/reservations');
            fetchReservations(0);
        });

        buildingSelect.addEventListener('change', () => {
            const selectedBuildingId = buildingSelect.value;
            if (selectedBuildingId) {
                fetchClassroomsForBuilding(selectedBuildingId);
            } else {
                resetClassroomSelect();
            }
        });

        tableBody.addEventListener('click', handleTableButtonClick);
        paginationNav.addEventListener('click', handlePaginationClick);
    });

    // --- 함수 선언부 ---

    async function initializePage() {
        await initializeBuildingFilter(); // 1. 건물 필터 먼저 초기화
        await initializeFormFromUrl();      // 2. URL 파라미터로 폼 채우기
        const urlParams = new URLSearchParams(window.location.search);
        fetchReservations(parseInt(urlParams.get('page')) || 0); // 3. 데이터 로드
    }

    async function initializeBuildingFilter() {
        try {
            const response = await fetchWithAuth('/api/facilities/buildings');
            if (!response.ok) throw new Error('건물 목록 로딩 실패');
            const result = await response.json();
            const buildings = result.data;
            const buildingSelect = document.getElementById('building-select');
            buildings.forEach(b => {
                buildingSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
        } catch (error) {
            console.error(error);
        }
    }

    async function initializeFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        document.getElementById('username').value = params.get('username') || '';
        if(params.get('startDate')) startDatePicker.setDate(params.get('startDate'), false);
        if(params.get('endDate')) endDatePicker.setDate(params.get('endDate'), false);
        document.getElementById('state').value = params.get('state') || '';

        const buildingId = params.get('buildingId');
        if (buildingId) {
            const buildingSelect = document.getElementById('building-select');
            buildingSelect.value = buildingId;
            // 건물이 선택되었으면, 해당 건물의 강의실 목록을 불러와서 채움
            await fetchClassroomsForBuilding(buildingId, params.get('classroomId'));
        }
    }

    async function fetchClassroomsForBuilding(buildingId, selectedClassroomId = null) {
        const classroomSelect = document.getElementById('classroom-select');
        resetClassroomSelect();
        classroomSelect.innerHTML = '<option value="">로딩 중...</option>';

        try {
            const response = await fetchWithAuth(`/api/facilities/buildings/${buildingId}/classrooms`);
            if (!response.ok) throw new Error('강의실 목록 로딩 실패');
            const result = await response.json();
            const classrooms = result.data;

            classroomSelect.innerHTML = '<option value="">전체</option>';
            classrooms.forEach(c => {
                classroomSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            classroomSelect.disabled = false;

            if (selectedClassroomId) {
                classroomSelect.value = selectedClassroomId;
            }
        } catch (error) {
            console.error(error);
            classroomSelect.innerHTML = '<option value="">오류</option>';
        }
    }

    function resetClassroomSelect() {
        const classroomSelect = document.getElementById('classroom-select');
        classroomSelect.innerHTML = '<option value="">건물 먼저 선택</option>';
        classroomSelect.disabled = true;
    }

    function buildQueryParameters(pageNumber) {
        const formData = new FormData(document.getElementById('search-form'));
        const params = new URLSearchParams(formData);
        params.append('page', pageNumber);
        params.append('size', 10);
        params.append('sort', 'startTime,desc');
        return params;
    }

    async function fetchReservations(page) {
        currentPage = page;
        const params = buildQueryParameters(page);

        // URL 상태 유지를 위해 buildingId도 함께 저장
        const urlParams = new URLSearchParams(params);
        const buildingId = document.getElementById('building-select').value;
        // buildingId는 form의 name 속성이 없으므로 FormData에 포함되지 않음. 수동으로 추가.
        if(buildingId) {
            urlParams.set('buildingId', buildingId);
        } else {
            urlParams.delete('buildingId'); // 값이 없으면 파라미터에서 제거
        }
        window.history.replaceState({}, '', `/admin/reservations?${urlParams.toString()}`);

        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> 예약 정보 로딩 중...</td></tr>`;

        try {
            const response = await fetchWithAuth(`/api/admin/reservations?${params.toString()}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '데이터 로딩 실패');
            }
            const result = await response.json();
            renderTable(result.data.content);
            renderPagination(result.data);
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${error.message}</td></tr>`;
        }
    }

    function renderTable(reservations) {
        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = '';
        if (!reservations || reservations.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">검색 결과가 없습니다.</td></tr>';
            return;
        }
        reservations.forEach(res => {
            let managementButtons = '<span>-</span>';
            if (res.state === 'RESERVED') {
                managementButtons = `
                    <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${res.id}">수정</button>
                    <button class="btn btn-sm btn-outline-danger cancel-btn" data-id="${res.id}">취소</button>
                `;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${res.id}</td>
                <td>${res.username} (${res.loginId})</td>
                <td>${res.classroomName}</td>
                <td>${formatDateTime(res.startTime)}</td>
                <td>${formatDateTime(res.endTime)}</td>
                <td><span class="badge ${getStateBadgeClass(res.state)}">${getStateName(res.state)}</span></td>
                <td>${managementButtons}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const ul = paginationNav.querySelector('.pagination');
        ul.innerHTML = '';
        if (pageData.totalPages <= 1) return;
        ul.innerHTML += `<li class="page-item ${pageData.first ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number - 1}">이전</a></li>`;
        for (let i = 0; i < pageData.totalPages; i++) {
            ul.innerHTML += `<li class="page-item ${i === pageData.number ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i + 1}</a></li>`;
        }
        ul.innerHTML += `<li class="page-item ${pageData.last ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number + 1}">다음</a></li>`;
    }

    function handleTableButtonClick(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const reservationId = button.dataset.id;
        if (button.classList.contains('cancel-btn')) {
            if (confirm(`예약 ID [${reservationId}] 를 정말로 취소하시겠습니까?`)) {
                cancelReservation(reservationId);
            }
        } else if (button.classList.contains('edit-btn')) {
            openEditModal(reservationId);
        }
    }

    function handlePaginationClick(e) {
        e.preventDefault();
        const pageLink = e.target.closest('.page-link');
        if (pageLink && !pageLink.parentElement.classList.contains('disabled')) {
            fetchReservations(parseInt(pageLink.dataset.page));
        }
    }

    async function cancelReservation(id) {
        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${id}/cancel`, { method: 'PATCH' });
            if (!response.ok) throw new Error((await response.json()).message);
            alert('예약이 성공적으로 취소되었습니다.');
            fetchReservations(currentPage);
        } catch (error) {
            alert(`취소 실패: ${error.message}`);
        }
    }

    function openEditModal(id) {
        alert(`ID ${id} 예약 수정 기능은 구현 예정입니다.`);
    }

    function formatDateTime(isoString) {
    if (!isoString) return '';

    const days = ['일', '월', '화', '수', '목', '금', '토']; // 요일 배열
    const d = new Date(isoString);

    const yyyy = d.getFullYear();
    const MM = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    const dayName = days[d.getDay()]; // 요일 가져오기

    return `${yyyy}.${MM}.${dd} (${dayName}) ${hh}:${mm}`;
    }

    function getStateBadgeClass(state) {
        const states = { 'RESERVED': 'bg-primary', 'CANCELED': 'bg-secondary', 'COMPLETED': 'bg-success', 'CANCELED_BY_ADMIN': 'bg-danger', 'MODIFIED_BY_ADMIN': 'bg-warning text-dark', 'COMPLETED_BY_SYSTEM': 'bg-info text-dark' };
        return states[state] || 'bg-dark';
    }

    // 모든 상태에 대한 한글 이름을 여기서 관리합니다.
    function getStateName(state) {
        const stateMap = {
            RESERVED: '예약됨',
            COMPLETED: '완료됨',
            CANCELED: '취소됨',
        };
        return stateMap[state] || state; // 매핑되는 값이 없으면 원래 영문 이름 반환
    }
</script>
</script>
</body>
</html>