<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>ê´€ë¦¬ì - ì˜ˆì•½ ê´€ë¦¬</title>
    <style>
    #reservation-table-body tr {
    cursor: pointer;
    }
    </style>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">ğŸ“… ì˜ˆì•½ ê´€ë¦¬</h1>
        <a href="/admin/main" class="btn btn-outline-secondary">ê´€ë¦¬ì í™ˆìœ¼ë¡œ</a>
    </div>

    <div class="card mb-4">
        <div class="card-body bg-light">
            <form id="search-form" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="username" class="form-label">ì˜ˆì•½ìëª…</label>
                    <input type="text" id="username" name="username" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="building-select" class="form-label">ê±´ë¬¼</label>
                    <select id="building-select" class="form-select">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="classroom-select" class="form-label">ê°•ì˜ì‹¤</label>
                    <select id="classroom-select" name="classroomId" class="form-select" disabled>
                        <option value="">ê±´ë¬¼ ë¨¼ì € ì„ íƒ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="state" class="form-label">ìƒíƒœ</label>
                    <select id="state" name="state" class="form-select">
                        <option value="">ì „ì²´</option>
                        <option th:each="s : ${T(com.example.classroom_reservation_system.reservation.entity.ReservationState).values()}"
                                th:value="${s.name()}" th:text="${s.description}"></option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" id="reset-btn" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                    <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
                </div>
            </form>
        </div>
    </div>


    <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>ì˜ˆì•½ì (ID)</th>
                <th>ê°•ì˜ì‹¤</th>
                <th>ì˜ˆì•½ ì‹œì‘</th>
                <th>ì˜ˆì•½ ì¢…ë£Œ</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="reservation-table-body">
            </tbody>
            <template id="history-detail-template">
                <tr class="history-detail-row">
                    <td colspan="7" class="p-3 bg-light">
                        <div class="history-content">
                        </div>
                    </td>
                </tr>
            </template>
        </table>
    </div>

    <nav id="pagination-nav">
        <ul class="pagination justify-content-center">
        </ul>
    </nav>
</div>


<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">ğŸ“… ì˜ˆì•½ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ëª¨ë¸ ë¡œë”© ìŠ¤í”¼ë„ˆ -->
                <div id="modal-loader" class="text-center d-none p-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>

                <!-- ëª¨ë¸ í¼ -->
                <form id="edit-reservation-form" class="d-none">
                    <input type="hidden" id="edit-reservation-id">

                    <div class="mb-3">
                        <label for="edit-building-select" class="form-label">ê±´ë¬¼</label>
                        <select class="form-select" id="edit-building-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="edit-classroom-select" class="form-label">ê°•ì˜ì‹¤</label>
                        <select class="form-select" id="edit-classroom-select" name="classroomId" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="edit-reservation-date" class="form-label">ë‚ ì§œ</label>
                        <input type="text" class="form-control" id="edit-reservation-date" name="reservationDate" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì‹œê°„(êµì‹œ) ì„ íƒ</label>
                        <small class="form-text text-muted d-block mb-2">ìµœëŒ€ 2ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                        <div id="edit-time-periods-container" class="border p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>

                    <div id="edit-error-message" class="alert alert-danger d-none" role="alert"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="save-changes-btn">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>
<script src="/js/admin-auth.js"></script>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 0;
    let searchStartDatePicker, searchEndDatePicker; // ê²€ìƒ‰ìš© flatpickr
    let editDatePicker; // ìˆ˜ì • ëª¨ë‹¬ìš© flatpickr
    let editModal; // ìˆ˜ì • ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤

    document.addEventListener('DOMContentLoaded', function () {
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const searchForm = document.getElementById('search-form');
        const resetBtn = document.getElementById('reset-btn');
        const tableBody = document.getElementById('reservation-table-body');
        const paginationNav = document.getElementById('pagination-nav');
        const buildingSelect = document.getElementById('building-select');
        editModal = new bootstrap.Modal(document.getElementById('editReservationModal'));

        // flatpickr ì´ˆê¸°í™”
        searchStartDatePicker = flatpickr('#startDate', { altFormat: "Y-m-d", dateFormat: "Y-m-d", locale: "ko" });
        searchEndDatePicker = flatpickr('#endDate', { altFormat: "Y-m-d", dateFormat: "Y-m-d", locale: "ko" });
        editDatePicker = flatpickr('#edit-reservation-date', {
            altFormat: "Y-m-d", dateFormat: "Y-m-d", locale: "ko", minDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                const currentSelections = getSelectedPeriodsFromModal();
                updateEditModalTimes(currentSelections);
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        initializePage();

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        searchForm.addEventListener('submit', (e) => { e.preventDefault(); fetchReservations(0); });
        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            searchStartDatePicker.clear();
            searchEndDatePicker.clear();
            resetClassroomSelect();
            window.history.replaceState({}, '', '/admin/reservations');
            fetchReservations(0);
        });
        buildingSelect.addEventListener('change', () => {
            const selectedBuildingId = buildingSelect.value;
            fetchClassroomsForBuilding(selectedBuildingId, 'classroom-select');
        });
        // [ìˆ˜ì •] ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ë¦„ì„ ë” ëª…í™•í•˜ê²Œ ë³€ê²½
        tableBody.addEventListener('click', handleTableClick);
        paginationNav.addEventListener('click', handlePaginationClick);

        // ìˆ˜ì • ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('save-changes-btn').addEventListener('click', saveReservationChanges);
        document.getElementById('edit-time-periods-container').addEventListener('change', handleEditCheckboxChange);
        document.getElementById('edit-building-select').addEventListener('change', (e) => {
            fetchClassroomsForBuilding(e.target.value, 'edit-classroom-select');
        });
        document.getElementById('edit-classroom-select').addEventListener('change', () => {
             const currentSelections = getSelectedPeriodsFromModal();
             updateEditModalTimes(currentSelections);
         });
    });

    // --- í•¨ìˆ˜ ì„ ì–¸ë¶€ ---

    async function initializePage() {
        await initializeBuildingFilter('building-select');
        await initializeFormFromUrl();
        const urlParams = new URLSearchParams(window.location.search);
        fetchReservations(parseInt(urlParams.get('page')) || 0);
    }

    function getSelectedPeriodsFromModal() {
         const checkedBoxes = document.querySelectorAll('#edit-time-periods-container .form-check-input:checked');
         return Array.from(checkedBoxes).map(cb => cb.value);
    }

    async function initializeBuildingFilter(selectId) {
        const selectElement = document.getElementById(selectId);
        try {
            const response = await fetchWithAuth('/api/facilities/buildings');
            if (!response.ok) throw new Error('ê±´ë¬¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            const buildings = result.data;

            selectElement.innerHTML = `<option value="">-- ê±´ë¬¼ ì„ íƒ --</option>`;
            buildings.forEach(b => {
                selectElement.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
        } catch (error) {
            console.error(error);
            selectElement.innerHTML = `<option value="">ì˜¤ë¥˜ ë°œìƒ</option>`;
        }
    }

    async function initializeFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        document.getElementById('username').value = params.get('username') || '';
        if(params.get('startDate')) searchStartDatePicker.setDate(params.get('startDate'), false);
        if(params.get('endDate')) searchEndDatePicker.setDate(params.get('endDate'), false);
        document.getElementById('state').value = params.get('state') || '';

        const buildingId = params.get('buildingId');
        if (buildingId) {
            document.getElementById('building-select').value = buildingId;
            await fetchClassroomsForBuilding(buildingId, 'classroom-select', params.get('classroomId'));
        }
    }

    async function fetchClassroomsForBuilding(buildingId, selectId, selectedClassroomId = null) {
        const classroomSelect = document.getElementById(selectId);
        const isSearchForm = selectId === 'classroom-select';
        classroomSelect.innerHTML = isSearchForm ? '<option value="">ê±´ë¬¼ ë¨¼ì € ì„ íƒ</option>' : '';
        classroomSelect.disabled = true;

        if (!buildingId) return;

        classroomSelect.innerHTML = '<option value="">ê°•ì˜ì‹¤ ë¡œë”© ì¤‘...</option>';
        try {
            const response = await fetchWithAuth(`/api/facilities/buildings/${buildingId}/classrooms`);
            if (!response.ok) throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            const classrooms = result.data;

            classroomSelect.innerHTML = isSearchForm ? '<option value="">ì „ì²´</option>' : '';
            classrooms.forEach(c => {
                classroomSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            classroomSelect.disabled = false;

            if (selectedClassroomId) classroomSelect.value = selectedClassroomId;
        } catch (error) {
            console.error(error);
            classroomSelect.innerHTML = '<option value="">ì˜¤ë¥˜</option>';
        }
    }

    function resetClassroomSelect() {
        const classroomSelect = document.getElementById('classroom-select');
        classroomSelect.innerHTML = '<option value="">ê±´ë¬¼ ë¨¼ì € ì„ íƒ</option>';
        classroomSelect.disabled = true;
    }

    async function openEditModal(reservationId) {
        editModal.show();
        const loader = document.getElementById('modal-loader');
        const form = document.getElementById('edit-reservation-form');
        const errorDiv = document.getElementById('edit-error-message');

        loader.classList.remove('d-none');
        form.classList.add('d-none');
        errorDiv.classList.add('d-none');

        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${reservationId}`);
            if (!response.ok) throw new Error('ì˜ˆì•½ ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            await populateEditModal(result.data);
            form.classList.remove('d-none');
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        } finally {
            loader.classList.add('d-none');
        }
    }

    async function populateEditModal(data) {
        document.getElementById('edit-reservation-id').value = data.reservationId;

        const buildingSelect = document.getElementById('edit-building-select');
        await initializeBuildingFilter('edit-building-select');
        buildingSelect.value = data.buildingId;

        await fetchClassroomsForBuilding(data.buildingId, 'edit-classroom-select', data.classroomId);

        editDatePicker.setDate(data.reservationDate, false);
        await updateEditModalTimes(data.periods);
    }

    async function updateEditModalTimes(preSelectedPeriods = []) {
        const timeContainer = document.getElementById('edit-time-periods-container');
        const classroomId = document.getElementById('edit-classroom-select').value;
        const selectedDate = document.getElementById('edit-reservation-date').value;
        const reservationId = document.getElementById('edit-reservation-id').value;

        if (!classroomId || !selectedDate) {
            timeContainer.innerHTML = '<p class="text-muted mb-0">ê°•ì˜ì‹¤ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
            return;
        }

        timeContainer.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
        try {
            const response = await fetchWithAuth(`/api/reservations/classroom/${classroomId}/reserved-periods?date=${selectedDate}&excludeReservationId=${reservationId}`);
            if (!response.ok) throw new Error('ì˜ˆì•½ ì‹œê°„ ì¡°íšŒ ì‹¤íŒ¨');
            const result = await response.json();
            const reservedPeriodsByOthers = new Set(result.data);
            const allPeriods = ['PERIOD_1', 'PERIOD_2', 'PERIOD_3', 'PERIOD_4', 'PERIOD_5', 'PERIOD_6', 'PERIOD_7', 'PERIOD_8'];

            timeContainer.innerHTML = '';
            allPeriods.forEach((period, index) => {
                const isReserved = reservedPeriodsByOthers.has(period);
                const isChecked = preSelectedPeriods.includes(period);
                timeContainer.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${period}" id="edit-${period}" ${isReserved ? 'disabled' : ''} ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label ${isReserved ? 'text-danger' : ''}" for="edit-${period}">${index + 1}êµì‹œ ${isReserved ? '(ì˜ˆì•½ë¨)' : ''}</label>
                    </div>
                `;
            });
        } catch (error) {
            timeContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
        }
    }

    async function saveReservationChanges() {
        const errorDiv = document.getElementById('edit-error-message');
        errorDiv.classList.add('d-none');

        const reservationId = document.getElementById('edit-reservation-id').value;
        const selectedPeriods = Array.from(document.querySelectorAll('#edit-time-periods-container .form-check-input:checked')).map(cb => cb.value);

        if (selectedPeriods.length === 0) {
            errorDiv.textContent = 'ì‹œê°„ì„ 1ê°œ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.';
            errorDiv.classList.remove('d-none');
            return;
        }

        const payload = {
            classroomId: document.getElementById('edit-classroom-select').value,
            reservationDate: document.getElementById('edit-reservation-date').value,
            periods: selectedPeriods
        };

        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${reservationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            editModal.hide();
            fetchReservations(currentPage);
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        }
    }

    function handleEditCheckboxChange(event) {
        if (event.target.type === 'checkbox') {
            const checkedBoxes = document.querySelectorAll('#edit-time-periods-container .form-check-input:checked');
            if (checkedBoxes.length > 2) {
                alert('ì‹œê°„ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                event.target.checked = false;
            }
        }
    }

    function buildQueryParameters(pageNumber) {
        const formData = new FormData(document.getElementById('search-form'));
        const params = new URLSearchParams(formData);
        params.append('page', pageNumber);
        params.append('size', 10);
        params.append('sort', 'startTime,desc');
        const buildingId = document.getElementById('building-select').value;
        if(buildingId) params.set('buildingId', buildingId);
        return params;
    }

    async function fetchReservations(page) {
        currentPage = page;
        const params = buildQueryParameters(page);
        window.history.replaceState({}, '', `/admin/reservations?${params.toString()}`);

        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> ì˜ˆì•½ ì •ë³´ ë¡œë”© ì¤‘...</td></tr>`;

        try {
            const response = await fetchWithAuth(`/api/admin/reservations?${params.toString()}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
            }
            const result = await response.json();
            renderTable(result.data.content);
            renderPagination(result.data);
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${error.message}</td></tr>`;
        }
    }

    function renderTable(reservations) {
        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = '';
        if (!reservations || reservations.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        reservations.forEach(res => {
            let managementButtons = '<span>-</span>';
            if (res.state === 'ì˜ˆì•½ë¨' || res.state === 'ê´€ë¦¬ìì— ì˜í•´ ë³€ê²½ë¨') {
                managementButtons = `
                    <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${res.id}">ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-outline-danger cancel-btn" data-id="${res.id}">ì·¨ì†Œ</button>
                `;
            }
            const tr = document.createElement('tr');
            // ê° í–‰ì— ì˜ˆì•½ IDë¥¼ ë°ì´í„° ì†ì„±ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ì´ê²ƒì´ ëˆ„ë½ë˜ë©´ í´ë¦­ì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            tr.dataset.reservationId = res.id;
            tr.innerHTML = `
                <td>${res.id}</td>
                <td>${res.username} (${res.loginId})</td>
                <td>${res.classroomName}</td>
                <td>${formatDateTime(res.startTime)}</td>
                <td>${formatDateTime(res.endTime)}</td>
                <td><span class="badge ${getStateBadgeClass(res.state)}">${res.state}</span></td>
                <td>${managementButtons}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const ul = paginationNav.querySelector('.pagination');
        ul.innerHTML = '';
        if (pageData.totalPages <= 1) return;
        ul.innerHTML += `<li class="page-item ${pageData.first ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number - 1}">ì´ì „</a></li>`;
        for (let i = 0; i < pageData.totalPages; i++) {
            ul.innerHTML += `<li class="page-item ${i === pageData.number ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i + 1}</a></li>`;
        }
        ul.innerHTML += `<li class="page-item ${pageData.last ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number + 1}">ë‹¤ìŒ</a></li>`;
    }

    //  í•¨ìˆ˜ ì´ë¦„ì„ handleTableClickìœ¼ë¡œ ë³€ê²½í•˜ê³  ë¡œì§ì„ í™•ì¥í•©ë‹ˆë‹¤.
    function handleTableClick(e) {
        const button = e.target.closest('button');
        const row = e.target.closest('tr');

        // 1. 'ìˆ˜ì •' ë˜ëŠ” 'ì·¨ì†Œ' ë²„íŠ¼ì„ ëˆŒë €ì„ ê²½ìš°
        if (button) {
            e.stopPropagation(); // í–‰ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì¤‘ë³µ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì „íŒŒë¥¼ ë§‰ìŒ
            const reservationId = button.dataset.id;
            if (button.classList.contains('cancel-btn')) {
                if (confirm(`ì˜ˆì•½ ID [${reservationId}] ë¥¼ ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    cancelReservation(reservationId);
                }
            } else if (button.classList.contains('edit-btn')) {
                openEditModal(reservationId);
            }
            return; // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì•„ë˜ ë¡œì§ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        }

        // 2. ë²„íŠ¼ì´ ì•„ë‹Œ í…Œì´ë¸” í–‰ì˜ ë‹¤ë¥¸ ë¶€ë¶„ì„ í´ë¦­í–ˆì„ ê²½ìš°
        if (row && row.dataset.reservationId) {
            toggleHistoryDetail(row, row.dataset.reservationId);
        }
    }

    // ì˜ˆì•½ ì´ë ¥ì„ ë³´ì—¬ì£¼ê±°ë‚˜ ìˆ¨ê¸°ëŠ” í† ê¸€ í•¨ìˆ˜
    async function toggleHistoryDetail(clickedRow, reservationId) {
        const existingDetailRow = document.querySelector(`.history-detail-row[data-reservation-id="${reservationId}"]`);

        // ì´ë¯¸ ì—´ë ¤ìˆëŠ” í–‰ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš°, ë‹«ê³  í•¨ìˆ˜ ì¢…ë£Œ
        if (existingDetailRow) {
            existingDetailRow.remove();
            return;
        }

        // ë‹¤ë¥¸ ì´ë ¥ í–‰ì´ ì—´ë ¤ìˆë‹¤ë©´ ë¨¼ì € ë‹«ê¸°
        const anyOpenDetailRow = document.querySelector('.history-detail-row');
        if (anyOpenDetailRow) {
            anyOpenDetailRow.remove();
        }

        // í…œí”Œë¦¿ì„ ë³µì œí•˜ì—¬ ìƒˆë¡œìš´ ìƒì„¸ ì •ë³´ í–‰ ìƒì„±
        const template = document.getElementById('history-detail-template');
        const detailRow = template.content.cloneNode(true).firstElementChild;
        detailRow.dataset.reservationId = reservationId;
        const contentDiv = detailRow.querySelector('.history-content');
        contentDiv.innerHTML = `
            <div class="d-flex align-items-center justify-content-center p-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>ë³€ê²½ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>
        `;

        // í´ë¦­ëœ í–‰ ë°”ë¡œ ì•„ë˜ì— ìƒì„¸ ì •ë³´ í–‰ ì‚½ì…
        clickedRow.after(detailRow);

        try {
            // ê¸°ì¡´ APIë¥¼ ì¬í™œìš©í•˜ì—¬ ìƒì„¸ ì •ë³´ì™€ ì´ë ¥ì„ í•¨ê»˜ ê°€ì ¸ì˜´
            const response = await fetchWithAuth(`/api/admin/reservations/${reservationId}`);
            if (!response.ok) throw new Error('ì´ë ¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            const result = await response.json();
            const histories = result.data.histories;

            // ë°›ì•„ì˜¨ ë°ì´í„°ë¡œ ì´ë ¥ ëª©ë¡ ë Œë”ë§
            if (histories && histories.length > 0) {
                // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ë°±ì—”ë“œì—ì„œ ì •ë ¬í–ˆì§€ë§Œ, í”„ë¡ íŠ¸ì—ì„œë„ í™•ì¸ì°¨ ì •ë ¬)
                histories.sort((a, b) => new Date(a.changedAt) - new Date(b.changedAt));

                let historyHtml = '<h6 class="mb-3 text-start">ğŸ“– ì˜ˆì•½ ë³€ê²½ ì´ë ¥</h6><ul class="list-group text-start">';
                histories.forEach(h => {
                    historyHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${h.state}</div>
                                <small class="text-muted">
                                    ${h.classroomName} / ${formatDateTime(h.startTime)} ~ ${formatDateTime(h.endTime).split(' ')[1]}
                                </small>
                            </div>
                            <span class="badge bg-secondary rounded-pill">${formatDateTime(h.changedAt)}</span>
                        </li>
                    `;
                });
                historyHtml += '</ul>';
                contentDiv.innerHTML = historyHtml;
            } else {
                contentDiv.innerHTML = '<p class="text-muted text-center mb-0">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        } catch (error) {
            contentDiv.innerHTML = `<p class="text-danger text-center mb-0">${error.message}</p>`;
        }
    }

    function handlePaginationClick(e) {
        e.preventDefault();
        const pageLink = e.target.closest('.page-link');
        if (pageLink && !pageLink.parentElement.classList.contains('disabled')) {
            fetchReservations(parseInt(pageLink.dataset.page));
        }
    }

    async function cancelReservation(id) {
        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${id}/cancel`, { method: 'PATCH' });
            if (!response.ok) throw new Error((await response.json()).message);
            alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            fetchReservations(currentPage);
        } catch (error) {
            alert(`ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    function formatDateTime(isoString) {
        if (!isoString) return '';
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const d = new Date(isoString);
        const yyyy = d.getFullYear();
        const MM = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        const dayName = days[d.getDay()];
        return `${yyyy}.${MM}.${dd} (${dayName}) ${hh}:${mm}`;
    }

    function getStateBadgeClass(state) {
        const states = {
            'ì˜ˆì•½ë¨': 'bg-primary',
            'ì‚¬ìš© ì™„ë£Œ': 'bg-success',
            'ì·¨ì†Œë¨': 'bg-secondary',
            'ê´€ë¦¬ìì— ì˜í•´ ì·¨ì†Œë¨': 'bg-danger',
            'ê´€ë¦¬ìì— ì˜í•´ ë³€ê²½ë¨': 'bg-warning text-dark',
            'ìë™ ì™„ë£Œë¨': 'bg-info text-dark'
        };
        return states[state] || 'bg-dark';
    }
</script>
</body>
</html>