<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>ê´€ë¦¬ì - ì˜ˆì•½ ê´€ë¦¬</title>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">ğŸ“… ì˜ˆì•½ ê´€ë¦¬</h1>
        <a href="/admin/main" class="btn btn-outline-secondary">ê´€ë¦¬ì í™ˆìœ¼ë¡œ</a>
    </div>

    <div class="card mb-4">
        <div class="card-body bg-light">
            <form id="search-form" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="username" class="form-label">ì˜ˆì•½ìëª…</label>
                    <input type="text" id="username" name="username" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="building-select" class="form-label">ê±´ë¬¼</label>
                    <select id="building-select" class="form-select">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="classroom-select" class="form-label">ê°•ì˜ì‹¤</label>
                    <select id="classroom-select" name="classroomId" class="form-select" disabled>
                        <option value="">ê±´ë¬¼ ë¨¼ì € ì„ íƒ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="state" class="form-label">ìƒíƒœ</label>
                    <select id="state" name="state" class="form-select">
                        <option value="">ì „ì²´</option>
                        <!-- ThymeleafëŠ” Enumì˜ ì˜ë¬¸ ì´ë¦„ì„ ê°’ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤ -->
                        <option th:each="s : ${T(com.example.classroom_reservation_system.reservation.entity.ReservationState).values()}"
                                th:value="${s.name()}" th:text="${s.name()}"></option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" id="reset-btn" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                    <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
                </div>
            </form>
        </div>
    </div>


    <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>ì˜ˆì•½ì (ID)</th>
                <th>ê°•ì˜ì‹¤</th>
                <th>ì˜ˆì•½ ì‹œì‘</th>
                <th>ì˜ˆì•½ ì¢…ë£Œ</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="reservation-table-body">

            </tbody>
        </table>
    </div>

    <nav id="pagination-nav">
        <ul class="pagination justify-content-center">

        </ul>
    </nav>
</div>


<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">

</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>
<script src="/js/admin-auth.js"></script>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 0;
    let startDatePicker, endDatePicker; // flatpickr ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

    document.addEventListener('DOMContentLoaded', function () {
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const searchForm = document.getElementById('search-form');
        const resetBtn = document.getElementById('reset-btn');
        const tableBody = document.getElementById('reservation-table-body');
        const paginationNav = document.getElementById('pagination-nav');
        const buildingSelect = document.getElementById('building-select');

        //  flatpickr ì´ˆê¸°í™”
        startDatePicker = flatpickr('#startDate', {
            altFormat: "Y-m-d (D)",
            dateFormat: "Y-m-d",
            locale: "ko"
        });
        endDatePicker = flatpickr('#endDate', {
            altFormat: "Y-m-d (D)",
            dateFormat: "Y-m-d",
            locale: "ko"
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        initializePage();

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            fetchReservations(0);
        });

        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            startDatePicker.clear(); // flatpickr ì´ˆê¸°í™”
            endDatePicker.clear();   // flatpickr ì´ˆê¸°í™”
            resetClassroomSelect();
            window.history.replaceState({}, '', '/admin/reservations');
            fetchReservations(0);
        });

        buildingSelect.addEventListener('change', () => {
            const selectedBuildingId = buildingSelect.value;
            if (selectedBuildingId) {
                fetchClassroomsForBuilding(selectedBuildingId);
            } else {
                resetClassroomSelect();
            }
        });

        tableBody.addEventListener('click', handleTableButtonClick);
        paginationNav.addEventListener('click', handlePaginationClick);
    });

    // --- í•¨ìˆ˜ ì„ ì–¸ë¶€ ---

    async function initializePage() {
        await initializeBuildingFilter(); // 1. ê±´ë¬¼ í•„í„° ë¨¼ì € ì´ˆê¸°í™”
        await initializeFormFromUrl();      // 2. URL íŒŒë¼ë¯¸í„°ë¡œ í¼ ì±„ìš°ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        fetchReservations(parseInt(urlParams.get('page')) || 0); // 3. ë°ì´í„° ë¡œë“œ
    }

    async function initializeBuildingFilter() {
        try {
            const response = await fetchWithAuth('/api/facilities/buildings');
            if (!response.ok) throw new Error('ê±´ë¬¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            const buildings = result.data;
            const buildingSelect = document.getElementById('building-select');
            buildings.forEach(b => {
                buildingSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
        } catch (error) {
            console.error(error);
        }
    }

    async function initializeFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        document.getElementById('username').value = params.get('username') || '';
        if(params.get('startDate')) startDatePicker.setDate(params.get('startDate'), false);
        if(params.get('endDate')) endDatePicker.setDate(params.get('endDate'), false);
        document.getElementById('state').value = params.get('state') || '';

        const buildingId = params.get('buildingId');
        if (buildingId) {
            const buildingSelect = document.getElementById('building-select');
            buildingSelect.value = buildingId;
            // ê±´ë¬¼ì´ ì„ íƒë˜ì—ˆìœ¼ë©´, í•´ë‹¹ ê±´ë¬¼ì˜ ê°•ì˜ì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ì„œ ì±„ì›€
            await fetchClassroomsForBuilding(buildingId, params.get('classroomId'));
        }
    }

    async function fetchClassroomsForBuilding(buildingId, selectedClassroomId = null) {
        const classroomSelect = document.getElementById('classroom-select');
        resetClassroomSelect();
        classroomSelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';

        try {
            const response = await fetchWithAuth(`/api/facilities/buildings/${buildingId}/classrooms`);
            if (!response.ok) throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            const classrooms = result.data;

            classroomSelect.innerHTML = '<option value="">ì „ì²´</option>';
            classrooms.forEach(c => {
                classroomSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            classroomSelect.disabled = false;

            if (selectedClassroomId) {
                classroomSelect.value = selectedClassroomId;
            }
        } catch (error) {
            console.error(error);
            classroomSelect.innerHTML = '<option value="">ì˜¤ë¥˜</option>';
        }
    }

    function resetClassroomSelect() {
        const classroomSelect = document.getElementById('classroom-select');
        classroomSelect.innerHTML = '<option value="">ê±´ë¬¼ ë¨¼ì € ì„ íƒ</option>';
        classroomSelect.disabled = true;
    }

    function buildQueryParameters(pageNumber) {
        const formData = new FormData(document.getElementById('search-form'));
        const params = new URLSearchParams(formData);
        params.append('page', pageNumber);
        params.append('size', 10);
        params.append('sort', 'startTime,desc');
        return params;
    }

    async function fetchReservations(page) {
        currentPage = page;
        const params = buildQueryParameters(page);

        // URL ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ buildingIdë„ í•¨ê»˜ ì €ì¥
        const urlParams = new URLSearchParams(params);
        const buildingId = document.getElementById('building-select').value;
        // buildingIdëŠ” formì˜ name ì†ì„±ì´ ì—†ìœ¼ë¯€ë¡œ FormDataì— í¬í•¨ë˜ì§€ ì•ŠìŒ. ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€.
        if(buildingId) {
            urlParams.set('buildingId', buildingId);
        } else {
            urlParams.delete('buildingId'); // ê°’ì´ ì—†ìœ¼ë©´ íŒŒë¼ë¯¸í„°ì—ì„œ ì œê±°
        }
        window.history.replaceState({}, '', `/admin/reservations?${urlParams.toString()}`);

        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> ì˜ˆì•½ ì •ë³´ ë¡œë”© ì¤‘...</td></tr>`;

        try {
            const response = await fetchWithAuth(`/api/admin/reservations?${params.toString()}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
            }
            const result = await response.json();
            renderTable(result.data.content);
            renderPagination(result.data);
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${error.message}</td></tr>`;
        }
    }

    function renderTable(reservations) {
        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = '';
        if (!reservations || reservations.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        reservations.forEach(res => {
            let managementButtons = '<span>-</span>';
            if (res.state === 'RESERVED') {
                managementButtons = `
                    <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${res.id}">ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-outline-danger cancel-btn" data-id="${res.id}">ì·¨ì†Œ</button>
                `;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${res.id}</td>
                <td>${res.username} (${res.loginId})</td>
                <td>${res.classroomName}</td>
                <td>${formatDateTime(res.startTime)}</td>
                <td>${formatDateTime(res.endTime)}</td>
                <td><span class="badge ${getStateBadgeClass(res.state)}">${getStateName(res.state)}</span></td>
                <td>${managementButtons}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const ul = paginationNav.querySelector('.pagination');
        ul.innerHTML = '';
        if (pageData.totalPages <= 1) return;
        ul.innerHTML += `<li class="page-item ${pageData.first ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number - 1}">ì´ì „</a></li>`;
        for (let i = 0; i < pageData.totalPages; i++) {
            ul.innerHTML += `<li class="page-item ${i === pageData.number ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i + 1}</a></li>`;
        }
        ul.innerHTML += `<li class="page-item ${pageData.last ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number + 1}">ë‹¤ìŒ</a></li>`;
    }

    function handleTableButtonClick(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const reservationId = button.dataset.id;
        if (button.classList.contains('cancel-btn')) {
            if (confirm(`ì˜ˆì•½ ID [${reservationId}] ë¥¼ ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                cancelReservation(reservationId);
            }
        } else if (button.classList.contains('edit-btn')) {
            openEditModal(reservationId);
        }
    }

    function handlePaginationClick(e) {
        e.preventDefault();
        const pageLink = e.target.closest('.page-link');
        if (pageLink && !pageLink.parentElement.classList.contains('disabled')) {
            fetchReservations(parseInt(pageLink.dataset.page));
        }
    }

    async function cancelReservation(id) {
        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${id}/cancel`, { method: 'PATCH' });
            if (!response.ok) throw new Error((await response.json()).message);
            alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            fetchReservations(currentPage);
        } catch (error) {
            alert(`ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    function openEditModal(id) {
        alert(`ID ${id} ì˜ˆì•½ ìˆ˜ì • ê¸°ëŠ¥ì€ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.`);
    }

    function formatDateTime(isoString) {
    if (!isoString) return '';

    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']; // ìš”ì¼ ë°°ì—´
    const d = new Date(isoString);

    const yyyy = d.getFullYear();
    const MM = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    const dayName = days[d.getDay()]; // ìš”ì¼ ê°€ì ¸ì˜¤ê¸°

    return `${yyyy}.${MM}.${dd} (${dayName}) ${hh}:${mm}`;
    }

    function getStateBadgeClass(state) {
        const states = { 'RESERVED': 'bg-primary', 'CANCELED': 'bg-secondary', 'COMPLETED': 'bg-success', 'CANCELED_BY_ADMIN': 'bg-danger', 'MODIFIED_BY_ADMIN': 'bg-warning text-dark', 'COMPLETED_BY_SYSTEM': 'bg-info text-dark' };
        return states[state] || 'bg-dark';
    }

    // ëª¨ë“  ìƒíƒœì— ëŒ€í•œ í•œê¸€ ì´ë¦„ì„ ì—¬ê¸°ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
    function getStateName(state) {
        const stateMap = {
            RESERVED: 'ì˜ˆì•½ë¨',
            COMPLETED: 'ì™„ë£Œë¨',
            CANCELED: 'ì·¨ì†Œë¨',
        };
        return stateMap[state] || state; // ë§¤í•‘ë˜ëŠ” ê°’ì´ ì—†ìœ¼ë©´ ì›ë˜ ì˜ë¬¸ ì´ë¦„ ë°˜í™˜
    }
</script>
</script>
</body>
</html>