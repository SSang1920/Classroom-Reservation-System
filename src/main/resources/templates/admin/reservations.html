<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>관리자 - 예약 관리</title>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">📅 예약 관리</h1>
        <a href="/admin/main" class="btn btn-outline-secondary">관리자 홈으로</a>
    </div>

    <div class="card mb-4">
        <div class="card-body bg-light">
            <form id="search-form" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="username" class="form-label">예약자명</label>
                    <input type="text" id="username" name="username" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="building-select" class="form-label">건물</label>
                    <select id="building-select" class="form-select">
                        <option value="">전체</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="classroom-select" class="form-label">강의실</label>
                    <select id="classroom-select" name="classroomId" class="form-select" disabled>
                        <option value="">건물 먼저 선택</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">시작일</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">종료일</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="state" class="form-label">상태</label>
                    <select id="state" name="state" class="form-select">
                        <option value="">전체</option>
                        <option th:each="s : ${T(com.example.classroom_reservation_system.reservation.entity.ReservationState).values()}"
                                th:value="${s.name()}" th:text="${s.description}"></option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" id="reset-btn" class="btn btn-secondary">초기화</button>
                    <button type="submit" class="btn btn-primary">검색</button>
                </div>
            </form>
        </div>
    </div>


    <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>예약자 (ID)</th>
                <th>강의실</th>
                <th>예약 시작</th>
                <th>예약 종료</th>
                <th>상태</th>
                <th>관리</th>
            </tr>
            </thead>
            <tbody id="reservation-table-body">
            <!-- 예약 목록이 여기에 동적으로 채워집니다. -->
            </tbody>
        </table>
    </div>

    <nav id="pagination-nav">
        <ul class="pagination justify-content-center">
            <!-- 페이지네이션이 여기에 동적으로 채워집니다. -->
        </ul>
    </nav>
</div>


<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">📅 예약 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 모달 로딩 스피너 -->
                <div id="modal-loader" class="text-center d-none p-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">예약 정보를 불러오는 중입니다...</p>
                </div>

                <!-- 모달 폼 -->
                <form id="edit-reservation-form" class="d-none">
                    <input type="hidden" id="edit-reservation-id">

                    <div class="mb-3">
                        <label for="edit-building-select" class="form-label">건물</label>
                        <select class="form-select" id="edit-building-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="edit-classroom-select" class="form-label">강의실</label>
                        <select class="form-select" id="edit-classroom-select" name="classroomId" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="edit-reservation-date" class="form-label">날짜</label>
                        <input type="text" class="form-control" id="edit-reservation-date" name="reservationDate" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">시간(교시) 선택</label>
                        <small class="form-text text-muted d-block mb-2">최대 2개까지 선택 가능합니다.</small>
                        <div id="edit-time-periods-container" class="border p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                            <!-- 시간표가 여기에 동적으로 생성됩니다. -->
                        </div>
                    </div>

                    <div id="edit-error-message" class="alert alert-danger d-none" role="alert"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="save-changes-btn">변경사항 저장</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>
<script src="/js/admin-auth.js"></script>

<script>
    // 전역 변수
    let currentPage = 0;
    let searchStartDatePicker, searchEndDatePicker; // 검색용 flatpickr
    let editDatePicker; // 수정 모달용 flatpickr
    let editModal; // 수정 모달 인스턴스

    document.addEventListener('DOMContentLoaded', function () {
        // DOM 요소 가져오기
        const searchForm = document.getElementById('search-form');
        const resetBtn = document.getElementById('reset-btn');
        const tableBody = document.getElementById('reservation-table-body');
        const paginationNav = document.getElementById('pagination-nav');
        const buildingSelect = document.getElementById('building-select');
        editModal = new bootstrap.Modal(document.getElementById('editReservationModal'));

        // flatpickr 초기화
        searchStartDatePicker = flatpickr('#startDate', { altFormat: "Y-m-d", dateFormat: "Y-m-d", locale: "ko" });
        searchEndDatePicker = flatpickr('#endDate', { altFormat: "Y-m-d", dateFormat: "Y-m-d", locale: "ko" });
        editDatePicker = flatpickr('#edit-reservation-date', {
            altFormat: "Y-m-d", dateFormat: "Y-m-d", locale: "ko", minDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                const currentSelections = getSelectedPeriodsFromModal();
                updateEditModalTimes(currentSelections);
            }
        });

        // 페이지 로드 시 초기화 함수 호출
        initializePage();

        // --- 이벤트 리스너 등록 ---
        searchForm.addEventListener('submit', (e) => { e.preventDefault(); fetchReservations(0); });
        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            searchStartDatePicker.clear();
            searchEndDatePicker.clear();
            resetClassroomSelect();
            window.history.replaceState({}, '', '/admin/reservations');
            fetchReservations(0);
        });
        buildingSelect.addEventListener('change', () => {
            const selectedBuildingId = buildingSelect.value;
            fetchClassroomsForBuilding(selectedBuildingId, 'classroom-select');
        });
        tableBody.addEventListener('click', handleTableButtonClick);
        paginationNav.addEventListener('click', handlePaginationClick);

        // 수정 모달 이벤트 리스너
        document.getElementById('save-changes-btn').addEventListener('click', saveReservationChanges);
        document.getElementById('edit-time-periods-container').addEventListener('change', handleEditCheckboxChange);
        document.getElementById('edit-building-select').addEventListener('change', (e) => {
            fetchClassroomsForBuilding(e.target.value, 'edit-classroom-select');
        });
        document.getElementById('edit-classroom-select').addEventListener('change', () => {
             const currentSelections = getSelectedPeriodsFromModal();
             updateEditModalTimes(currentSelections);
         });
    });

    // --- 함수 선언부 ---

    async function initializePage() {
        await initializeBuildingFilter('building-select');
        await initializeFormFromUrl();
        const urlParams = new URLSearchParams(window.location.search);
        fetchReservations(parseInt(urlParams.get('page')) || 0);
    }
    //  현재 모델에서 선택된 교시 목록을 가져오는 헬퍼 함수
     function getSelectedPeriodsFromModal() {
         const checkedBoxes = document.querySelectorAll('#edit-time-periods-container .form-check-input:checked');
         return Array.from(checkedBoxes).map(cb => cb.value);
     }

    //  selectId를 받아 검색폼과 수정모달에서 재사용
    async function initializeBuildingFilter(selectId) {
        const selectElement = document.getElementById(selectId);
        try {
            const response = await fetchWithAuth('/api/facilities/buildings');
            if (!response.ok) throw new Error('건물 목록 로딩 실패');
            const result = await response.json();
            const buildings = result.data;

            selectElement.innerHTML = `<option value="">-- 건물 선택 --</option>`;
            buildings.forEach(b => {
                selectElement.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
        } catch (error) {
            console.error(error);
            selectElement.innerHTML = `<option value="">오류 발생</option>`;
        }
    }

    async function initializeFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        document.getElementById('username').value = params.get('username') || '';
        if(params.get('startDate')) searchStartDatePicker.setDate(params.get('startDate'), false);
        if(params.get('endDate')) searchEndDatePicker.setDate(params.get('endDate'), false);
        document.getElementById('state').value = params.get('state') || '';

        const buildingId = params.get('buildingId');
        if (buildingId) {
            document.getElementById('building-select').value = buildingId;
            await fetchClassroomsForBuilding(buildingId, 'classroom-select', params.get('classroomId'));
        }
    }

    //  selectId와 selectedClassroomId를 받아 재사용
    async function fetchClassroomsForBuilding(buildingId, selectId, selectedClassroomId = null) {
        const classroomSelect = document.getElementById(selectId);
        const isSearchForm = selectId === 'classroom-select';
        classroomSelect.innerHTML = isSearchForm ? '<option value="">건물 먼저 선택</option>' : '';
        classroomSelect.disabled = true;

        if (!buildingId) return;

        classroomSelect.innerHTML = '<option value="">강의실 로딩 중...</option>';
        try {
            const response = await fetchWithAuth(`/api/facilities/buildings/${buildingId}/classrooms`);
            if (!response.ok) throw new Error('강의실 목록 로딩 실패');
            const result = await response.json();
            const classrooms = result.data;

            classroomSelect.innerHTML = isSearchForm ? '<option value="">전체</option>' : '';
            classrooms.forEach(c => {
                classroomSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            classroomSelect.disabled = false;

            if (selectedClassroomId) classroomSelect.value = selectedClassroomId;
        } catch (error) {
            console.error(error);
            classroomSelect.innerHTML = '<option value="">오류</option>';
        }
    }

    function resetClassroomSelect() {
        const classroomSelect = document.getElementById('classroom-select');
        classroomSelect.innerHTML = '<option value="">건물 먼저 선택</option>';
        classroomSelect.disabled = true;
    }

    //  수정 모델 열기
    async function openEditModal(reservationId) {
        editModal.show();
        const loader = document.getElementById('modal-loader');
        const form = document.getElementById('edit-reservation-form');
        const errorDiv = document.getElementById('edit-error-message');

        loader.classList.remove('d-none');
        form.classList.add('d-none');
        errorDiv.classList.add('d-none');

        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${reservationId}`);
            if (!response.ok) throw new Error('예약 정보 로딩 실패');
            const result = await response.json();
            await populateEditModal(result.data);
            form.classList.remove('d-none');
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        } finally {
            loader.classList.add('d-none');
        }
    }

    //  모델 폼에 데이터 채우기
    async function populateEditModal(data) {
        document.getElementById('edit-reservation-id').value = data.reservationId;

        const buildingSelect = document.getElementById('edit-building-select');
        await initializeBuildingFilter('edit-building-select');
        buildingSelect.value = data.buildingId;

        await fetchClassroomsForBuilding(data.buildingId, 'edit-classroom-select', data.classroomId);

        editDatePicker.setDate(data.reservationDate, false);
        await updateEditModalTimes(data.periods);
    }

    //  수정 모델의 시간표 업데이트
    async function updateEditModalTimes(preSelectedPeriods = []) {
        const timeContainer = document.getElementById('edit-time-periods-container');
        const classroomId = document.getElementById('edit-classroom-select').value;
        const selectedDate = document.getElementById('edit-reservation-date').value;
        const reservationId = document.getElementById('edit-reservation-id').value;

        if (!classroomId || !selectedDate) {
            timeContainer.innerHTML = '<p class="text-muted mb-0">강의실과 날짜를 선택해주세요.</p>';
            return;
        }

        timeContainer.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
        try {
            const response = await fetchWithAuth(`/api/reservations/classroom/${classroomId}/reserved-periods?date=${selectedDate}&excludeReservationId=${reservationId}`);
            if (!response.ok) throw new Error('예약 시간 조회 실패');
            const result = await response.json();
            const reservedPeriodsByOthers = new Set(result.data);
            const allPeriods = ['PERIOD_1', 'PERIOD_2', 'PERIOD_3', 'PERIOD_4', 'PERIOD_5', 'PERIOD_6', 'PERIOD_7', 'PERIOD_8'];

            timeContainer.innerHTML = '';
            allPeriods.forEach((period, index) => {
                const isReserved = reservedPeriodsByOthers.has(period);
                const isChecked = preSelectedPeriods.includes(period);
                timeContainer.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${period}" id="edit-${period}" ${isReserved ? 'disabled' : ''} ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label ${isReserved ? 'text-danger' : ''}" for="edit-${period}">${index + 1}교시 ${isReserved ? '(예약됨)' : ''}</label>
                    </div>
                `;
            });
        } catch (error) {
            timeContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
        }
    }

    // 수정 사항 저장
    async function saveReservationChanges() {
        const errorDiv = document.getElementById('edit-error-message');
        errorDiv.classList.add('d-none');

        const reservationId = document.getElementById('edit-reservation-id').value;
        const selectedPeriods = Array.from(document.querySelectorAll('#edit-time-periods-container .form-check-input:checked')).map(cb => cb.value);

        if (selectedPeriods.length === 0) {
            errorDiv.textContent = '시간을 1개 이상 선택해야 합니다.';
            errorDiv.classList.remove('d-none');
            return;
        }

        const payload = {
            classroomId: document.getElementById('edit-classroom-select').value,
            reservationDate: document.getElementById('edit-reservation-date').value,
            periods: selectedPeriods
        };

        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${reservationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            alert('예약이 성공적으로 수정되었습니다.');
            editModal.hide();
            fetchReservations(currentPage);
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        }
    }

    //  수정 모델 체크박스 개수 제한
    function handleEditCheckboxChange(event) {
        if (event.target.type === 'checkbox') {
            const checkedBoxes = document.querySelectorAll('#edit-time-periods-container .form-check-input:checked');
            if (checkedBoxes.length > 2) {
                alert('시간은 최대 2개까지만 선택할 수 있습니다.');
                event.target.checked = false;
            }
        }
    }

    // --- 기존 함수들 (검색, 페이징, 취소 등) ---
    function buildQueryParameters(pageNumber) {
        const formData = new FormData(document.getElementById('search-form'));
        const params = new URLSearchParams(formData);
        params.append('page', pageNumber);
        params.append('size', 10);
        params.append('sort', 'startTime,desc');
        // buildingId는 form의 name 속성이 없으므로 수동으로 추가
        const buildingId = document.getElementById('building-select').value;
        if(buildingId) params.set('buildingId', buildingId);
        return params;
    }

    async function fetchReservations(page) {
        currentPage = page;
        const params = buildQueryParameters(page);
        window.history.replaceState({}, '', `/admin/reservations?${params.toString()}`);

        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> 예약 정보 로딩 중...</td></tr>`;

        try {
            const response = await fetchWithAuth(`/api/admin/reservations?${params.toString()}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '데이터 로딩 실패');
            }
            const result = await response.json();
            renderTable(result.data.content);
            renderPagination(result.data);
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${error.message}</td></tr>`;
        }
    }

    function renderTable(reservations) {
        const tableBody = document.getElementById('reservation-table-body');
        tableBody.innerHTML = '';
        if (!reservations || reservations.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">검색 결과가 없습니다.</td></tr>';
            return;
        }
        reservations.forEach(res => {
            let managementButtons = '<span>-</span>';
            if (res.state === '예약됨' || res.state === '관리자에 의해 변경됨') {
                managementButtons = `
                    <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${res.id}">수정</button>
                    <button class="btn btn-sm btn-outline-danger cancel-btn" data-id="${res.id}">취소</button>
                `;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${res.id}</td>
                <td>${res.username} (${res.loginId})</td>
                <td>${res.classroomName}</td>
                <td>${formatDateTime(res.startTime)}</td>
                <td>${formatDateTime(res.endTime)}</td>
                <td><span class="badge ${getStateBadgeClass(res.state)}">${res.state}</span></td>
                <td>${managementButtons}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const ul = paginationNav.querySelector('.pagination');
        ul.innerHTML = '';
        if (pageData.totalPages <= 1) return;
        ul.innerHTML += `<li class="page-item ${pageData.first ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number - 1}">이전</a></li>`;
        for (let i = 0; i < pageData.totalPages; i++) {
            ul.innerHTML += `<li class="page-item ${i === pageData.number ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i + 1}</a></li>`;
        }
        ul.innerHTML += `<li class="page-item ${pageData.last ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number + 1}">다음</a></li>`;
    }

    function handleTableButtonClick(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const reservationId = button.dataset.id;
        if (button.classList.contains('cancel-btn')) {
            if (confirm(`예약 ID [${reservationId}] 를 정말로 취소하시겠습니까?`)) {
                cancelReservation(reservationId);
            }
        } else if (button.classList.contains('edit-btn')) {
            openEditModal(reservationId);
        }
    }

    function handlePaginationClick(e) {
        e.preventDefault();
        const pageLink = e.target.closest('.page-link');
        if (pageLink && !pageLink.parentElement.classList.contains('disabled')) {
            fetchReservations(parseInt(pageLink.dataset.page));
        }
    }

    async function cancelReservation(id) {
        try {
            const response = await fetchWithAuth(`/api/admin/reservations/${id}/cancel`, { method: 'PATCH' });
            if (!response.ok) throw new Error((await response.json()).message);
            alert('예약이 성공적으로 취소되었습니다.');
            fetchReservations(currentPage);
        } catch (error) {
            alert(`취소 실패: ${error.message}`);
        }
    }

    function formatDateTime(isoString) {
        if (!isoString) return '';
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        const d = new Date(isoString);
        const yyyy = d.getFullYear();
        const MM = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        const dayName = days[d.getDay()];
        return `${yyyy}.${MM}.${dd} (${dayName}) ${hh}:${mm}`;
    }

    function getStateBadgeClass(state) {
        const states = {
            '예약됨': 'bg-primary',
            '사용 완료': 'bg-success',
            '사용자 취소': 'bg-secondary',
            '관리자에 의해 취소됨': 'bg-danger',
            '관리자에 의해 변경됨': 'bg-warning text-dark',
            '자동 완료됨': 'bg-info text-dark'
        };
        return states[state] || 'bg-dark';
    }
</script>
</body>
</html>