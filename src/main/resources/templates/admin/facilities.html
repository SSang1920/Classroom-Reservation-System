<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>ê±´ë¬¼ & ê°•ì˜ì‹¤ ê´€ë¦¬</title>
    <style>
        .list-group-item.active {
            z-index: 2;
            color: #fff;
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .building-item, .action-icon {
            cursor: pointer;
        }
    </style>
</head>
<body>
<!-- ìƒë‹¨ë°” -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container-fluid">
    <div class="row">
        <!-- ê´€ë¦¬ì ì‚¬ì´ë“œë°” -->
        <nav th:replace="~{fragments/admin-sidebar :: admin-sidebar}"></nav>

        <main class="admin-content px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">ğŸ¢ ê±´ë¬¼ & ê°•ì˜ì‹¤ ê´€ë¦¬</h1>
            </div>

            <div class="row">
                <!-- ê±´ë¬¼ ëª©ë¡ -->
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">ê±´ë¬¼ ëª©ë¡</h5>
                            <button class="btn btn-primary btn-sm" id="add-building-btn">
                                <i class="bi bi-plus-lg"></i> ìƒˆ ê±´ë¬¼ ì¶”ê°€
                            </button>
                        </div>
                        <div id="building-list" class="list-group list-group-flush" style="max-height: 70vh; overflow-y: auto;">
                            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
                            <div class="list-group-item text-center p-5" id="building-loader">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê°•ì˜ì‹¤ ëª©ë¡ ì„¹ì…˜ -->
                <div class="col-md-8">
                    <div class="card shadow-sm" id="classroom-section">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" id="classroom-list-title">ê°•ì˜ì‹¤ ëª©ë¡</h5>
                            <button class="btn btn-primary btn-sm d-none" id="add-classroom-btn">
                                <i class="bi bi-plus-lg"></i> ìƒˆ ê°•ì˜ì‹¤ ì¶”ê°€
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="classroom-placeholder" class="text-center text-muted p-5">
                                <i class="bi bi-arrow-left-square-fill fs-1"></i>
                                <p class="mt-2">ì™¼ìª½ì—ì„œ ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                            </div>
                            <div id="classroom-content" class="d-none">
                                <div id="classroom-loader" class="text-center p-5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="classroom-table-container" class="table-responsive">
                                    <!-- ê°•ì˜ì‹¤ í…Œì´ë¸” JavaScript ë Œë”ë§ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- ê±´ë¬¼ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="building-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="building-form" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="building-modal-title">ìƒˆ ê±´ë¬¼ ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="building-id">
                    <div class="mb-3">
                        <label for="building-name" class="form-label">ê±´ë¬¼ ì´ë¦„</label>
                        <input type="text" class="form-control" id="building-name" required>
                        <div class="invalid-feedback">ê±´ë¬¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="submit" class="btn btn-primary" id="building-save-btn">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ê°•ì˜ì‹¤ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="classroom-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="classroom-form" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="classroom-modal-title">ìƒˆ ê°•ì˜ì‹¤ ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="classroom-id">
                    <div class="mb-3">
                        <label for="classroom-name" class="form-label">ê°•ì˜ì‹¤ ì´ë¦„ (ì˜ˆ: 101í˜¸)</label>
                        <input type="text" class="form-control" id="classroom-name" required>
                        <div class="invalid-feedback">ê°•ì˜ì‹¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div class="mb-3">
                        <label for="classroom-capacity" class="form-label">ìˆ˜ìš© ì¸ì›</label>
                        <input type="number" class="form-control" id="classroom-capacity" required min="1">
                        <div class="invalid-feedback">1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div class="mb-3">
                        <label for="classroom-info" class="form-label">ë¹„ê³  (ì„ íƒì‚¬í•­)</label>
                        <textarea class="form-control" id="classroom-info" rows="3" placeholder="ë¹” í”„ë¡œì í„°, í™”ì´íŠ¸ë³´ë“œ ë“±"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="submit" class="btn btn-primary" id="classroom-save-btn">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ê³µìš© ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- ìƒë‹¨ë°” ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<!-- ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ì œì–´ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:src="@{/js/admin-auth.js}"></script>

<script>
    let buildingModal, classroomModal;
    let selectedBuildingId = null;

    document.addEventListener('DOMContentLoaded', function() {
        // ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
        buildingModal = new bootstrap.Modal(document.getElementById('building-modal'));
        classroomModal = new bootstrap.Modal(document.getElementById('classroom-modal'));

        // ì´ˆê¸° ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
        loadBuildings();

        // ìƒˆ ê±´ë¬¼ ì¶”ê°€ ë²„íŠ¼
        document.getElementById('add-building-btn').addEventListener('click', () => openBuildingModal());

        // ìƒˆ ê°•ì˜ì‹¤ ì¶”ê°€ ë²„íŠ¼
        document.getElementById('add-classroom-btn').addEventListener('click', () => openClassroomModal());

        // ê±´ë¬¼ ëª©ë¡ í´ë¦­
        document.getElementById('building-list').addEventListener('click', handleBuildingListClick);

        // ê°•ì˜ì‹¤ í…Œì´ë¸” í´ë¦­
        document.getElementById('classroom-table-container').addEventListener('click', handleClassroomTableClick);

        // ëª¨ë‹¬ í¼ ì œì¶œ
        document.getElementById('building-form').addEventListener('submit', handleBuildingFormSubmit);
        document.getElementById('classroom-form').addEventListener('submit', handleClassroomFormSubmit);
    });

    // ê±´ë¬¼ ëª©ë¡ ë¡œë“œ
    async function loadBuildings() {
        const listContainer = document.getElementById('building-list');
        const loader = document.getElementById('building-loader');
        loader.classList.remove('d-none');
        listContainer.innerHTML = '';
        listContainer.appendChild(loader);

        try {
            const response = await fetchWithAuth('/api/admin/facilities/buildings');
            if (!response.ok) throw new Error('ê±´ë¬¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');

            const result = await response.json();
            renderBuildings(result.data);

        } catch (error) {
            console.error(error);
            listContainer.innerHTML = '<div class="list-group-item text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        } finally {
            loader.classList.add('d-none');
        }
    }

    function renderBuildings(buildings) {
        const listContainer = document.getElementById('building-list');
        listContainer.innerHTML = '';

        if (!buildings || buildings.length === 0) {
            listContainer.innerHTML = '<div class="list-group-item text-muted">ë“±ë¡ëœ ê±´ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        buildings.forEach(building => {
            const item = `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center building-item"
                    data-id="${building.id}" data-name="${escapeHtml(building.name)}">
                    <span>${escapeHtml(building.name)}</span>
                    <div>
                        <i class="bi bi-pencil-square text-primary me-2 action-icon" data-action="edit-building" title="ìˆ˜ì •"></i>
                        <i class="bi bi-trash-fill text-danger action-icon" data-action="delete-building" title="ì‚­ì œ"></i>
                    </div>
                </div>
            `;
            listContainer.insertAdjacentHTML('beforeend', item);
        });
    }

    // ê±´ë¬¼ ëª©ë¡ í´ë¦­
    function handleBuildingListClick(event) {
        const buildingItem = event.target.closest('.building-item');
        if (!buildingItem) return;

        const actionIcon = event.target.closest('.action-icon');
        const buildingId = buildingItem.dataset.id;
        const buildingName = buildingItem.dataset.name;

        if (actionIcon) {
            const action = actionIcon.dataset.action;
            if (action === 'edit-building') {
                openBuildingModal({ id: buildingId, name: buildingName });
            } else if (action === 'delete-building') {
                handleDeleteBuilding(buildingId, buildingName);
            }
        } else {
            selectBuilding(buildingItem);
        }
    }

    function selectBuilding(buildingItem) {
        selectedBuildingId = buildingItem.dataset.id;

        document.querySelectorAll('#building-list .building-item').forEach(item => item.classList.remove('active'));
        buildingItem.classList.add('active');

        document.getElementById('classroom-list-title').textContent = `${buildingItem.dataset.name} ê°•ì˜ì‹¤ ëª©ë¡`;
        document.getElementById('add-classroom-btn').classList.remove('d-none');
        document.getElementById('classroom-placeholder').classList.add('d-none');
        document.getElementById('classroom-content').classList.remove('d-none');

        loadClassrooms(selectedBuildingId);
    }

    async function handleDeleteBuilding(buildingId, buildingName) {
        if (!confirm(`'${buildingName}' ê±´ë¬¼ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ê±´ë¬¼ì˜ ëª¨ë“  ê°•ì˜ì‹¤ê³¼ ì˜ˆì•½ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

        try {
            const response = await fetchWithAuth(`/api/admin/facilities/buildings/${buildingId}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ê±´ë¬¼ ì‚­ì œ ì‹¤íŒ¨');
            }
            alert('ê±´ë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            if (selectedBuildingId === buildingId) {
                resetClassroomView();
            }
            loadBuildings();

        } catch (error) {
            console.error(error);
            alert(`ê±´ë¬¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    function openBuildingModal(building = null) {
        const form = document.getElementById('building-form');
        form.classList.remove('was-validated');
        form.reset();

        const title = document.getElementById('building-modal-title');
        if (building) {
            title.textContent = 'ê±´ë¬¼ ì •ë³´ ìˆ˜ì •';
            document.getElementById('building-id').value = building.id;
            document.getElementById('building-name').value = building.name;
        } else {
            title.textContent = 'ìƒˆ ê±´ë¬¼ ì¶”ê°€';
            document.getElementById('building-id').value = '';
        }
        buildingModal.show();
    }

    async function handleBuildingFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const buildingId = document.getElementById('building-id').value;
        const buildingName = document.getElementById('building-name').value;
        const isEdit = !!buildingId;

        const url = isEdit ? `/api/admin/facilities/buildings/${buildingId}` : '/api/admin/facilities/buildings';
        const method = isEdit ? 'PUT' : 'POST';

        try {
            const response = await fetchWithAuth(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: buildingName })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ì €ì¥ ì‹¤íŒ¨');
            }
            alert('ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            buildingModal.hide();
            loadBuildings();
        } catch (error) {
            console.error(error);
            alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    async function loadClassrooms(buildingId) {
        const tableContainer = document.getElementById('classroom-table-container');
        const loader = document.getElementById('classroom-loader');
        loader.classList.remove('d-none');
        tableContainer.innerHTML = '';

        try {
            const response = await fetchWithAuth(`/api/admin/facilities/buildings/${buildingId}/classrooms`);
            if (!response.ok) throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
            const result = await response.json();
            renderClassrooms(result.data);
        } catch (error) {
            console.error(error);
            tableContainer.innerHTML = '<div class="alert alert-danger">ê°•ì˜ì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        } finally {
            loader.classList.add('d-none');
        }
    }

    function renderClassrooms(classrooms) {
        const container = document.getElementById('classroom-table-container');
        if (!classrooms || classrooms.length === 0) {
            container.innerHTML = '<p class="text-center text-muted mt-4">ë“±ë¡ëœ ê°•ì˜ì‹¤ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const table = `
            <table class="table table-hover align-middle">
                <thead class="table-light text-center">
                    <tr>
                        <th>ê°•ì˜ì‹¤ ì´ë¦„</th>
                        <th>ìˆ˜ìš© ì¸ì›</th>
                        <th>ë¹„ê³ </th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    ${classrooms.map(c => `
                        <tr data-id="${c.id}" data-name="${escapeHtml(c.name)}" data-capacity="${c.capacity}" data-info="${escapeHtml(c.info || '')}">
                            <td>${escapeHtml(c.name)}</td>
                            <td>${c.capacity}ëª…</td>
                            <td>${escapeHtml(c.info || '-')}</td>
                            <td>
                                <i class="bi bi-pencil-square text-primary me-2 action-icon" data-action="edit-classroom" title="ìˆ˜ì •"></i>
                                <i class="bi bi-trash-fill text-danger action-icon" data-action="delete-classroom" title="ì‚­ì œ"></i>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        container.innerHTML = table;
    }

    function handleClassroomTableClick(event) {
        const actionIcon = event.target.closest('.action-icon');
        if (!actionIcon) return;

        const row = actionIcon.closest('tr');
        const classroom = {
            id: row.dataset.id,
            name: row.dataset.name,
            capacity: row.dataset.capacity,
            info: row.dataset.info
        };

        const action = actionIcon.dataset.action;
        if (action === 'edit-classroom') {
            openClassroomModal(classroom);
        } else if (action === 'delete-classroom') {
            handleDeleteClassroom(classroom.id, classroom.name);
        }
    }

    async function handleDeleteClassroom(classroomId, classroomName) {
        if (!confirm(`'${classroomName}' ê°•ì˜ì‹¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const response = await fetchWithAuth(`/api/admin/facilities/classrooms/${classroomId}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ê°•ì˜ì‹¤ ì‚­ì œ ì‹¤íŒ¨');
            }
            alert('ê°•ì˜ì‹¤ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadClassrooms(selectedBuildingId);
        } catch (error) {
            console.error(error);
            alert(`ê°•ì˜ì‹¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    function openClassroomModal(classroom = null) {
        const form = document.getElementById('classroom-form');
        form.classList.remove('was-validated');
        form.reset();

        const title = document.getElementById('classroom-modal-title');
        if (classroom) {
            title.textContent = 'ê°•ì˜ì‹¤ ì •ë³´ ìˆ˜ì •';
            document.getElementById('classroom-id').value = classroom.id;
            document.getElementById('classroom-name').value = classroom.name;
            document.getElementById('classroom-capacity').value = classroom.capacity;
            document.getElementById('classroom-info').value = classroom.info;
        } else {
            title.textContent = 'ìƒˆ ê°•ì˜ì‹¤ ì¶”ê°€';
            document.getElementById('classroom-id').value = '';
        }
        classroomModal.show();
    }

    async function handleClassroomFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const classroomId = document.getElementById('classroom-id').value;
        const isEdit = !!classroomId;

        const data = {
            name: document.getElementById('classroom-name').value,
            capacity: parseInt(document.getElementById('classroom-capacity').value),
            info: document.getElementById('classroom-info').value
        };

        const url = isEdit
            ? `/api/admin/facilities/classrooms/${classroomId}`
            : `/api/admin/facilities/buildings/${selectedBuildingId}/classrooms`;
        const method = isEdit ? 'PUT' : 'POST';

        try {
            const response = await fetchWithAuth(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ì €ì¥ ì‹¤íŒ¨');
            }
            alert('ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            classroomModal.hide();
            loadClassrooms(selectedBuildingId);
        } catch (error) {
            console.error(error);
            alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    function resetClassroomView() {
        selectedBuildingId = null;
        document.getElementById('classroom-list-title').textContent = 'ê°•ì˜ì‹¤ ëª©ë¡';
        document.getElementById('add-classroom-btn').classList.add('d-none');
        document.getElementById('classroom-placeholder').classList.remove('d-none');
        document.getElementById('classroom-content').classList.add('d-none');
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

</script>
</body>
</html>