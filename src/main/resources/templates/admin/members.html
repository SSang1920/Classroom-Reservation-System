<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>íšŒì› ê´€ë¦¬</title>
</head>
<body class="bg-light">
<!-- ìƒë‹¨ ë°” -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container-fluid">
    <!-- ì‚¬ì´ë“œë°” -->
    <nav th:replace="~{fragments/admin-sidebar :: admin-sidebar}"></nav>

    <main class="admin-content px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">ğŸ‘¥ íšŒì› ê´€ë¦¬</h1>
        </div>

        <p>ì‹œìŠ¤í…œì— ë“±ë¡ëœ ëª¨ë“  íšŒì›ì˜ ëª©ë¡ì…ë‹ˆë‹¤.</p>

        <!-- ê²€ìƒ‰ í•„í„° í¼ -->
        <form id="search-form" class="card card-body bg-light mb-4">
            <div class="row g-3 align-items-end">
                <!-- ê²€ìƒ‰ ì¡°ê±´ ë° í‚¤ì›Œë“œ -->
                <div class="col-md-5">
                    <label for="search-type" class="form-label">ê²€ìƒ‰ ì¡°ê±´</label>
                    <div class="input-group">
                        <select class="form-select" id="search-type" style="flex: 0 0 120px;">
                            <option value="loginId" selected>ì•„ì´ë””</option>
                            <option value="name">ì´ë¦„</option>
                            <option value="email">ì´ë©”ì¼</option>
                        </select>
                        <input type="text" class="form-control" id="search-keyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </div>

                <!-- ì—­í•  í•„í„° -->
                <div class="col-md-2">
                    <label for="search-role" class="form-label">ì—­í• </label>
                    <select class="form-select" id="search-role">
                        <option value="">ì „ì²´</option>
                        <option value="ADMIN">ê´€ë¦¬ì</option>
                        <option value="PROFESSOR">êµìˆ˜</option>
                        <option value="STUDENT">í•™ìƒ</option>
                    </select>
                </div>

                <!-- ê°€ì…ì¼ í•„í„° -->
                <div class="col-md-3">
                    <label for="search-date" class="form-label">ê°€ì…ì¼</label>
                    <input type="date" class="form-control" id="search-date">
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="col-md-2">
                    <div class="d-grid gap-2 d-md-flex">
                        <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
                        <button type="button" id="reset-btn" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
        </form>

        <!-- íšŒì› ëª©ë¡ì„ í‘œì‹œí•  í…Œì´ë¸” -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light text-center">
                <tr>
                    <th scope="col">#PK</th>
                    <th scope="col">ë¡œê·¸ì¸ ID</th>
                    <th scope="col">ì´ë¦„</th>
                    <th scope="col">ì´ë©”ì¼</th>
                    <th scope="col">ì—­í• </th>
                    <th scope="col">ê°€ì…ì¼</th>
                    <th scope="col">ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody id="member-list-body" class="text-center">
                <!-- JavaScriptë¡œ ë°ì´í„° ë Œë”ë§ -->
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <nav id="pagination-nav" class="d-none">
            <ul class="pagination justify-content-center" id="pagination-ul">
                <!-- JavaScriptë¡œ í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ -->
            </ul>
        </nav>
    </main>
</div>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- ìƒë‹¨ ë°” ìë°” ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<!-- ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ì œì–´ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:src="@{/js/admin-auth.js}"></script>

<!-- íšŒì› ëª©ë¡ ì¡°íšŒ ë° ë Œë”ë§ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('search-form');
        const resetBtn = document.getElementById('reset-btn');
        const memberListBody = document.getElementById('member-list-body');

        // flatpickr ë¼ì´ë¸ŒëŸ¬ë¦¬ 'search-date' inputì— ì ìš©
        flatpickr('#search-date', {
            dateFormat: "Y-m-d (D)",
            locale: "ko"
        });

        // í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ URLì˜ íŒŒë¼ë¯¸í„°ë¥¼ ì½ì–´ í¼ì„ ì±„ìš°ê³  ê²€ìƒ‰ ì‹¤í–‰
        initializeFormFromUrl();
        const initialUrlParams = new URLSearchParams(window.location.search);
        const initialPage = initialUrlParams.get('page') || 0;
        fetchMembers(initialPage);

        // ê²€ìƒ‰ í¼ ì œì¶œ ì´ë²¤íŠ¸
        searchForm.addEventListener('submit', event => {
            event.preventDefault();
            fetchMembers(0);
        });

        // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            document.getElementById('search-type').value = 'loginId';
            datePicker.clear();
            fetchMembers(0);
        });

        // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
        memberListBody.addEventListener('click', async (event) => {
            if (event.target.matches('.delete-btn')) {
                const memberId = event.target.dataset.memberId;
                const memberName = event.target.dataset.memberName;

                // ì‚¬ìš©ìì—ê²Œ ì‚­ì œ ì¬í™•ì¸
                if (confirm(`'${memberName}' íšŒì›ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ íšŒì›ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    try {
                        const response = await fetchWithAuth(`/api/admin/members/${memberId}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'íšŒì› ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }

                        alert('íšŒì›ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        const currentPage = new URLSearchParams(window.location.search).get('page') || 0;
                        fetchMembers(currentPage);

                    } catch (error) {
                        console.error('íšŒì› ì‚­ì œ ì‹¤íŒ¨:', error);
                        alert('íšŒì› ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            }
        });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„°ë¥¼ ì½ì–´ ê²€ìƒ‰ í¼ì˜ ê°’ì„ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    function initializeFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const keyword = params.get('loginId') || params.get('name') || params.get('email') || '';
        document.getElementById('search-keyword').value = keyword;
        document.getElementById('search-role').value = params.get('role') || '';
        document.getElementById('search-date').value = params.get('date') || '';

        if (params.has('loginId')) {
            document.getElementById('search-type').value = 'loginId';
        } else if (params.has('name')) {
            document.getElementById('search-type').value = 'name';
        } else if (params.has('email')) {
            document.getElementById('search-type').value = 'email';
        }
    }

    // í˜„ì¬ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì„œë²„ì— íšŒì› ëª©ë¡ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
    async function fetchMembers(pageNumber) {
        const tbody = document.getElementById('member-list-body');
        tbody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>`;

        const params = buildQueryParameters(pageNumber);
        window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);

        try {
            const response = await fetchWithAuth(`/api/admin/members?${params.toString()}`);
            if (!response.ok) throw new Error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${response.status}');

            const result = await response.json();
            renderTable(result.data.content);
            renderPagination(result.data);

        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // í˜„ì¬ í¼ ì…ë ¥ê°’ì„ ì½ì–´ URLSearchParams ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function buildQueryParameters(pageNumber) {
        const searchType = document.getElementById('search-type').value;
        const keyword = document.getElementById('search-keyword').value;
        const role = document.getElementById('search-role').value;
        const searchDate = document.getElementById('search-date').value;

        const params = new URLSearchParams({
            page: pageNumber,
            size: 10,
            sort: 'createdAt,desc'
        });

        if (keyword.trim()) {
            params.append(searchType, keyword.trim());
        }

        if (role) {
            params.append('role', role);
        }

        if (searchDate) {
            params.append('date', searchDate);
        }

        return params;
    }

    // ë°›ì•„ì˜¨ íšŒì› ë°ì´í„°ë¡œ í…Œì´ë¸” ë³¸ë¬¸ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderTable(members) {
        const tbody = document.getElementById('member-list-body');
        tbody.innerHTML = '';

        if (!members || members.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        members.forEach(member => {
            const createdAt = new Date(member.createdAt).toLocaleString('ko-KR', { dateStyle: 'medium', timeStyle: 'short' });
            const roleBadge = getRoleBadge(member.role);

            // íšŒì›ì˜ ì—­í• ì— ë”°ë¼ ë‹¤ë¥¸ ë²„íŠ¼ì„ ìƒì„±
            let managementCellHtml = '';
            if (member.role === 'ADMIN') {
                // ê´€ë¦¬ìì¼ ê²½ìš° ë¹„í™œì„±í™”ëœ ë²„íŠ¼ í‘œì‹œ
                managementCellHtml = `
                    <button class="btn btn-sm btn-secondary" disabled title="ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.">
                        ì‚­ì œ ë¶ˆê°€
                    </button>
                `;
            } else {
                managementCellHtml = `
                    <button class="btn btn-sm btn-outline-danger delete-btn"
                            data-member-id="${member.memberPkId}"
                            data-member-name="${member.name}">
                        ì‚­ì œ
                    </button>
                `;
            }


            const row = `
                <tr>
                    <th scope="row">${member.memberPkId}</th>
                    <td>${member.loginId}</td>
                    <td>${member.name}</td>
                    <td>${member.email}</td>
                    <td>${roleBadge}</td>
                    <td>${createdAt}</td>
                    <td>${managementCellHtml}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // ì—­í• ì— ë”°ë¼ ë°°ì§€ HTML ë°˜í™˜ í•¨ìˆ˜
    function getRoleBadge(role) {
        const roles = { 'ADMIN': 'bg-danger', 'PROFESSOR': 'bg-success', 'STUDENT': 'bg-primary' };
        const roleNames = { 'ADMIN': 'ê´€ë¦¬ì', 'PROFESSOR': 'êµìˆ˜', 'STUDENT': 'í•™ìƒ' };
        return `<span class="badge ${roles[role] || 'bg-secondary'}">${roleNames[role] || role}</span>`;
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ UI ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const paginationUl = document.getElementById('pagination-ul');
        paginationUl.innerHTML = '';

        if (pageData.totalPages <= 1) {
            paginationNav.classList.add('d-none');
            return;
        }

        paginationNav.classList.remove('d-none');

        for (let i = 0; i < pageData.totalPages; i++) {
            const pageItemClass = i === pageData.number ? 'page-item active' : 'page-item';
            paginationUl.innerHTML += `<li class="${pageItemClass}"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMembers(${i})">${i + 1}</a></li>`;
        }
    }
</script>
</body>
</html>