<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>회원 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<!-- 상단 바 -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">회원 관리</h1>
        <a href="/admin/main" class="btn btn-outline-secondary">관리자 홈으로</a>
    </div>
    <p>시스템에 등록된 모든 회원의 목록입니다.</p>
    <hr>

    <!-- 회원 목록을 표시할 테이블 -->
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th scope="col">#PK</th>
                <th scope="col">로그인 ID</th>
                <th scope="col">이름</th>
                <th scope="col">이메일</th>
                <th scope="col">역할</th>
                <th scope="col">가입일</th>
                <th scope="col">관리</th>
            </tr>
            </thead>
            <tbody id="member-list-body">
            <!-- JavaScript로 데이터 렌더링 -->
            <tr>
                <td colspan="7" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    회원 정보를 불러오는 중...
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <nav id="pagination-nav" class="d-none">
        <ul class="pagination justify-content-center" id="pagination-ul">
            <!-- JavaScript로 페이지네이션 렌더링 -->
        </ul>
    </nav>
</div>

<!-- 상단 바 자바 스크립트 -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<!-- 관리자 페이지 접근 제어 스크립트 -->
<script src="/js/admin-auth.js"></script>

<!-- API 요청 클라이언트 스크립트 -->
<script src="/js/api-client.js"></script>

<!-- 회원 목록 조회 및 렌더링 스크립트 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 0;
        fetchMembers(page);
    });

    async function fetchMembers(pageNumber) {
        const token = localStorage.getItem('accessToken');
        const tbody = document.getElementById('member-list-body');

        if (!token) return;

        try {
            const response = await fetchWithAuth(`/api/admin/members?page=${pageNumber}&size=10&sort=createdAt,desc`, {
                method: 'GET',
            });

            if (!response.ok) throw new Error('데이터 로딩 실패: ' + response.statusText);

            const result = await response.json();
            const pageData = result.data;
            const members = pageData.content;
            tbody.innerHTML = '';

            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">등록된 회원이 없습니다.</td></tr>';
            } else {
                members.forEach(member => {
                    const createdAt = new Date(member.createdAt).toLocaleString('ko-KR');
                    const roleBadge = getRoleBadge(member.role);
                    const row = `
                        <tr>
                            <th scope="row">${member.memberPkId}</th>
                            <td>${member.loginId}</td>
                            <td>${member.name}</td>
                            <td>${member.email}</td>
                            <td>${roleBadge}</td>
                            <td>${createdAt}</td>
                            <td><button class="btn btn-sm btn-outline-primary" disabled>관리</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            renderPagination(pageData);
        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">데이터를 불러오는 데 실패했습니다.</td></tr>';
        }
    }

    function getRoleBadge(role) {
        const roles = { 'ADMIN': 'bg-danger', 'PROFESSOR': 'bg-success', 'STUDENT': 'bg-primary' };
        const roleNames = { 'ADMIN': '관리자', 'PROFESSOR': '교수', 'STUDENT': '학생' };
        return `<span class="badge ${roles[role] || 'bg-secondary'}">${roleNames[role] || role}</span>`;
    }

    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const paginationUl = document.getElementById('pagination-ul');
        paginationUl.innerHTML = '';

        if (pageData.totalPages <= 1) {
            paginationNav.classList.add('d-none');
            return;
        }

        paginationNav.classList.remove('d-none');

        for (let i = 0; i < pageData.totalPages; i++) {
            const pageItemClass = i === pageData.number ? 'page-item active' : 'page-item';
            paginationUl.innerHTML += `<li class="${pageItemClass}"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMembers(${i})">${i + 1}</a></li>`;
        }
    }
</script>
</body>
</html>