<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>회원 관리</title>
</head>
<body>
<!-- 상단 바 -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">회원 관리</h1>
        <a href="/admin/main" class="btn btn-outline-secondary">관리자 홈으로</a>
    </div>
    <p>시스템에 등록된 모든 회원의 목록입니다.</p>
    <hr>

    <!-- 검색 필터 폼 -->
    <form id="search-form" class="card card-body bg-light mb-4">
        <div class="row g-3 align-items-end">
            <!-- 검색 조건 및 키워드 -->
            <div class="col-md-5">
                <label for="search-type" class="form-label">검색 조건</label>
                <div class="input-group">
                    <select class="form-select" id="search-type" style="flex: 0 0 120px;">
                        <option value="loginId" selected>아이디</option>
                        <option value="name">이름</option>
                        <option value="email">이메일</option>
                    </select>
                    <input type="text" class="form-control" id="search-keyword" placeholder="검색어를 입력하세요">
                </div>
            </div>

            <!-- 역할 필터 -->
            <div class="col-md-2">
                <label for="search-role" class="form-label">역할</label>
                <select class="form-select" id="search-role">
                    <option value="">전체</option>
                    <option value="ADMIN">관리자</option>
                    <option value="PROFESSOR">교수</option>
                    <option value="STUDENT">학생</option>
                </select>
            </div>

            <!-- 가입일 필터 -->
            <div class="col-md-3">
                <label for="search-date" class="form-label">가입일</label>
                <input type="date" class="form-control" id="search-date">
            </div>

            <!-- 버튼 -->
            <div class="col-md-2">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-primary">검색</button>
                    <button type="button" id="reset-btn" class="btn btn-secondary">초기화</button>
                </div>
            </div>
        </div>
    </form>

    <!-- 회원 목록을 표시할 테이블 -->
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light text-center">
            <tr>
                <th scope="col">#PK</th>
                <th scope="col">로그인 ID</th>
                <th scope="col">이름</th>
                <th scope="col">이메일</th>
                <th scope="col">역할</th>
                <th scope="col">가입일</th>
                <th scope="col">관리</th>
            </tr>
            </thead>
            <tbody id="member-list-body" class="text-center">
            <!-- JavaScript로 데이터 렌더링 -->
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <nav id="pagination-nav" class="d-none">
        <ul class="pagination justify-content-center" id="pagination-ul">
            <!-- JavaScript로 페이지네이션 렌더링 -->
        </ul>
    </nav>
</div>
<!-- 공통 스크립트 -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- 상단 바 자바 스크립트 -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<!-- 관리자 페이지 접근 제어 스크립트 -->
<script src="/js/admin-auth.js"></script>

<!-- 회원 목록 조회 및 렌더링 스크립트 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('search-form');
        const resetBtn = document.getElementById('reset-btn');
        const memberListBody = document.getElementById('member-list-body');

        // flatpickr 라이브러리 'search-date' input에 적용
        flatpickr('#search-date', {
            dateFormat: "Y-m-d (D)",
            locale: "ko"
        });

        // 페이지가 처음 로드될 때 URL의 파라미터를 읽어 폼을 채우고 검색 실행
        initializeFormFromUrl();
        const initialUrlParams = new URLSearchParams(window.location.search);
        const initialPage = initialUrlParams.get('page') || 0;
        fetchMembers(initialPage);

        // 검색 폼 제출 이벤트
        searchForm.addEventListener('submit', event => {
            event.preventDefault();
            fetchMembers(0);
        });

        // 초기화 버튼 클릭 이벤트
        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            document.getElementById('search-type').value = 'loginId';
            datePicker.clear();
            fetchMembers(0);
        });

        // 동적으로 생성된 삭제 버튼 처리
        memberListBody.addEventListener('click', async (event) => {
            if (event.target.matches('.delete-btn')) {
                const memberId = event.target.dataset.memberId;
                const memberName = event.target.dataset.memberName;

                // 사용자에게 삭제 재확인
                if (confirm(`'${memberName}' 회원을 정말로 삭제하시겠습니까?\n삭제된 회원은 복구할 수 없습니다.`)) {
                    try {
                        const response = await fetchWithAuth(`/api/admin/members/${memberId}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || '회원 삭제에 실패했습니다.');
                        }

                        alert('회원이 성공적으로 삭제되었습니다.');
                        const currentPage = new URLSearchParams(window.location.search).get('page') || 0;
                        fetchMembers(currentPage);

                    } catch (error) {
                        console.error('회원 삭제 실패:', error);
                        alert('회원 삭제에 실패했습니다. 다시 시도해주세요.');
                    }
                }
            }
        });
    });

    // 페이지 로드 시 URL 파라미터를 읽어 검색 폼의 값을 설정하는 함수
    function initializeFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const keyword = params.get('loginId') || params.get('name') || params.get('email') || '';
        document.getElementById('search-keyword').value = keyword;
        document.getElementById('search-role').value = params.get('role') || '';
        document.getElementById('search-date').value = params.get('date') || '';

        if (params.has('loginId')) {
            document.getElementById('search-type').value = 'loginId';
        } else if (params.has('name')) {
            document.getElementById('search-type').value = 'name';
        } else if (params.has('email')) {
            document.getElementById('search-type').value = 'email';
        }
    }

    // 현재 검색 조건으로 서버에 회원 목록을 요청하는 함수
    async function fetchMembers(pageNumber) {
        const tbody = document.getElementById('member-list-body');
        tbody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> 회원 정보를 불러오는 중...</td></tr>`;

        const params = buildQueryParameters(pageNumber);
        window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);

        try {
            const response = await fetchWithAuth(`/api/admin/members?${params.toString()}`);
            if (!response.ok) throw new Error('데이터 로딩 실패: ${response.status}');

            const result = await response.json();
            renderTable(result.data.content);
            renderPagination(result.data);

        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">데이터를 불러오는 데 실패했습니다.</td></tr>';
        }
    }

    // 현재 폼 입력값을 읽어 URLSearchParams 객체를 생성하는 헬퍼 함수
    function buildQueryParameters(pageNumber) {
        const searchType = document.getElementById('search-type').value;
        const keyword = document.getElementById('search-keyword').value;
        const role = document.getElementById('search-role').value;
        const searchDate = document.getElementById('search-date').value;

        const params = new URLSearchParams({
            page: pageNumber,
            size: 10,
            sort: 'createdAt,desc'
        });

        if (keyword.trim()) {
            params.append(searchType, keyword.trim());
        }

        if (role) {
            params.append('role', role);
        }

        if (searchDate) {
            params.append('date', searchDate);
        }

        return params;
    }

    // 받아온 회원 데이터로 테이블 본문을 그리는 함수
    function renderTable(members) {
        const tbody = document.getElementById('member-list-body');
        tbody.innerHTML = '';

        if (!members || members.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">검색 결과가 없습니다.</td></tr>`;
            return;
        }

        members.forEach(member => {
            const createdAt = new Date(member.createdAt).toLocaleString('ko-KR', { dateStyle: 'medium', timeStyle: 'short' });
            const roleBadge = getRoleBadge(member.role);

            // 회원의 역할에 따라 다른 버튼을 생성
            let managementCellHtml = '';
            if (member.role === 'ADMIN') {
                // 관리자일 경우 비활성화된 버튼 표시
                managementCellHtml = `
                    <button class="btn btn-sm btn-secondary" disabled title="관리자 계정은 삭제할 수 없습니다.">
                        삭제 불가
                    </button>
                `;
            } else {
                managementCellHtml = `
                    <button class="btn btn-sm btn-outline-danger delete-btn"
                            data-member-id="${member.memberPkId}"
                            data-member-name="${member.name}">
                        삭제
                    </button>
                `;
            }


            const row = `
                <tr>
                    <th scope="row">${member.memberPkId}</th>
                    <td>${member.loginId}</td>
                    <td>${member.name}</td>
                    <td>${member.email}</td>
                    <td>${roleBadge}</td>
                    <td>${createdAt}</td>
                    <td>${managementCellHtml}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // 역할에 따라 배지 HTML 반환 함수
    function getRoleBadge(role) {
        const roles = { 'ADMIN': 'bg-danger', 'PROFESSOR': 'bg-success', 'STUDENT': 'bg-primary' };
        const roleNames = { 'ADMIN': '관리자', 'PROFESSOR': '교수', 'STUDENT': '학생' };
        return `<span class="badge ${roles[role] || 'bg-secondary'}">${roleNames[role] || role}</span>`;
    }

    // 페이지네이션 UI 그리는 함수
    function renderPagination(pageData) {
        const paginationNav = document.getElementById('pagination-nav');
        const paginationUl = document.getElementById('pagination-ul');
        paginationUl.innerHTML = '';

        if (pageData.totalPages <= 1) {
            paginationNav.classList.add('d-none');
            return;
        }

        paginationNav.classList.remove('d-none');

        for (let i = 0; i < pageData.totalPages; i++) {
            const pageItemClass = i === pageData.number ? 'page-item active' : 'page-item';
            paginationUl.innerHTML += `<li class="${pageItemClass}"><a class="page-link" href="#" onclick="event.preventDefault(); fetchMembers(${i})">${i + 1}</a></li>`;
        }
    }
</script>
</body>
</html>