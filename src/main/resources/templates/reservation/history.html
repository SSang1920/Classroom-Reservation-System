<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
  <title>ì˜ˆì•½ ì´ë ¥ ë³´ê¸°</title>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-4">
  <h2>ğŸ“ ì˜ˆì•½ ì´ë ¥ ë³´ê¸°</h2>

  <div id="no-reservations-message" class="alert alert-info mt-3 d-none" role="alert">
    ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
  </div>

  <div id="reservations-container" class="table-responsive mt-3">
    <table class="table table-hover text-center">
      <thead class="table-light">
      <tr>
        <th scope="col">#</th>
        <th scope="col">ê°•ì˜ì‹¤</th>
        <th scope="col">ì˜ˆì•½ ë‚ ì§œ</th>
        <th scope="col">ì˜ˆì•½ ì‹œê°„</th>
        <th scope="col">ìƒíƒœ</th>
        <th scope="col">ë™ì‘</th>
      </tr>
      </thead>
      <tbody id="reservation-tbody">
      <tr>
        <td colspan="6" class="p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>


<script>
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚´ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  document.addEventListener('DOMContentLoaded', fetchMyReservations);

  // APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë‚´ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function fetchMyReservations() {
      const token = localStorage.getItem('accessToken');
      const tbody = document.getElementById('reservation-tbody');
      const container = document.getElementById('reservations-container');
      const noDataMessage = document.getElementById('no-reservations-message');

      // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë˜ëŒë ¤ ë³´ëƒ„
      if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
      }

      try {
          // /api/reservations/me ì—”ë“œí¬ì¸íŠ¸ì— GET ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
          const response = await fetch('/api/reservations/me', {
              headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'ì˜ˆì•½ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const result = await response.json();
          const reservations = result.data; // ApiSuccessResponseì˜ data í•„ë“œ

          // ì˜ˆì•½ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
          if (reservations && reservations.length > 0) {
              container.classList.remove('d-none');
              noDataMessage.classList.add('d-none');
              tbody.innerHTML = ''; // ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±°
              // ê° ì˜ˆì•½ì— ëŒ€í•´ í…Œì´ë¸” í–‰ì„ ìƒì„±í•˜ê³  ì¶”ê°€í•©ë‹ˆë‹¤.
              reservations.forEach((reservation, index) => {
                  tbody.innerHTML += createReservationRow(reservation, index + 1);
              });
          } else {
              // ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 'ë‚´ì—­ ì—†ìŒ' ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
              container.classList.add('d-none');
              noDataMessage.classList.remove('d-none');
          }
      } catch (error) {
          // ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í…Œì´ë¸”ì— í‘œì‹œí•©ë‹ˆë‹¤.
          tbody.innerHTML = `<tr><td colspan="6" class="text-danger p-4">${error.message}</td></tr>`;
      }
  }

  // ìƒíƒœ ì´ë¦„ì— ë§ëŠ” Bootstrap ë°°ì§€ë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  function getStateBadge(state) {
      const states = {
          'ì˜ˆì•½ë¨': 'bg-primary',
          'ì‚¬ìš© ì™„ë£Œ': 'bg-success',
          'ì·¨ì†Œë¨': 'bg-secondary',
          'ê´€ë¦¬ìì— ì˜í•´ ì·¨ì†Œë¨': 'bg-danger',
          'ê´€ë¦¬ìì— ì˜í•´ ë³€ê²½ë¨': 'bg-warning text-dark',
          'ìë™ ì™„ë£Œë¨': 'bg-info text-dark'
      };
      const badgeClass = states[state] || 'bg-dark';
      return `<span class="badge ${badgeClass}">${state}</span>`;
  }

  // ì˜ˆì•½ ë°ì´í„°ë¡œ í…Œì´ë¸”ì˜ í•œ í–‰(<tr>)ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
  function createReservationRow(reservation, count) {
      const startTime = new Date(reservation.startTime);
      const endTime = new Date(reservation.endTime);
      const date = startTime.toLocaleDateString('ko-KR');
      const time = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} ~ ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;

      //ìƒíƒœ ë°°ì§€ ìƒì„± ë¡œì§ì„ í—¬í¼ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
      const stateBadge = getStateBadge(reservation.state);

      // ìƒíƒœì— ë”°ë¼ 'ì·¨ì†Œ' ë° 'ì‚¬ìš© ì™„ë£Œ' ë²„íŠ¼ì„ ë™ì ìœ¼ë¡œ ìƒì„±
      let actionButtons = '';
      const now = new Date();
      const cancellableStates = ['ì˜ˆì•½ë¨', 'ê´€ë¦¬ìì— ì˜í•´ ë³€ê²½ë¨'];

      if (cancellableStates.includes(reservation.state)) {
          actionButtons += `
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="handleCancelClick(this, ${reservation.id})">
                  ì·¨ì†Œ
              </button>
          `;
          // ì‹œì‘ ì‹œê°„ ì´í›„ì´ê³ , ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ì˜ˆì•½ì— 'ì‚¬ìš© ì™„ë£Œ' ë²„íŠ¼ í‘œì‹œ
          if (now >= startTime) {
              actionButtons += `
                  <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick="handleCompleteClick(this, ${reservation.id})">
                      ì‚¬ìš© ì™„ë£Œ
                  </button>
              `;
          }
      }

      return `
          <tr>
            <th scope="row">${count}</th>
            <td>${reservation.classroomName}</td>
            <td>${date}</td>
            <td>${time}</td>
            <td>${stateBadge}</td>
            <td>${actionButtons || '-'}</td>
          </tr>
      `;
  }

  // ì˜ˆì•½ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function handleCancelClick(button, reservationId) {
      if (!confirm('ì •ë§ë¡œ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const token = localStorage.getItem('accessToken');
      const url = `/api/reservations/${reservationId}/cancel`;

      try {
          const response = await fetch(url, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${token}` }
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.message || 'ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

          // ì„±ê³µ ì‹œ, í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ UIë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
          const row = button.closest('tr');
          if (row) {
              row.cells[4].innerHTML = getStateBadge('ì‚¬ìš©ì ì·¨ì†Œ');
              row.cells[5].innerHTML = '-'; // ëª¨ë“  ë²„íŠ¼ ì œê±°
          }
      } catch (error) {
          console.error('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
          alert(error.message);
      }
  }

  // ì˜ˆì•½ ì‚¬ìš© ì™„ë£Œ ë²„íŠ¼ í´ë¦­ì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function handleCompleteClick(button, reservationId) {
      if (!confirm('í•´ë‹¹ ì˜ˆì•½ì„ ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const token = localStorage.getItem('accessToken');
      const url = `/api/reservations/${reservationId}/complete`;

      try {
          const response = await fetch(url, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${token}` }
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.message || 'ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

          // ì„±ê³µ ì‹œ, UIë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
          const row = button.closest('tr');
          if (row) {
              row.cells[4].innerHTML = getStateBadge('ì‚¬ìš© ì™„ë£Œ');
              row.cells[5].innerHTML = '-'; // ëª¨ë“  ë²„íŠ¼ ì œê±°
          }
      } catch (error) {
          console.error('ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
          alert(error.message);
      }
  }
</script>

</body>
</html>