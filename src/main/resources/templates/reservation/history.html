<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <title>ì˜ˆì•½ ì´ë ¥ ë³´ê¸°</title>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-4">
  <h2>ğŸ“ ì˜ˆì•½ ì´ë ¥ ë³´ê¸°</h2>

  <div id="no-reservations-message" class="alert alert-info mt-3 d-none" role="alert">
    ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
  </div>

  <div id="reservations-container" class="table-responsive mt-3">
    <table class="table table-hover text-center">
      <thead class="table-light">
      <tr>
        <th scope="col">#</th>
        <th scope="col">ê°•ì˜ì‹¤</th>
        <th scope="col">ì˜ˆì•½ ë‚ ì§œ</th>
        <th scope="col">ì˜ˆì•½ ì‹œê°„</th>
        <th scope="col">ìƒíƒœ</th>
        <th scope="col">ë™ì‘</th>
      </tr>
      </thead>
      <tbody id="reservation-tbody">
      <tr>
        <td colspan="6" class="p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="changeRequestModal" tabindex="-1" aria-labelledby="changeRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeRequestModalLabel">ì˜ˆì•½ ë³€ê²½ ìš”ì²­</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="changeRequestForm">
          <!-- API í˜¸ì¶œì— í•„ìš”í•œ ì˜ˆì•½ IDë¥¼ ì„ì‹œ ì €ì¥í•˜ëŠ” ìˆ¨ê²¨ì§„ í•„ë“œ -->
          <input type="hidden" id="modalReservationId">

          <div class="mb-3">
            <label for="newBuildingId" class="form-label">ë³€ê²½í•  ê±´ë¬¼</label>
            <select class="form-select" id="newBuildingId" required>
              <option value="" selected disabled>ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="newClassroomId" class="form-label">ë³€ê²½í•  ê°•ì˜ì‹¤</label>
            <select class="form-select" id="newClassroomId" required>
              <option value="" selected disabled>ê°•ì˜ì‹¤ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newReservationDate" class="form-label">ë³€ê²½í•  ë‚ ì§œ</label>
            <input type="text" class="form-control" id="newReservationDate" required disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">ë³€ê²½í•  ì‹œê°„</label>
            <div id="newPeriods" class="d-flex flex-wrap border rounded p-2" style="gap: 0.5rem;">
              <small class="text-muted">ê°•ì˜ì‹¤ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì´ í‘œì‹œë©ë‹ˆë‹¤.</small>
            </div>
            <div id="periods-error" class="invalid-feedback d-block"></div>
          </div>
          <div class="mb-3">
            <label for="requestMessage" class="form-label">ìš”ì²­ ë©”ì‹œì§€ (ì„ íƒ)</label>
            <textarea class="form-control" id="requestMessage" rows="3" placeholder="ê´€ë¦¬ìì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        <button type="button" class="btn btn-primary" id="submitChangeRequest">ìš”ì²­ ì œì¶œ</button>
      </div>
    </div>
  </div>
</div>

<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>


<script>
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚´ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  document.addEventListener('DOMContentLoaded', function() {
     fetchMyReservations();
     initializeChangeRequestModal();
   });

  // APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë‚´ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function fetchMyReservations() {
      const token = localStorage.getItem('accessToken');
      const tbody = document.getElementById('reservation-tbody');
      const container = document.getElementById('reservations-container');
      const noDataMessage = document.getElementById('no-reservations-message');

      // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë˜ëŒë ¤ ë³´ëƒ„
      if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
      }

      try {
          // /api/reservations/me ì—”ë“œí¬ì¸íŠ¸ì— GET ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
          const response = await fetch('/api/reservations/me', {
              headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'ì˜ˆì•½ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const result = await response.json();
          const reservations = result.data; // ApiSuccessResponseì˜ data í•„ë“œ

          // ì˜ˆì•½ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
          if (reservations && reservations.length > 0) {
              container.classList.remove('d-none');
              noDataMessage.classList.add('d-none');
              tbody.innerHTML = ''; // ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±°
              // ê° ì˜ˆì•½ì— ëŒ€í•´ í…Œì´ë¸” í–‰ì„ ìƒì„±í•˜ê³  ì¶”ê°€í•©ë‹ˆë‹¤.
              reservations.forEach((reservation, index) => {
                  tbody.innerHTML += createReservationRow(reservation, index + 1);
              });
          } else {
              // ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 'ë‚´ì—­ ì—†ìŒ' ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
              container.classList.add('d-none');
              noDataMessage.classList.remove('d-none');
          }
      } catch (error) {
          // ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í…Œì´ë¸”ì— í‘œì‹œí•©ë‹ˆë‹¤.
          tbody.innerHTML = `<tr><td colspan="6" class="text-danger p-4">${error.message}</td></tr>`;
      }
  }

  // ìƒíƒœ ì´ë¦„ì— ë§ëŠ” Bootstrap ë°°ì§€ë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function getStateBadge(state) {
      const states = {
          'ì˜ˆì•½ë¨': 'bg-primary',
          'ì‚¬ìš© ì™„ë£Œ': 'bg-success',
          'ì·¨ì†Œë¨': 'bg-secondary',
          'ê´€ë¦¬ìì— ì˜í•´ ì·¨ì†Œë¨': 'bg-danger',
          'ê´€ë¦¬ìì— ì˜í•´ ë³€ê²½ë¨': 'bg-warning text-dark',
          'ìë™ ì™„ë£Œë¨': 'bg-info text-dark',
          'ìš”ì²­ì— ì˜í•´ ë³€ê²½ë¨': 'bg-info text-dark'
      };
      const badgeClass = states[state] || 'bg-dark';
      return `<span class="badge ${badgeClass}">${state}</span>`;
  }

  // ì˜ˆì•½ ë°ì´í„°ë¡œ í…Œì´ë¸”ì˜ í•œ í–‰(<tr>)ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
function createReservationRow(reservation, count) {
      const startTime = new Date(reservation.startTime);
      const endTime = new Date(reservation.endTime);
      const date = startTime.toLocaleDateString('ko-KR');
      const time = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} ~ ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
      const stateBadge = getStateBadge(reservation.state);

      let actionButtons = '';
      const now = new Date();
      const actionableStates = ['ì˜ˆì•½ë¨', 'ê´€ë¦¬ìì— ì˜í•´ ë³€ê²½ë¨', 'ìš”ì²­ì— ì˜í•´ ë³€ê²½ë¨'];

      if (actionableStates.includes(reservation.state)) {
          // 1. ì·¨ì†Œ ë²„íŠ¼ ì¶”ê°€
          actionButtons += `
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="handleCancelClick(this, ${reservation.id})">
                  ì·¨ì†Œ
              </button>
          `;

          // 2. 'ë³€ê²½ ìš”ì²­' ë²„íŠ¼ì„ ì˜¬ë°”ë¥¸ if/else êµ¬ì¡°ì™€ ë°±í‹±(`)ìœ¼ë¡œ ìƒì„±
          if (reservation.hasPendingChangeRequest) {
              // PENDING ìš”ì²­ì´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”ëœ 'ìš”ì²­ ì²˜ë¦¬ì¤‘' ë²„íŠ¼ì„ í‘œì‹œ
              actionButtons += `
                  <button type="button" class="btn btn-sm btn-secondary ms-1" disabled title="ì´ë¯¸ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤.">
                      ìš”ì²­ ì²˜ë¦¬ì¤‘
                  </button>
              `;
          } else {
              // PENDING ìš”ì²­ì´ ì—†ìœ¼ë©´ í™œì„±í™”ëœ 'ë³€ê²½ ìš”ì²­' ë²„íŠ¼ì„ í‘œì‹œ
              actionButtons += `
                  <button type="button" class="btn btn-sm btn-warning ms-1"
                          data-bs-toggle="modal"
                          data-bs-target="#changeRequestModal"
                          data-reservation-id="${reservation.id}">
                      ë³€ê²½ ìš”ì²­
                  </button>
              `;
          }

          // 3. ì‚¬ìš© ì™„ë£Œ ë²„íŠ¼ (ì‹œì‘ ì‹œê°„ ì´í›„ì—ë§Œ í‘œì‹œ)
          if (now >= startTime) {
              actionButtons += `
                  <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick="handleCompleteClick(this, ${reservation.id})">
                      ì‚¬ìš© ì™„ë£Œ
                  </button>
              `;
          }
      }

      // ìµœì¢…ì ìœ¼ë¡œ ìƒì„±ëœ HTML ë°˜í™˜ (ë°±í‹±(`) ì‚¬ìš©)
      return `
          <tr>
            <th scope="row">${count}</th>
            <td>${reservation.classroomName}</td>
            <td>${date}</td>
            <td>${time}</td>
            <td>${stateBadge}</td>
            <td>${actionButtons || '-'}</td>
          </tr>
      `;
  }

  // ì˜ˆì•½ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function handleCancelClick(button, reservationId) {
      if (!confirm('ì •ë§ë¡œ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const token = localStorage.getItem('accessToken');
      const url = `/api/reservations/${reservationId}/cancel`;

      try {
          const response = await fetch(url, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${token}` }
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.message || 'ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

          // ì„±ê³µ ì‹œ, í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ UIë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
          const row = button.closest('tr');
          if (row) {
              row.cells[4].innerHTML = getStateBadge('ì‚¬ìš©ì ì·¨ì†Œ');
              row.cells[5].innerHTML = '-'; // ëª¨ë“  ë²„íŠ¼ ì œê±°
          }
      } catch (error) {
          console.error('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
          alert(error.message);
      }
  }

  // ì˜ˆì•½ ì‚¬ìš© ì™„ë£Œ ë²„íŠ¼ í´ë¦­ì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function handleCompleteClick(button, reservationId) {
      if (!confirm('í•´ë‹¹ ì˜ˆì•½ì„ ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const token = localStorage.getItem('accessToken');
      const url = `/api/reservations/${reservationId}/complete`;

      try {
          const response = await fetch(url, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${token}` }
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.message || 'ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

          // ì„±ê³µ ì‹œ, UIë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
          const row = button.closest('tr');
          if (row) {
              row.cells[4].innerHTML = getStateBadge('ì‚¬ìš© ì™„ë£Œ');
              row.cells[5].innerHTML = '-'; // ëª¨ë“  ë²„íŠ¼ ì œê±°
          }
      } catch (error) {
          console.error('ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
          alert(error.message);
      }
  }

  // ì˜ˆì•½ ë³€ê²½ ìš”ì²­ ëª¨ë‹¬ì„ ìœ„í•œ JavaScript ë¡œì§
  function initializeChangeRequestModal() {
    const modalEl = document.getElementById('changeRequestModal');
    const form = document.getElementById('changeRequestForm');
    const buildingSelect = document.getElementById('newBuildingId');
    const classroomSelect = document.getElementById('newClassroomId');
    const dateInput = document.getElementById('newReservationDate');
    const periodsDiv = document.getElementById('newPeriods');
    const submitBtn = document.getElementById('submitChangeRequest');
    const token = localStorage.getItem('accessToken');

    periodsDiv.addEventListener('change', function(event) {
        // ì´ë²¤íŠ¸ê°€ ì²´í¬ë°•ìŠ¤ì—ì„œ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸
        if (event.target.type === 'checkbox') {
            const checkedBoxes = periodsDiv.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedBoxes.length > 2) {
                alert('ì‹œê°„ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                event.target.checked = false; // 3ë²ˆì§¸ ì„ íƒëœ ì²´í¬ë°•ìŠ¤ë¥¼ í•´ì œ
            }
        }
    });

    //  flatpickr ì´ˆê¸°í™”
    const datePicker = flatpickr(dateInput, {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "Y-m-d (D)",
        locale: "ko",
        minDate: "today", // ê³¼ê±° ë‚ ì§œ ì„ íƒ ë¶ˆê°€
        onChange: function(selectedDates, dateStr, instance) {
            fetchAvailableTimes(); // ë‚ ì§œ ë³€ê²½ ì‹œ ì‹œê°„ ì¡°íšŒ í•¨ìˆ˜ í˜¸ì¶œ
        }
    });

    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
    modalEl.addEventListener('show.bs.modal', async function (event) {
      form.reset();
      classroomSelect.innerHTML = '<option value="" selected disabled>ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
      classroomSelect.disabled = true;
      datePicker.clear(); // ë‚ ì§œ ì´ˆê¸°í™”
      dateInput.disabled = true; // ë‚ ì§œ ì„ íƒ ë¹„í™œì„±í™”
      if (datePicker.altInput) datePicker.altInput.disabled = true;
      periodsDiv.innerHTML = '<small class="text-muted">ê±´ë¬¼, ê°•ì˜ì‹¤, ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì´ í‘œì‹œë©ë‹ˆë‹¤.</small>';
      document.getElementById('periods-error').textContent = '';

      const button = event.relatedTarget;
      const reservationId = button.getAttribute('data-reservation-id');
      document.getElementById('modalReservationId').value = reservationId;

      await populateBuildingSelect();
    });

    // ê±´ë¬¼ ëª©ë¡ì„ ê°€ì ¸ì™€ select íƒœê·¸ì— ì±„ìš°ëŠ” í•¨ìˆ˜
    async function populateBuildingSelect() {
      try {
        const response = await fetch('/api/facilities/buildings', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('ê±´ë¬¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
        const result = await response.json();
        const buildings = result.data;

        buildingSelect.innerHTML = '<option value="" selected disabled>ê±´ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        buildings.forEach(b => {
          buildingSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
        });
      } catch (error) {
        console.error(error);
        buildingSelect.innerHTML = `<option value="">${error.message}</option>`;
      }
    }

    // ê±´ë¬¼ ì„ íƒ ì‹œ, í•´ë‹¹ ê±´ë¬¼ì˜ ê°•ì˜ì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¨ë‹¤.
    buildingSelect.addEventListener('change', async function() {
      const buildingId = this.value;
      classroomSelect.disabled = true;
      classroomSelect.innerHTML = '<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';
      datePicker.clear();
      dateInput.disabled = true;
      if (datePicker.altInput) datePicker.altInput.disabled = true;
      periodsDiv.innerHTML = '<small class="text-muted">ê°•ì˜ì‹¤ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.</small>';

      if (!buildingId) return;

      try {
        const response = await fetch(`/api/facilities/buildings/${buildingId}/classrooms`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
        const result = await response.json();
        const classrooms = result.data;

        classroomSelect.innerHTML = '<option value="" selected disabled>ê°•ì˜ì‹¤ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        classrooms.forEach(c => {
          classroomSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
        classroomSelect.disabled = false;
      } catch (error) {
        console.error(error);
        classroomSelect.innerHTML = `<option value="">${error.message}</option>`;
      }
    });

    // ê°•ì˜ì‹¤ ì„ íƒ ì‹œ ë‚ ì§œ ì„ íƒê¸° í™œì„±í™”
    classroomSelect.addEventListener('change', function() {
        datePicker.clear();
        const isDisabled = !this.value;
        dateInput.disabled = isDisabled;
        if (datePicker.altInput) datePicker.altInput.disabled = isDisabled;
        periodsDiv.innerHTML = '<small class="text-muted">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</small>';
    });

    // ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ëŒ€ë¥¼ ê°€ì ¸ì™€ ì²´í¬ë°•ìŠ¤ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
  async function fetchAvailableTimes() {
       const classroomId = classroomSelect.value;
       const date = dateInput.value;
       const reservationId = document.getElementById('modalReservationId').value;

       if (!classroomId || !date) {
         periodsDiv.innerHTML = '<small class="text-muted">ê°•ì˜ì‹¤ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.</small>';
         return;
       }

       periodsDiv.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';

       const allPeriods = [
         { value: 'PERIOD_1', text: '1êµì‹œ (09:30 ~ 10:45)', endTime: '10:45' },
         { value: 'PERIOD_2', text: '2êµì‹œ (11:00 ~ 12:15)', endTime: '12:15' },
         { value: 'PERIOD_3', text: '3êµì‹œ (13:00 ~ 14:15)', endTime: '14:15' },
         { value: 'PERIOD_4', text: '4êµì‹œ (14:30 ~ 15:45)', endTime: '15:45' },
         { value: 'PERIOD_5', text: '5êµì‹œ (16:00 ~ 17:15)', endTime: '17:15' },
         { value: 'PERIOD_6', text: '6êµì‹œ (17:30 ~ 18:45)', endTime: '18:45' },
         { value: 'PERIOD_7', text: '7êµì‹œ (19:00 ~ 20:15)', endTime: '20:15' },
         { value: 'PERIOD_8', text: '8êµì‹œ (20:30 ~ 21:45)', endTime: '21:45' }
       ];

       try {
         const url = `/api/reservations/classroom/${classroomId}/reserved-periods?date=${date}`;
         const response = await fetch(url, {
           headers: { 'Authorization': `Bearer ${token}` }
         });
         if (!response.ok) throw new Error('ì‹œê°„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

         const result = await response.json();
         const reservedPeriods = new Set(result.data);

         periodsDiv.innerHTML = '';

         const now = new Date();
         const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
         const isToday = (date === todayStr);

         allPeriods.forEach(period => {
           const isReserved = reservedPeriods.has(period.value);
           let isPast = false;

           if (isToday) {
             const periodEndTime = new Date(`${date}T${period.endTime}`);
             if (now > periodEndTime) {
               isPast = true;
             }
           }

           const formCheckDiv = document.createElement('div');
           formCheckDiv.className = 'form-check';

           const checkbox = document.createElement('input');
           checkbox.type = 'checkbox';
           checkbox.className = 'form-check-input';
           checkbox.value = period.value;
           checkbox.id = `period-${period.value}`;
           checkbox.disabled = isReserved || isPast;

           const label = document.createElement('label');
           label.className = 'form-check-label';
           label.htmlFor = `period-${period.value}`;

           let labelText = period.text;
           if (isReserved) {
             labelText += " (ì˜ˆì•½ë¨)";
           } else if (isPast) {
             labelText += " (ì‹œê°„ ì§€ë‚¨)";
           }
           label.textContent = labelText;

           formCheckDiv.appendChild(checkbox);
           formCheckDiv.appendChild(label);
           periodsDiv.appendChild(formCheckDiv);
         });

       } catch (error) {
         console.error(error);
         periodsDiv.innerHTML = `<small class="text-danger">${error.message}</small>`;
       }
     }

    // 'ìš”ì²­ ì œì¶œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    submitBtn.addEventListener('click', async function () {
      const errorDiv = document.getElementById('periods-error');
      const reservationId = document.getElementById('modalReservationId').value;
      const selectedPeriods = Array.from(document.querySelectorAll('#newPeriods input:checked')).map(cb => cb.value);

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!buildingSelect.value || !classroomSelect.value || !dateInput.value || selectedPeriods.length === 0) {
        errorDiv.textContent = 'ê±´ë¬¼, ê°•ì˜ì‹¤, ë‚ ì§œ, ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.';
        return;
      }
      errorDiv.textContent = '';

      const requestData = {
        newClassroomId: classroomSelect.value,
        newReservationDate: dateInput.value,
        newPeriods: selectedPeriods,
        requestMessage: document.getElementById('requestMessage').value
      };

      try {
        const response = await fetch(`/api/reservations/${reservationId}/change-requests`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (response.ok) {
          alert(result.message);
          window.location.reload();
        } else {
          alert(`ì˜¤ë¥˜: ${result.message}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }
</script>

</body>
</html>