<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common :: common-head}">
  <title>예약 이력 보기</title>
</head>
<body>
<!-- 상단 바 -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-4">
  <h2>📝 예약 이력 보기</h2>

  <!-- 예약 목록이 없을 때 보여줄 메시지 (초기에는 숨김) -->
  <div id="no-reservations-message" class="alert alert-info mt-3 d-none" role="alert">
    예약 내역이 없습니다.
  </div>

  <!-- 예약 테이블 컨테이너 -->
  <div id="reservations-container" class="table-responsive mt-3">
    <table class="table table-hover text-center">
      <thead class="table-light">
      <tr>
        <th scope="col">#</th>
        <th scope="col">강의실</th>
        <th scope="col">예약 날짜</th>
        <th scope="col">예약 시간</th>
        <th scope="col">상태</th>
        <th scope="col">동작</th>
      </tr>
      </thead>
      <tbody id="reservation-tbody">
      <!-- 로딩 스피너: 데이터 로딩 중에 표시됩니다. -->
      <tr>
        <td colspan="6" class="p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- 공통 스크립트 -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- 상단 바 자바 스크립트 -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>


<!-- 예약 데이터 로딩 및 취소 처리를 위한 JavaScript -->
<script>
  // 페이지 로드 시 내 예약 목록을 가져오는 함수를 실행합니다.
  document.addEventListener('DOMContentLoaded', fetchMyReservations);

  // API를 호출하여 내 예약 목록을 가져오는 비동기 함수
  async function fetchMyReservations() {
      const token = localStorage.getItem('accessToken');
      const tbody = document.getElementById('reservation-tbody');
      const container = document.getElementById('reservations-container');
      const noDataMessage = document.getElementById('no-reservations-message');

      // 토큰이 없으면 로그인 페이지로 보냅니다.
      if (!token) {
          alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
          window.location.href = '/login';
          return;
      }

      try {
          // /api/reservations/me 엔드포인트에 GET 요청을 보냅니다.
          const response = await fetch('/api/reservations/me', {
              headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || '예약 내역을 불러오는 데 실패했습니다.');
          }

          const result = await response.json();
          const reservations = result.data; // ApiSuccessResponse의 data 필드

          // 예약 데이터가 있는지 확인합니다.
          if (reservations && reservations.length > 0) {
              container.classList.remove('d-none');
              noDataMessage.classList.add('d-none');
              tbody.innerHTML = ''; // 로딩 스피너 제거
              // 각 예약에 대해 테이블 행을 생성하고 추가합니다.
              reservations.forEach((reservation, index) => {
                  tbody.innerHTML += createReservationRow(reservation, index + 1);
              });
          } else {
              // 예약 데이터가 없으면 '내역 없음' 메시지를 표시합니다.
              container.classList.add('d-none');
              noDataMessage.classList.remove('d-none');
          }
      } catch (error) {
          // 에러 발생 시 에러 메시지를 테이블에 표시합니다.
          tbody.innerHTML = `<tr><td colspan="6" class="text-danger p-4">${error.message}</td></tr>`;
      }
  }

  // 예약 데이터로 테이블의 한 행(<tr>)을 생성하는 함수
  function createReservationRow(reservation, count) {
      // Javascript의 Date 객체를 사용하여 날짜와 시간을 원하는 형식으로 포맷팅합니다.
      const startTime = new Date(reservation.startTime);
      const endTime = new Date(reservation.endTime);
      const date = startTime.toLocaleDateString('ko-KR');
      const time = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} ~ ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;

      let stateBadge = '';
      switch (reservation.state) {
          case 'RESERVED':
              stateBadge = '<span class="badge bg-primary">예약됨</span>';
              break;
          case 'COMPLETED':
              stateBadge = '<span class="badge bg-success">사용완료</span>';
              break;
          case 'CANCELED':
              stateBadge = '<span class="badge bg-secondary">취소됨</span>';
              break;
      }

      // '예약됨' 상태일 때만 취소 버튼을 생성합니다.
      let actionButton = '';
      if (reservation.state === 'RESERVED') {
          actionButton = `
              <form class="cancel-form" data-reservation-id="${reservation.id}">
                  <button type="submit" class="btn btn-sm btn-outline-danger">취소</button>
              </form>
          `;
      }

      return `
          <tr>
            <th scope="row">${count}</th>
            <td>${reservation.classroomName}</td>
            <td>${date}</td>
            <td>${time}</td>
            <td>${stateBadge}</td>
            <td>${actionButton}</td>
          </tr>
      `;
  }

  // 이벤트 위임을 사용하여 동적으로 생성된 '취소' 버튼의 submit 이벤트를 처리합니다.
  document.body.addEventListener('submit', function (event) {
      // 이벤트가 발생한 요소가 'cancel-form' 클래스를 가졌는지 확인합니다.
      if (event.target.classList.contains('cancel-form')) {
          event.preventDefault(); // 폼의 기본 동작을 막습니다.

          if (!confirm('정말로 예약을 취소하시겠습니까?')) return;

          const reservationId = event.target.dataset.reservationId;
          const token = localStorage.getItem('accessToken');
          const url = `/api/reservations/${reservationId}/cancel`;

          fetch(url, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(response => {
              if (!response.ok) return response.json().then(err => { throw new Error(err.message || '취소에 실패했습니다.') });
              return response.json();
          })
          .then(data => {
              alert(data.message);
              window.location.reload(); // 성공 시 페이지를 새로고침하여 변경사항을 반영합니다.
          })
          .catch(error => {
              console.error('취소 처리 중 에러 발생:', error);
              alert(error.message);
          });
      }
  });
</script>

</body>
</html>