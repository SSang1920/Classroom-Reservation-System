<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common :: common-head}">
  <title>ì˜ˆì•½ ì´ë ¥ ë³´ê¸°</title>
</head>
<body>
<!-- ìƒë‹¨ ë°” -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-4">
  <h2>ğŸ“ ì˜ˆì•½ ì´ë ¥ ë³´ê¸°</h2>

  <!-- ì˜ˆì•½ ëª©ë¡ì´ ì—†ì„ ë•Œ ë³´ì—¬ì¤„ ë©”ì‹œì§€ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
  <div id="no-reservations-message" class="alert alert-info mt-3 d-none" role="alert">
    ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
  </div>

  <!-- ì˜ˆì•½ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ -->
  <div id="reservations-container" class="table-responsive mt-3">
    <table class="table table-hover text-center">
      <thead class="table-light">
      <tr>
        <th scope="col">#</th>
        <th scope="col">ê°•ì˜ì‹¤</th>
        <th scope="col">ì˜ˆì•½ ë‚ ì§œ</th>
        <th scope="col">ì˜ˆì•½ ì‹œê°„</th>
        <th scope="col">ìƒíƒœ</th>
        <th scope="col">ë™ì‘</th>
      </tr>
      </thead>
      <tbody id="reservation-tbody">
      <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ: ë°ì´í„° ë¡œë”© ì¤‘ì— í‘œì‹œë©ë‹ˆë‹¤. -->
      <tr>
        <td colspan="6" class="p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- ìƒë‹¨ ë°” ìë°” ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>


<!-- ì˜ˆì•½ ë°ì´í„° ë¡œë”© ë° ì·¨ì†Œ ì²˜ë¦¬ë¥¼ ìœ„í•œ JavaScript -->
<script>
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚´ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  document.addEventListener('DOMContentLoaded', fetchMyReservations);

  // APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë‚´ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function fetchMyReservations() {
      const token = localStorage.getItem('accessToken');
      const tbody = document.getElementById('reservation-tbody');
      const container = document.getElementById('reservations-container');
      const noDataMessage = document.getElementById('no-reservations-message');

      // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
      if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
      }

      try {
          // /api/reservations/me ì—”ë“œí¬ì¸íŠ¸ì— GET ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
          const response = await fetch('/api/reservations/me', {
              headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'ì˜ˆì•½ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const result = await response.json();
          const reservations = result.data; // ApiSuccessResponseì˜ data í•„ë“œ

          // ì˜ˆì•½ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
          if (reservations && reservations.length > 0) {
              container.classList.remove('d-none');
              noDataMessage.classList.add('d-none');
              tbody.innerHTML = ''; // ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±°
              // ê° ì˜ˆì•½ì— ëŒ€í•´ í…Œì´ë¸” í–‰ì„ ìƒì„±í•˜ê³  ì¶”ê°€í•©ë‹ˆë‹¤.
              reservations.forEach((reservation, index) => {
                  tbody.innerHTML += createReservationRow(reservation, index + 1);
              });
          } else {
              // ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 'ë‚´ì—­ ì—†ìŒ' ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
              container.classList.add('d-none');
              noDataMessage.classList.remove('d-none');
          }
      } catch (error) {
          // ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í…Œì´ë¸”ì— í‘œì‹œí•©ë‹ˆë‹¤.
          tbody.innerHTML = `<tr><td colspan="6" class="text-danger p-4">${error.message}</td></tr>`;
      }
  }

  // ì˜ˆì•½ ë°ì´í„°ë¡œ í…Œì´ë¸”ì˜ í•œ í–‰(<tr>)ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
  function createReservationRow(reservation, count) {
      // Javascriptì˜ Date ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì§œì™€ ì‹œê°„ì„ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
      const startTime = new Date(reservation.startTime);
      const endTime = new Date(reservation.endTime);
      const date = startTime.toLocaleDateString('ko-KR');
      const time = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} ~ ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;

      let stateBadge = '';
      switch (reservation.state) {
          case 'RESERVED':
              stateBadge = '<span class="badge bg-primary">ì˜ˆì•½ë¨</span>';
              break;
          case 'COMPLETED':
              stateBadge = '<span class="badge bg-success">ì‚¬ìš©ì™„ë£Œ</span>';
              break;
          case 'CANCELED':
              stateBadge = '<span class="badge bg-secondary">ì·¨ì†Œë¨</span>';
              break;
      }

      // 'ì˜ˆì•½ë¨' ìƒíƒœì¼ ë•Œë§Œ ì·¨ì†Œ ë²„íŠ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
      let actionButton = '';
      if (reservation.state === 'RESERVED') {
          actionButton = `
              <form class="cancel-form" data-reservation-id="${reservation.id}">
                  <button type="submit" class="btn btn-sm btn-outline-danger">ì·¨ì†Œ</button>
              </form>
          `;
      }

      return `
          <tr>
            <th scope="row">${count}</th>
            <td>${reservation.classroomName}</td>
            <td>${date}</td>
            <td>${time}</td>
            <td>${stateBadge}</td>
            <td>${actionButton}</td>
          </tr>
      `;
  }

  // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ ìƒì„±ëœ 'ì·¨ì†Œ' ë²„íŠ¼ì˜ submit ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  document.body.addEventListener('submit', function (event) {
      // ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œê°€ 'cancel-form' í´ë˜ìŠ¤ë¥¼ ê°€ì¡ŒëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
      if (event.target.classList.contains('cancel-form')) {
          event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ë™ì‘ì„ ë§‰ìŠµë‹ˆë‹¤.

          if (!confirm('ì •ë§ë¡œ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

          const reservationId = event.target.dataset.reservationId;
          const token = localStorage.getItem('accessToken');
          const url = `/api/reservations/${reservationId}/cancel`;

          fetch(url, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(response => {
              if (!response.ok) return response.json().then(err => { throw new Error(err.message || 'ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.') });
              return response.json();
          })
          .then(data => {
              alert(data.message);
              window.location.reload(); // ì„±ê³µ ì‹œ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•©ë‹ˆë‹¤.
          })
          .catch(error => {
              console.error('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
              alert(error.message);
          });
      }
  });
</script>

</body>
</html>