<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
  <title>강의실 예약하기</title>
</head>
<body>
<!-- 상단 바 -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="card-title text-center mb-4">📅 강의실 예약</h2>

          <!-- 예약 폼 -->
          <form id="reservation-form">
            <!-- 강의실 선택 -->
            <div class="mb-3">
              <label for="classroom-select" class="form-label">강의실 선택</label>
              <select class="form-select" id="classroom-select" required>
                <option value="" selected disabled>강의실을 불러오는 중...</option>
              </select>
            </div>

            <!-- 날짜 선택 -->
            <div class="mb-3">
              <label for="reservation-date" class="form-label">날짜 선택</label>
              <input type="date" class="form-control" id="reservation-date" required>
            </div>

            <!-- 시간 선택 -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="start-time-select" class="form-label">시작 시간</label>
                <select class="form-select" id="start-time-select" required></select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="end-time-select" class="form-label">종료 시간</label>
                <select class="form-select" id="end-time-select" required></select>
              </div>
            </div>

            <!-- 서버 에러 메시지를 표시할 영역 -->
            <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

            <!-- 예약 버튼 -->
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">예약하기</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 공통 스크립트 -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- 상단 바 자바 스크립트 -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script>
  // 페이지 로드 시 강의실 목록을 불러옵니다.
  document.addEventListener('DOMContentLoaded', function() {
      fetchClassrooms();
      setMinDate();
      populateTimeSlots();
  });

  // 폼 제출 이벤트를 처리합니다.
  document.getElementById('reservation-form').addEventListener('submit', handleReservationSubmit);

  // 날짜 선택기의 최소 날짜를 오늘로 설정합니다.
  function setMinDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reservation-date').setAttribute('min', today);
  }

// 시작/종료 시간 드롭다운을 30분 단위로 채우는 함수
   function populateTimeSlots() {
       const startTimeSelect = document.getElementById('start-time-select');
       const endTimeSelect = document.getElementById('end-time-select');
       const openingHour = 9; // 운영 시작 시간 (오전 9시)
       const closingHour = 22; // 운영 종료 시간 (오후 10시)

       startTimeSelect.innerHTML = '<option value="" selected disabled>-- 시간 선택 --</option>';
       endTimeSelect.innerHTML = '<option value="" selected disabled>-- 시간 선택 --</option>';

       const timeSlots = [];
       for (let hour = openingHour; hour <= closingHour; hour++) {
           for (let minute of [0, 30]) {
               if (hour === closingHour && minute > 0) continue; // 22:00까지만 생성
               const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
               timeSlots.push(time);
           }
       }

       // 시작 시간은 마지막 시간(22:00)을 제외하고 채웁니다.
       timeSlots.slice(0, -1).forEach(time => {
           startTimeSelect.add(new Option(time, time));
       });
       // 종료 시간은 첫 시간(09:00)을 제외하고 채웁니다.
       timeSlots.slice(1).forEach(time => {
           endTimeSelect.add(new Option(time, time));
       });
   }

  // 강의실 목록을 API로 가져와 드롭다운에 채우는 함수
  async function fetchClassrooms() {
      const select = document.getElementById('classroom-select');
      try {
          // 강의실 목록 API를 호출합니다.
          const response = await fetch('/api/classrooms');
          if (!response.ok) {
              // 로그인하지 않은 경우 403 오류가 발생할 수 있습니다.
              if (response.status === 403) {
                   throw new Error('강의실 목록을 보려면 로그인이 필요할 수 있습니다.');
              }
              throw new Error('강의실 목록을 불러오는 데 실패했습니다.');
          }

          const result = await response.json();
          select.innerHTML = '<option value="" selected disabled>-- 강의실을 선택하세요 --</option>'; // 초기화
          result.data.forEach(classroom => {
              const option = new Option(`${classroom.name} (수용인원: ${classroom.capacity}명)`, classroom.id);
              select.add(option);
          });
      } catch (error) {
          select.innerHTML = `<option value="" selected disabled>${error.message}</option>`;
          select.disabled = true;
      }
  }

  // 예약 폼 제출을 처리하는 비동기 함수
  async function handleReservationSubmit(event) {
      event.preventDefault(); // 폼의 기본 제출 동작을 막습니다.

      const token = localStorage.getItem('accessToken');
      const errorDiv = document.getElementById('error-message');
      errorDiv.classList.add('d-none'); // 에러 메시지 초기화

      if (!token) {
          alert('예약을 하려면 로그인이 필요합니다.');
          window.location.href = '/login';
          return;
      }

      const classroomId = document.getElementById('classroom-select').value;
      const date = document.getElementById('reservation-date').value;
      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      // 간단한 유효성 검사
      if (!classroomId || !date || !startTime || !endTime) {
          errorDiv.textContent = '모든 필드를 채워주세요.';
          errorDiv.classList.remove('d-none');
          return;
      }

      if (startTime >= endTime) {
          errorDiv.textContent = '종료 시간은 시작 시간보다 늦어야 합니다.';
          errorDiv.classList.remove('d-none');
          return;
      }

      const payload = {
          classroomId: parseInt(classroomId),
          startTime: `${date}T${startTime}:00`,
          endTime: `${date}T${endTime}:00`
      };

      try {
          const response = await fetch('/api/reservations', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(payload)
          });

          const result = await response.json();
          if (!response.ok) {
              throw new Error(result.message || '알 수 없는 오류가 발생했습니다.');
          }

          alert('예약이 성공적으로 완료되었습니다.');
          window.location.href = '/history'; // 예약 완료 후 예약 이력 페이지로 이동
      } catch (error) {
          errorDiv.textContent = error.message;
          errorDiv.classList.remove('d-none');
      }
  }
</script>
</body>
</html>