<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
  <title>강의실 예약하기</title>
  <style>
    .reserved-slot {
      background-color: #f8d7da !important;
      color: #842029 !important;
      font-style: italic;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="card-title text-center mb-4">📅 강의실 예약</h2>

          <form id="reservation-form">
            <div class="mb-3">
              <label for="building-select" class="form-label">1. 건물 선택</label>
              <select class="form-select" id="building-select" required>
                <option value="" selected disabled>건물을 불러오는 중...</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="classroom-select" class="form-label">2. 강의실 선택</label>
              <select class="form-select" id="classroom-select" required disabled>
                <option value="" selected disabled>건물을 먼저 선택하세요</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="reservation-date" class="form-label">3. 날짜 선택</label>
              <input type="text" class="form-control" id="reservation-date" required disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">4. 시간(교시) 선택</label>
              <small class="form-text text-muted d-block mb-2">최대 2개까지 선택 가능합니다.</small>
              <div id="time-periods-container" class="border p-3 rounded" style="max-height: 250px; overflow-y: auto;">
                <p class="text-muted mb-0">날짜를 먼저 선택해주세요.</p>
              </div>
            </div>

            <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">예약하기</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>


<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // HTML 요소 가져오기
    const buildingSelect = document.getElementById('building-select');
    const classroomSelect = document.getElementById('classroom-select');
    const dateInput = document.getElementById('reservation-date');
    const timePeriodsContainer = document.getElementById('time-periods-container');
    const reservationForm = document.getElementById('reservation-form');

    const datePicker = flatpickr(dateInput, {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "Y-m-d (D)",
        locale: "ko",
        minDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            updateAvailableTimes();
        }
    });

    // 이벤트 리스너 연결
    buildingSelect.addEventListener('change', () => fetchClassrooms(buildingSelect.value));
    classroomSelect.addEventListener('change', handleClassroomChange);
    reservationForm.addEventListener('submit', handleReservationSubmit);
    timePeriodsContainer.addEventListener('change', handleCheckboxChange);

    // 초기화 함수 호출
    initializePage();

    // --- 함수 선언부 ---

    // 페이지 초기화 시 UI를 완벽한 초기 상태로 설정
    function initializePage() {
      fetchBuildings();
      // 페이지가 처음 로드될 때 날짜와 시간 UI를 초기 상태로 설정합니다.
      resetUI(['date', 'time']);
    }

    async function fetchBuildings() {
      try {
        const response = await fetch('/api/facilities/buildings');
        if (!response.ok) throw new Error('건물 목록 로딩 실패');
        const result = await response.json();

        buildingSelect.innerHTML = '<option value="" selected disabled>-- 건물을 선택하세요 --</option>';
        result.data.forEach(building => {
          buildingSelect.add(new Option(building.name, building.id));
        });
      } catch (error) {
        buildingSelect.innerHTML = `<option value="">${error.message}</option>`;
        buildingSelect.disabled = true;
      }
    }

    async function fetchClassrooms(buildingId) {
      resetUI(['classroom', 'date', 'time']);
      if (!buildingId) return;

      try {
        const response = await fetch(`/api/facilities/buildings/${buildingId}/classrooms`);
        if (!response.ok) throw new Error('강의실 목록 로딩 실패');
        const result = await response.json();

        if (result.data.length > 0) {
          result.data.forEach(classroom => {
            const nameParts = classroom.name.split('-');
            const displayName = nameParts.length > 1 ? nameParts[1] : classroom.name;
            const displayText = `${displayName} (수용인원: ${classroom.capacity}명)`;
            classroomSelect.add(new Option(displayText, classroom.id));
          });
          classroomSelect.disabled = false;
        } else {
          classroomSelect.innerHTML = '<option value="">사용 가능한 강의실이 없습니다.</option>';
        }
      } catch (error) {
        classroomSelect.innerHTML = `<option value="">${error.message}</option>`;
      }
    }

    //  강의실 변경 시 동작하는 함수
    function handleClassroomChange() {
      // 1. 하위 단계인 시간 선택 영역과 이전에 선택했던 날짜를 초기화합니다.
      resetUI(['time']);
      datePicker.clear();

      const isClassroomSelected = !!classroomSelect.value;

      // 2. 강의실 선택 여부에 따라 날짜 선택기를 활성화/비활성화합니다.
      dateInput.disabled = !isClassroomSelected;
      if (datePicker.altInput) {
          datePicker.altInput.disabled = !isClassroomSelected;
          // 3. placeholder 텍스트를 직접 제어하여 안정성을 높입니다.
          datePicker.altInput.placeholder = isClassroomSelected ? "" : "강의실을 먼저 선택하세요";
      }
    }

    async function updateAvailableTimes() {
      resetUI(['time']);
      const classroomId = classroomSelect.value;
      const selectedDate = dateInput.value;

      if (!classroomId || !selectedDate) return;

      const allPeriods = [
        { value: 'PERIOD_1', text: '1교시 (09:30 ~ 10:45)', endTime: '10:45' },
        { value: 'PERIOD_2', text: '2교시 (11:00 ~ 12:15)', endTime: '12:15' },
        { value: 'PERIOD_3', text: '3교시 (13:00 ~ 14:15)', endTime: '14:15' },
        { value: 'PERIOD_4', text: '4교시 (14:30 ~ 15:45)', endTime: '15:45' },
        { value: 'PERIOD_5', text: '5교시 (16:00 ~ 17:15)', endTime: '17:15' },
        { value: 'PERIOD_6', text: '6교시 (17:30 ~ 18:45)', endTime: '18:45' },
        { value: 'PERIOD_7', text: '7교시 (19:00 ~ 20:15)', endTime: '20:15' },
        { value: 'PERIOD_8', text: '8교시 (20:30 ~ 21:45)', endTime: '21:45' }
      ];

      try {
        timePeriodsContainer.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        const response = await fetch(`/api/reservations/classroom/${classroomId}/reserved-periods?date=${selectedDate}`);
        if (!response.ok) throw new Error('예약 정보 조회 실패');

        const result = await response.json();
        const reservedPeriods = new Set(result.data);

        timePeriodsContainer.innerHTML = '';

        const now = new Date();
        const today = new Date().toISOString().split('T')[0];

        allPeriods.forEach(period => {
          const isReserved = reservedPeriods.has(period.value);
          let isPast = false;

          if (selectedDate === today) {
            const periodEndTime = new Date(`${selectedDate}T${period.endTime}`);
            if (now > periodEndTime) {
              isPast = true;
            }
          }

          const formCheckDiv = document.createElement('div');
          formCheckDiv.className = 'form-check';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'form-check-input';
          checkbox.value = period.value;
          checkbox.id = `period-${period.value}`;
          checkbox.disabled = isReserved || isPast;

          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.htmlFor = `period-${period.value}`;

          let labelText = period.text;
          if (isReserved) {
            labelText += " (예약됨)";
          } else if (isPast) {
            labelText += " (시간 지남)";
          }
          label.textContent = labelText;

          formCheckDiv.appendChild(checkbox);
          formCheckDiv.appendChild(label);
          timePeriodsContainer.appendChild(formCheckDiv);
        });

      } catch (error) {
        console.error("예약 시간 조회 오류:", error);
        timePeriodsContainer.innerHTML = `<p class="text-danger mb-0">예약 가능한 시간을 불러오는 데 실패했습니다.</p>`;
      }
    }

    function handleCheckboxChange(event) {
      if (event.target.type === 'checkbox') {
        const checkedBoxes = document.querySelectorAll('#time-periods-container .form-check-input:checked');
        if (checkedBoxes.length > 2) {
          alert('시간은 최대 2개까지만 선택할 수 있습니다.');
          event.target.checked = false;
        }
      }
    }

    async function handleReservationSubmit(event) {
      event.preventDefault();
      const errorDiv = document.getElementById('error-message');
      errorDiv.classList.add('d-none');

      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('예약을 하려면 로그인이 필요합니다.');
        window.location.href = '/login';
        return;
      }

      const selectedPeriods = Array.from(document.querySelectorAll('#time-periods-container .form-check-input:checked'))
                                   .map(checkbox => checkbox.value);

      if (selectedPeriods.length === 0) {
        errorDiv.textContent = '예약할 시간을 1개 이상 선택해주세요.';
        errorDiv.classList.remove('d-none');
        return;
      }

      const payload = {
        classroomId: parseInt(classroomSelect.value),
        reservationDate: dateInput.value,
        periods: selectedPeriods
      };

      try {
        const response = await fetch('/api/reservations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.message || '알 수 없는 오류가 발생했습니다.');
        }

        alert('예약이 성공적으로 완료되었습니다.');
        window.location.href = '/history';
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
      }
    }

    //  UI 초기화 헬퍼 함수
    function resetUI(levels) {
      if (levels.includes('classroom')) {
        classroomSelect.innerHTML = '<option value="" selected disabled>건물을 먼저 선택하세요</option>';
        classroomSelect.disabled = true;
      }

      if (levels.includes('date')) {
        datePicker.clear();
        dateInput.disabled = true;
        if (datePicker.altInput) {
            datePicker.altInput.disabled = true;
            // placeholder를 직접 제어하여 안정성을 높입니다.
            datePicker.altInput.placeholder = "강의실을 먼저 선택하세요";
        }
      }

      if (levels.includes('time')) {
        timePeriodsContainer.innerHTML = '<p class="text-muted mb-0">날짜를 먼저 선택해주세요.</p>';
      }
    }
  });
</script>
</body>
</html>