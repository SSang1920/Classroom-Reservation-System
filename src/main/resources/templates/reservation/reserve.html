<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
  <title>ê°•ì˜ì‹¤ ì˜ˆì•½í•˜ê¸°</title>
  <style>
    .reserved-slot {
      background-color: #f8d7da !important;
      color: #842029 !important;
      font-style: italic;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="card-title text-center mb-4">ğŸ“… ê°•ì˜ì‹¤ ì˜ˆì•½</h2>

          <form id="reservation-form">
            <div class="mb-3">
              <label for="building-select" class="form-label">1. ê±´ë¬¼ ì„ íƒ</label>
              <select class="form-select" id="building-select" required>
                <option value="" selected disabled>ê±´ë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="classroom-select" class="form-label">2. ê°•ì˜ì‹¤ ì„ íƒ</label>
              <select class="form-select" id="classroom-select" required disabled>
                <option value="" selected disabled>ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="reservation-date" class="form-label">3. ë‚ ì§œ ì„ íƒ</label>
              <input type="text" class="form-control" id="reservation-date" required disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">4. ì‹œê°„(êµì‹œ) ì„ íƒ</label>
              <small class="form-text text-muted d-block mb-2">ìµœëŒ€ 2ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
              <div id="time-periods-container" class="border p-3 rounded" style="max-height: 250px; overflow-y: auto;">
                <p class="text-muted mb-0">ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>
              </div>
            </div>

            <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">ì˜ˆì•½í•˜ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>


<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const buildingSelect = document.getElementById('building-select');
    const classroomSelect = document.getElementById('classroom-select');
    const dateInput = document.getElementById('reservation-date');
    const timePeriodsContainer = document.getElementById('time-periods-container');
    const reservationForm = document.getElementById('reservation-form');

    const datePicker = flatpickr(dateInput, {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "Y-m-d (D)",
        locale: "ko",
        minDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            updateAvailableTimes();
        }
    });

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    buildingSelect.addEventListener('change', () => fetchClassrooms(buildingSelect.value));
    classroomSelect.addEventListener('change', handleClassroomChange);
    reservationForm.addEventListener('submit', handleReservationSubmit);
    timePeriodsContainer.addEventListener('change', handleCheckboxChange);

    // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
    initializePage();

    // --- í•¨ìˆ˜ ì„ ì–¸ë¶€ ---

    // í˜ì´ì§€ ì´ˆê¸°í™” ì‹œ UIë¥¼ ì™„ë²½í•œ ì´ˆê¸° ìƒíƒœë¡œ ì„¤ì •
    function initializePage() {
      fetchBuildings();
      // í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ë‚ ì§œì™€ ì‹œê°„ UIë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
      resetUI(['date', 'time']);
    }

    async function fetchBuildings() {
      try {
        const response = await fetch('/api/facilities/buildings');
        if (!response.ok) throw new Error('ê±´ë¬¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
        const result = await response.json();

        buildingSelect.innerHTML = '<option value="" selected disabled>-- ê±´ë¬¼ì„ ì„ íƒí•˜ì„¸ìš” --</option>';
        result.data.forEach(building => {
          buildingSelect.add(new Option(building.name, building.id));
        });
      } catch (error) {
        buildingSelect.innerHTML = `<option value="">${error.message}</option>`;
        buildingSelect.disabled = true;
      }
    }

    async function fetchClassrooms(buildingId) {
      resetUI(['classroom', 'date', 'time']);
      if (!buildingId) return;

      try {
        const response = await fetch(`/api/facilities/buildings/${buildingId}/classrooms`);
        if (!response.ok) throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
        const result = await response.json();

        if (result.data.length > 0) {
          result.data.forEach(classroom => {
            const nameParts = classroom.name.split('-');
            const displayName = nameParts.length > 1 ? nameParts[1] : classroom.name;
            const displayText = `${displayName} (ìˆ˜ìš©ì¸ì›: ${classroom.capacity}ëª…)`;
            classroomSelect.add(new Option(displayText, classroom.id));
          });
          classroomSelect.disabled = false;
        } else {
          classroomSelect.innerHTML = '<option value="">ì‚¬ìš© ê°€ëŠ¥í•œ ê°•ì˜ì‹¤ì´ ì—†ìŠµë‹ˆë‹¤.</option>';
        }
      } catch (error) {
        classroomSelect.innerHTML = `<option value="">${error.message}</option>`;
      }
    }

    //  ê°•ì˜ì‹¤ ë³€ê²½ ì‹œ ë™ì‘í•˜ëŠ” í•¨ìˆ˜
    function handleClassroomChange() {
      // 1. í•˜ìœ„ ë‹¨ê³„ì¸ ì‹œê°„ ì„ íƒ ì˜ì—­ê³¼ ì´ì „ì— ì„ íƒí–ˆë˜ ë‚ ì§œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
      resetUI(['time']);
      datePicker.clear();

      const isClassroomSelected = !!classroomSelect.value;

      // 2. ê°•ì˜ì‹¤ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ ë‚ ì§œ ì„ íƒê¸°ë¥¼ í™œì„±í™”/ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
      dateInput.disabled = !isClassroomSelected;
      if (datePicker.altInput) {
          datePicker.altInput.disabled = !isClassroomSelected;
          // 3. placeholder í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì œì–´í•˜ì—¬ ì•ˆì •ì„±ì„ ë†’ì…ë‹ˆë‹¤.
          datePicker.altInput.placeholder = isClassroomSelected ? "" : "ê°•ì˜ì‹¤ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”";
      }
    }

    async function updateAvailableTimes() {
      resetUI(['time']);
      const classroomId = classroomSelect.value;
      const selectedDate = dateInput.value;

      if (!classroomId || !selectedDate) return;

      const allPeriods = [
        { value: 'PERIOD_1', text: '1êµì‹œ (09:30 ~ 10:45)', endTime: '10:45' },
        { value: 'PERIOD_2', text: '2êµì‹œ (11:00 ~ 12:15)', endTime: '12:15' },
        { value: 'PERIOD_3', text: '3êµì‹œ (13:00 ~ 14:15)', endTime: '14:15' },
        { value: 'PERIOD_4', text: '4êµì‹œ (14:30 ~ 15:45)', endTime: '15:45' },
        { value: 'PERIOD_5', text: '5êµì‹œ (16:00 ~ 17:15)', endTime: '17:15' },
        { value: 'PERIOD_6', text: '6êµì‹œ (17:30 ~ 18:45)', endTime: '18:45' },
        { value: 'PERIOD_7', text: '7êµì‹œ (19:00 ~ 20:15)', endTime: '20:15' },
        { value: 'PERIOD_8', text: '8êµì‹œ (20:30 ~ 21:45)', endTime: '21:45' }
      ];

      try {
        timePeriodsContainer.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        const response = await fetch(`/api/reservations/classroom/${classroomId}/reserved-periods?date=${selectedDate}`);
        if (!response.ok) throw new Error('ì˜ˆì•½ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');

        const result = await response.json();
        const reservedPeriods = new Set(result.data);

        timePeriodsContainer.innerHTML = '';

        const now = new Date();
        const today = new Date().toISOString().split('T')[0];

        allPeriods.forEach(period => {
          const isReserved = reservedPeriods.has(period.value);
          let isPast = false;

          if (selectedDate === today) {
            const periodEndTime = new Date(`${selectedDate}T${period.endTime}`);
            if (now > periodEndTime) {
              isPast = true;
            }
          }

          const formCheckDiv = document.createElement('div');
          formCheckDiv.className = 'form-check';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'form-check-input';
          checkbox.value = period.value;
          checkbox.id = `period-${period.value}`;
          checkbox.disabled = isReserved || isPast;

          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.htmlFor = `period-${period.value}`;

          let labelText = period.text;
          if (isReserved) {
            labelText += " (ì˜ˆì•½ë¨)";
          } else if (isPast) {
            labelText += " (ì‹œê°„ ì§€ë‚¨)";
          }
          label.textContent = labelText;

          formCheckDiv.appendChild(checkbox);
          formCheckDiv.appendChild(label);
          timePeriodsContainer.appendChild(formCheckDiv);
        });

      } catch (error) {
        console.error("ì˜ˆì•½ ì‹œê°„ ì¡°íšŒ ì˜¤ë¥˜:", error);
        timePeriodsContainer.innerHTML = `<p class="text-danger mb-0">ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
      }
    }

    function handleCheckboxChange(event) {
      if (event.target.type === 'checkbox') {
        const checkedBoxes = document.querySelectorAll('#time-periods-container .form-check-input:checked');
        if (checkedBoxes.length > 2) {
          alert('ì‹œê°„ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          event.target.checked = false;
        }
      }
    }

    async function handleReservationSubmit(event) {
      event.preventDefault();
      const errorDiv = document.getElementById('error-message');
      errorDiv.classList.add('d-none');

      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ì˜ˆì•½ì„ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
        return;
      }

      const selectedPeriods = Array.from(document.querySelectorAll('#time-periods-container .form-check-input:checked'))
                                   .map(checkbox => checkbox.value);

      if (selectedPeriods.length === 0) {
        errorDiv.textContent = 'ì˜ˆì•½í•  ì‹œê°„ì„ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.';
        errorDiv.classList.remove('d-none');
        return;
      }

      const payload = {
        classroomId: parseInt(classroomSelect.value),
        reservationDate: dateInput.value,
        periods: selectedPeriods
      };

      try {
        const response = await fetch('/api/reservations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/history';
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
      }
    }

    //  UI ì´ˆê¸°í™” í—¬í¼ í•¨ìˆ˜
    function resetUI(levels) {
      if (levels.includes('classroom')) {
        classroomSelect.innerHTML = '<option value="" selected disabled>ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
        classroomSelect.disabled = true;
      }

      if (levels.includes('date')) {
        datePicker.clear();
        dateInput.disabled = true;
        if (datePicker.altInput) {
            datePicker.altInput.disabled = true;
            // placeholderë¥¼ ì§ì ‘ ì œì–´í•˜ì—¬ ì•ˆì •ì„±ì„ ë†’ì…ë‹ˆë‹¤.
            datePicker.altInput.placeholder = "ê°•ì˜ì‹¤ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”";
        }
      }

      if (levels.includes('time')) {
        timePeriodsContainer.innerHTML = '<p class="text-muted mb-0">ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
      }
    }
  });
</script>
</body>
</html>