<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
  <title>ê°•ì˜ì‹¤ ì˜ˆì•½í•˜ê¸°</title>
</head>
<body>
<!-- ìƒë‹¨ ë°” -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="card-title text-center mb-4">ğŸ“… ê°•ì˜ì‹¤ ì˜ˆì•½</h2>

          <!-- ì˜ˆì•½ í¼ -->
          <form id="reservation-form">
            <!-- ê°•ì˜ì‹¤ ì„ íƒ -->
            <div class="mb-3">
              <label for="classroom-select" class="form-label">ê°•ì˜ì‹¤ ì„ íƒ</label>
              <select class="form-select" id="classroom-select" required>
                <option value="" selected disabled>ê°•ì˜ì‹¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
              </select>
            </div>

            <!-- ë‚ ì§œ ì„ íƒ -->
            <div class="mb-3">
              <label for="reservation-date" class="form-label">ë‚ ì§œ ì„ íƒ</label>
              <input type="date" class="form-control" id="reservation-date" required>
            </div>

            <!-- ì‹œê°„ ì„ íƒ -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="start-time-select" class="form-label">ì‹œì‘ ì‹œê°„</label>
                <select class="form-select" id="start-time-select" required></select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="end-time-select" class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <select class="form-select" id="end-time-select" required></select>
              </div>
            </div>

            <!-- ì„œë²„ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ì˜ì—­ -->
            <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

            <!-- ì˜ˆì•½ ë²„íŠ¼ -->
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">ì˜ˆì•½í•˜ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- ìƒë‹¨ ë°” ìë°” ìŠ¤í¬ë¦½íŠ¸ -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script>
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ê°•ì˜ì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
  document.addEventListener('DOMContentLoaded', function() {
      fetchClassrooms();
      setMinDate();
      populateTimeSlots();
  });

  // í¼ ì œì¶œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  document.getElementById('reservation-form').addEventListener('submit', handleReservationSubmit);

  // ë‚ ì§œ ì„ íƒê¸°ì˜ ìµœì†Œ ë‚ ì§œë¥¼ ì˜¤ëŠ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
  function setMinDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reservation-date').setAttribute('min', today);
  }

// ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ë“œë¡­ë‹¤ìš´ì„ 30ë¶„ ë‹¨ìœ„ë¡œ ì±„ìš°ëŠ” í•¨ìˆ˜
   function populateTimeSlots() {
       const startTimeSelect = document.getElementById('start-time-select');
       const endTimeSelect = document.getElementById('end-time-select');
       const openingHour = 9; // ìš´ì˜ ì‹œì‘ ì‹œê°„ (ì˜¤ì „ 9ì‹œ)
       const closingHour = 22; // ìš´ì˜ ì¢…ë£Œ ì‹œê°„ (ì˜¤í›„ 10ì‹œ)

       startTimeSelect.innerHTML = '<option value="" selected disabled>-- ì‹œê°„ ì„ íƒ --</option>';
       endTimeSelect.innerHTML = '<option value="" selected disabled>-- ì‹œê°„ ì„ íƒ --</option>';

       const timeSlots = [];
       for (let hour = openingHour; hour <= closingHour; hour++) {
           for (let minute of [0, 30]) {
               if (hour === closingHour && minute > 0) continue; // 22:00ê¹Œì§€ë§Œ ìƒì„±
               const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
               timeSlots.push(time);
           }
       }

       // ì‹œì‘ ì‹œê°„ì€ ë§ˆì§€ë§‰ ì‹œê°„(22:00)ì„ ì œì™¸í•˜ê³  ì±„ì›ë‹ˆë‹¤.
       timeSlots.slice(0, -1).forEach(time => {
           startTimeSelect.add(new Option(time, time));
       });
       // ì¢…ë£Œ ì‹œê°„ì€ ì²« ì‹œê°„(09:00)ì„ ì œì™¸í•˜ê³  ì±„ì›ë‹ˆë‹¤.
       timeSlots.slice(1).forEach(time => {
           endTimeSelect.add(new Option(time, time));
       });
   }

  // ê°•ì˜ì‹¤ ëª©ë¡ì„ APIë¡œ ê°€ì ¸ì™€ ë“œë¡­ë‹¤ìš´ì— ì±„ìš°ëŠ” í•¨ìˆ˜
  async function fetchClassrooms() {
      const select = document.getElementById('classroom-select');
      try {
          // ê°•ì˜ì‹¤ ëª©ë¡ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
          const response = await fetch('/api/classrooms');
          if (!response.ok) {
              // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° 403 ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              if (response.status === 403) {
                   throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              }
              throw new Error('ê°•ì˜ì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const result = await response.json();
          select.innerHTML = '<option value="" selected disabled>-- ê°•ì˜ì‹¤ì„ ì„ íƒí•˜ì„¸ìš” --</option>'; // ì´ˆê¸°í™”
          result.data.forEach(classroom => {
              const option = new Option(`${classroom.name} (ìˆ˜ìš©ì¸ì›: ${classroom.capacity}ëª…)`, classroom.id);
              select.add(option);
          });
      } catch (error) {
          select.innerHTML = `<option value="" selected disabled>${error.message}</option>`;
          select.disabled = true;
      }
  }

  // ì˜ˆì•½ í¼ ì œì¶œì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  async function handleReservationSubmit(event) {
      event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ì œì¶œ ë™ì‘ì„ ë§‰ìŠµë‹ˆë‹¤.

      const token = localStorage.getItem('accessToken');
      const errorDiv = document.getElementById('error-message');
      errorDiv.classList.add('d-none'); // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”

      if (!token) {
          alert('ì˜ˆì•½ì„ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
      }

      const classroomId = document.getElementById('classroom-select').value;
      const date = document.getElementById('reservation-date').value;
      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬
      if (!classroomId || !date || !startTime || !endTime) {
          errorDiv.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.';
          errorDiv.classList.remove('d-none');
          return;
      }

      if (startTime >= endTime) {
          errorDiv.textContent = 'ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.';
          errorDiv.classList.remove('d-none');
          return;
      }

      const payload = {
          classroomId: parseInt(classroomId),
          startTime: `${date}T${startTime}:00`,
          endTime: `${date}T${endTime}:00`
      };

      try {
          const response = await fetch('/api/reservations', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(payload)
          });

          const result = await response.json();
          if (!response.ok) {
              throw new Error(result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = '/history'; // ì˜ˆì•½ ì™„ë£Œ í›„ ì˜ˆì•½ ì´ë ¥ í˜ì´ì§€ë¡œ ì´ë™
      } catch (error) {
          errorDiv.textContent = error.message;
          errorDiv.classList.remove('d-none');
      }
  }
</script>
</body>
</html>