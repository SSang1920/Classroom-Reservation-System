<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>내 정보</title>
    <style>
        .info-group {
            display: flex;
            align-items: center;
            padding: 0.75em 0;
            border-bottom: 1px solid #eee;
        }
        .info-group:last-child {
            border-bottom: none;
        }
        .info-label {
            flex-basis: 120px;
            font-weight: 600;
            color: #555;
        }
        .info-value {
            flex-grow: 1;
            color: #333;
        }
    </style>
</head>
<body class="bg-light">
<!-- 상단 바 -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h2 class="card-title text-center mb-0">내 정보</h2>
                </div>
                <div class="card-body p-4">
                    <!-- 정보 로딩 시 보여줄 스피너 -->
                    <div id="info-loader" class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">정보를 불러오는 중...</p>
                    </div>

                    <div id="info-content" class="d-none">
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-person-badge me-2"></i>아이디</span>
                            <span id="info-loginId" class="info-value"></span>
                        </div>
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-person me-2"></i>이름</span>
                            <span id="info-name" class="info-value"></span>
                        </div>
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-envelope me-2"></i>이메일</span>
                            <span id="info-email" class="info-value"></span>
                        </div>
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-award me-2"></i>역할</span>
                            <span id="info-role" class="info-value"></span>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#updateInfoModal">
                            <i class="bi bi-pencil-square me-2"></i>내 정보 수정
                        </button>
                        <a href="#" class="btn btn-primary">
                            <i class="bi bi-key-fill me-2"></i>비밀번호 변경
                        </a>
                    </div>

                    <!-- 회원 탈퇴 -->
                    <hr class="my-4">
                    <div class="d-grid">
                        <button type="button" class="btn btn-outline-danger" id="delete-account-btn">
                            <i class="bi bi-trash3 me-2"></i>회원 탈퇴
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 정보 수정 모달 -->
<div class="modal fade" id="updateInfoModal" tabindex="-1" aria-labelledby="updateInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateInfoModalLabel">내 정보 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="update-info-form">
                    <div class="mb-3">
                        <label for="modal-name" class="form-label">이름</label>
                        <input type="text" class="form-control" id="modal-name">
                    </div>
                    <div class="mb-3">
                        <label for="modal-email" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="modal-email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="save-changes-btn">변경 내용 저장</button>
            </div>
        </div>
    </div>
</div>


<!-- 공통 스크립트 -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- 상단 바 자바 스크립트 -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchMyInfo();

        const updateModal = document.getElementById('updateInfoModal');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');

        // 모달이 열릴 때, 현재 정보를 입력 필드에 채워넣음
        updateModal.addEventListener('show.bs.modal', function() {
            document.getElementById('modal-name').value = document.getElementById('info-name').textContent;
            document.getElementById('modal-email').value = document.getElementById('info-email').textContent;
        });

        // 변경 내용 저장 버튼 클릭 시 정보 수정 함수 호출
        saveChangesBtn.addEventListener('click', handleUpdateInfo);

        // 회원 탈퇴 버튼 클릭 시 탈퇴 처리 함수 호출
        deleteAccountBtn.addEventListener('click', handleDeleteAccount);
    });

    // 내 정보를 서버에서 가져와 화면에 표시하는 함수
    async function fetchMyInfo() {
        const loader = document.getElementById('info-loader');
        const content = document.getElementById('info-content');

        try {
            const response = await fetchWithAuth('/api/members/me');
            if (!response.ok) {
                throw new Error('정보를 불러오는 데 실패했습니다.');
            }

            const result = await response.json();
            const userInfo = result.data;

            // 역할 한글로 변환
            const roleNames = { 'STUDENT': '학생', 'PROFESSOR': '교수', 'ADMIN': '관리자' };

            // 받아온 정보로 화면 업데이트
            document.getElementById('info-loginId').textContent = userInfo.loginId;
            document.getElementById('info-name').textContent = userInfo.name;
            document.getElementById('info-email').textContent = userInfo.email;
            document.getElementById('info-role').textContent = roleNames[userInfo.role] || userInfo.role;

            // 로더 숨기고 컨텐츠 표시
            loader.classList.add('d-none');
            content.classList.remove('d-none');

        } catch (error) {
            console.error('Error fetching user info:', error);
            loader.innerHTML = `<p class="text-center text-danger">${error.message}</p>`;
        }
    }

    // 정보 수정을 처리하는 함수
    async function handleUpdateInfo() {
        const newName = document.getElementById('modal-name').value;
        const newEmail = document.getElementById('modal-email').value;

        try {
            const response = await fetchWithAuth('/api/members/me', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, email: newEmail })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '정보 수정에 실패했습니다.');
            }

            alert('정보가 성공적으로 수정되었습니다.');

            // 서버로부터 받은 새 토큰 localStorage에 저장
            const newAccessToken = result.data.accessToken;
            const newRefreshToken = result.data.refreshToken;
            localStorage.setItem('accessToken', newAccessToken);
            localStorage.setItem('refreshToken', newRefreshToken);

            // 메인 화면의 정보 업데이트
            if (newName.trim()) {
                document.getElementById('info-name').textContent = newName;
                document.getElementById('username-display').textContent = newName;
            }

            if (newEmail.trim()) {
                document.getElementById('info-email').textContent = newEmail;
            }

            // 모달 닫기
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('updateInfoModal'));
            modalInstance.hide();

        } catch (error) {
            console.error('Error updating user info:', error);
            alert(`오류: ${error.message}`);
        }
    }

    // 회원 탈퇴를 처리하는 함수
    async function handleDeleteAccount() {
        // 사용자에게 재확인 요청
        const confirmation = confirm(
            '정말로 회원 탈퇴를 진행하시겠습니까?\n모든 예약 및 내역이 영구적으로 삭제되며, 이 작업은 되돌릴 수 없습니다.'
        );

        if (!confirmation) {
            return;
        }

        // 탈퇴 API 호출
        try {
            const response = await fetchWithAuth('/api/members/me', {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '회원 탈퇴 중 오류가 발생했습니다.');
            }

            // 성공 시 처리
            alert('회원 탈퇴가 성공적으로 처리되었습니다. 이용해주셔서 감사합니다.');
            logout();

        } catch(error) {
            console.error('Error deleting account:', error);
            alert(`오류: ${error.message}`);
        }
    }


</script>
</body>
</html>