<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: common-resources}"></th:block>
    <title>내 정보</title>
    <style>
        .info-group {
            display: flex;
            align-items: center;
            padding: 0.75em 0;
            border-bottom: 1px solid #eee;
        }
        .info-group:last-child {
            border-bottom: none;
        }
        .info-label {
            flex-basis: 120px;
            font-weight: 600;
            color: #555;
        }
        .info-value {
            flex-grow: 1;
            color: #333;
        }
    </style>
</head>
<body class="bg-light">
<!-- 상단 바 -->
<div th:replace="~{fragments/topbar :: topbar}"></div>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h2 class="card-title text-center mb-0">내 정보</h2>
                </div>
                <div class="card-body p-4">
                    <!-- 정보 로딩 시 보여줄 스피너 -->
                    <div id="info-loader" class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">정보를 불러오는 중...</p>
                    </div>

                    <div id="info-content" class="d-none">
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-person-badge me-2"></i>아이디</span>
                            <span id="info-loginId" class="info-value"></span>
                        </div>
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-person me-2"></i>이름</span>
                            <span id="info-name" class="info-value"></span>
                        </div>
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-envelope me-2"></i>이메일</span>
                            <span id="info-email" class="info-value"></span>
                        </div>
                        <div class="info-group">
                            <span class="info-label"><i class="bi bi-award me-2"></i>역할</span>
                            <span id="info-role" class="info-value"></span>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#updateInfoModal">
                            <i class="bi bi-pencil-square me-2"></i>내 정보 수정
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="bi bi-key-fill me-2"></i>비밀번호 변경
                        </button>
                    </div>

                    <!-- 회원 탈퇴 -->
                    <hr class="my-4">
                    <div class="d-grid">
                        <button type="button" class="btn btn-outline-danger" id="delete-account-btn">
                            <i class="bi bi-trash3 me-2"></i>회원 탈퇴
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 정보 수정 모달 -->
<div class="modal fade" id="updateInfoModal" tabindex="-1" aria-labelledby="updateInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateInfoModalLabel">내 정보 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="update-info-form">
                    <div class="mb-3">
                        <label for="modal-name" class="form-label">이름</label>
                        <input type="text" class="form-control" id="modal-name">
                    </div>
                    <div class="mb-3">
                        <label for="modal-email" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="modal-email">
                        <div id="modal-email-error" class="form-text"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="save-changes-btn">변경 내용 저장</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">비밀번호 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">현재 비밀번호</label>
                        <input type="password" class="form-control" id="currentPassword">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">새 비밀번호</label>
                        <input type="password" class="form-control" id="newPassword">
                        <div id="new-password-error" class="form-text"></div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">새 비밀번호 확인</label>
                        <input type="password" class="form-control" id="confirmPassword">
                        <div id="confirm-password-error" class="form-text"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="save-password-btn">비밀번호 변경</button>
            </div>
        </div>
    </div>
</div>


<!-- 공통 스크립트 -->
<th:block th:replace="~{fragments/common :: common-scripts}"></th:block>

<!-- 상단 바 자바 스크립트 -->
<th:block th:replace="~{fragments/topbar :: topbar-script}"></th:block>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchMyInfo();

        const updateModal = document.getElementById('updateInfoModal');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const savePasswordBtn = document.getElementById('save-password-btn');

        // 모달이 열릴 때, 현재 정보를 입력 필드에 채워넣음
        updateModal.addEventListener('show.bs.modal', function() {
            document.getElementById('modal-name').value = document.getElementById('info-name').textContent;
            document.getElementById('modal-email').value = document.getElementById('info-email').textContent;
        });

        // 정보 수정 모달이 닫힐 때 에러 메시지 초기화
        updateModal.addEventListener('hidden.bs.modal', function() {
            const emailError = document.getElementById('modal-email-error');
            emailError.textContent = '';
            emailError.className = 'form-text';
        });

        // 정보 수정 모달의 이메일 필드 실시간 유효성 검사
        document.getElementById('modal-email').addEventListener('blur', handleEmailInput);

        // 변경 내용 저장 버튼 클릭
        saveChangesBtn.addEventListener('click', handleUpdateInfo);

        // 회원 탈퇴 버튼 클릭
        deleteAccountBtn.addEventListener('click', handleDeleteAccount);

        // 비밀번호 변경 저장 버튼 클릭
        savePasswordBtn.addEventListener('click', handlePasswordChange);

        // 비밀번호 필드에 실시간 유효성 검사
        document.getElementById('newPassword').addEventListener('blur', validateNewPassword);
        document.getElementById('confirmPassword').addEventListener('blur', validateConfirmPassword);

        // 비밀번호 변경 모달이 닫힐 때 입력 필드 초기화
        document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('change-password-form').reset();
            const newPasswordError = document.getElementById('new-password-error');
            const confirmPasswordError = document.getElementById('confirm-password-error');
            newPasswordError.textContent = '';
            newPasswordError.className = 'form-text';
            confirmPasswordError.textContent = '';
            confirmPasswordError.className = 'form-text';
        });
    });

    // 내 정보를 서버에서 가져와 화면에 표시하는 함수
    async function fetchMyInfo() {
        const loader = document.getElementById('info-loader');
        const content = document.getElementById('info-content');

        try {
            const response = await fetchWithAuth('/api/members/me');
            if (!response.ok) {
                throw new Error('정보를 불러오는 데 실패했습니다.');
            }

            const result = await response.json();
            const userInfo = result.data;

            // 역할 한글로 변환
            const roleNames = { 'STUDENT': '학생', 'PROFESSOR': '교수', 'ADMIN': '관리자' };

            // 받아온 정보로 화면 업데이트
            document.getElementById('info-loginId').textContent = userInfo.loginId;
            document.getElementById('info-name').textContent = userInfo.name;
            document.getElementById('info-email').textContent = userInfo.email;
            document.getElementById('info-role').textContent = roleNames[userInfo.role] || userInfo.role;

            // 로더 숨기고 컨텐츠 표시
            loader.classList.add('d-none');
            content.classList.remove('d-none');

        } catch (error) {
            console.error('Error fetching user info:', error);
            loader.innerHTML = `<p class="text-center text-danger">${error.message}</p>`;
        }
    }

    // 이메일 유효성을 실시간으로 검사하는 함수
    function handleEmailInput() {
        const newEmail = document.getElementById('modal-email').value.trim();
        const errorBox = document.getElementById('modal-email-error');
        const originalEmail = document.getElementById('info-email').textContent;

        errorBox.textContent = '';
        errorBox.className = 'form-text';

        if (!newEmail || newEmail === originalEmail) {
            return;
        }

        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(newEmail)) {
            errorBox.textContent = '올바른 이메일 형식이 아닙니다.';
            errorBox.className = 'form-text text-danger';
            return;
        }

        fetch(`/api/members/check-email?email=${encodeURIComponent(newEmail)}`)
            .then(res => res.json().then(data => ({ ok: res.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    errorBox.textContent = data.message || '사용 가능한 이메일입니다.';
                    errorBox.className = 'form-text text-success';
                } else {
                    errorBox.textContent = data.message || '이미 사용 중인 이메일입니다.';
                    errorBox.className = 'form-text text-danger';
                }
            })
            .catch(() => {
                errorBox.textContent = '이메일 확인 중 오류가 발생했습니다.';
                errorBox.className = 'form-text text-danger';
            });
    }

    // 정보 수정을 처리하는 함수
    async function handleUpdateInfo() {
        const newName = document.getElementById('modal-name').value;
        const newEmail = document.getElementById('modal-email').value;
        const emailErrorBox = document.getElementById('modal-email-error');

        if (emailErrorBox.classList.contains('text-danger')) {
            alert('이메일 주소를 다시 확인해주세요.');
            return;
        }

        try {
            const response = await fetchWithAuth('/api/members/me', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, email: newEmail })
            });

            const result = await response.json();

            if (!response.ok) {
                if (result.errorCode === 'DUPLICATE_EMAIL') {
                    emailErrorBox.textContent = result.message;
                    emailErrorBox.className = 'form-text text-danger';
                } else {
                    throw new Error(result.message || '정보 수정에 실패했습니다.');
                }

                return;
            }

            alert('정보가 성공적으로 수정되었습니다.');

            // 서버로부터 받은 새 토큰 localStorage에 저장
            const newAccessToken = result.data.accessToken;
            const newRefreshToken = result.data.refreshToken;
            localStorage.setItem('accessToken', newAccessToken);
            localStorage.setItem('refreshToken', newRefreshToken);

            // 메인 화면의 정보 업데이트
            if (newName.trim()) {
                document.getElementById('info-name').textContent = newName;
                document.getElementById('username-display').textContent = newName;
            }

            if (newEmail.trim()) {
                document.getElementById('info-email').textContent = newEmail;
            }

            // 모달 닫기
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('updateInfoModal'));
            modalInstance.hide();

        } catch (error) {
            console.error('Error updating user info:', error);
            alert(`오류: ${error.message}`);
        }
    }

    // 회원 탈퇴를 처리하는 함수
    async function handleDeleteAccount() {
        // 사용자에게 재확인 요청
        const confirmation = confirm(
            '정말로 회원 탈퇴를 진행하시겠습니까?\n모든 예약 및 내역이 영구적으로 삭제되며, 이 작업은 되돌릴 수 없습니다.'
        );

        if (!confirmation) {
            return;
        }

        // 탈퇴 API 호출
        try {
            const response = await fetchWithAuth('/api/members/me', {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '회원 탈퇴 중 오류가 발생했습니다.');
            }

            // 성공 시 처리
            alert('회원 탈퇴가 성공적으로 처리되었습니다. 이용해주셔서 감사합니다.');
            logout();

        } catch(error) {
            console.error('Error deleting account:', error);
            alert(`오류: ${error.message}`);
        }
    }

    // 비밀번호 변경을 처리하는 함수
    async function handlePasswordChange() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        const isNewPasswordValid = validateNewPassword();
        const isConfirmPasswordValid = validateConfirmPassword();

        if (!currentPassword) {
            alert('현재 비밀번호를 입력해주세요.');
            return;
        }

        if (!isNewPasswordValid || !isConfirmPasswordValid) {
            alert('새 비밀번호를 규칙에 맞게 올바르게 입력해주세요.');
            return;
        }

        try {
            const response = await fetchWithAuth('/api/members/me/password', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '비밀번호 변경에 실패했습니다.');
            }

            alert('비밀번호가 성공적으로 변경되었습니다. 다시 로그인해주세요.');
            logout();

        } catch(error) {
            console.error('Error changing password:', error);
            alert(`오류: ${error.message}`);
        }
    }

    // 새 비밀번호 유효성을 실시간으로 검사하는 함수
    function validateNewPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const errorBox = document.getElementById('new-password-error');
        const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,20}$/;

        if (!newPassword) {
            errorBox.textContent = '';
            errorBox.className = 'form-text';
            return false;
        }

        if (passwordRegex.test(newPassword)) {
            errorBox.textContent = '사용 가능한 비밀번호입니다.';
            errorBox.className = 'form-text text-success';
            validateConfirmPassword();
            return true;

        } else {
            errorBox.textContent = '비밀번호는 8~20자 이내의 영문, 숫자, 특수문자를 모두 포함해야 합니다.';
            errorBox.className = 'form-text text-danger';
            validateConfirmPassword();
            return false;
        }
    }

    // 비밀번호 확인 필드를 실시간으로 검사하는 함수
    function validateConfirmPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorBox = document.getElementById('confirm-password-error');

        if (!confirmPassword) {
            errorBox.textContent = '';
            errorBox.className = 'form-text';
            return false;
        }

        if (newPassword === confirmPassword) {
            errorBox.textContent = '비밀번호가 일치합니다.';
            errorBox.className = 'form-text text-success';
            return true;

        } else {
            errorBox.textContent = '비밀번호가 일치하지 않습니다.';
            errorBox.className = 'form-text text-danger';
            return false;
        }
    }
</script>
</body>
</html>